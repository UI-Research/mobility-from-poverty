---
title: ""
author: ""
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output:
  html_document:
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: !expr here::here("06_neighborhoods", "www", "web_report.css")
    editor_options:
      chunk_output_type: console
---

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

# Poverty Exposure

This metric is the share of people who are poor in a county who live in census tracts with poverty rates over 40%. If a county's overall poverty rate is 20% but people in poverty are spread out evenly across all census tracts, the index would equal 0; if they were heavily concentrated in certain tracts, the index would approach 1.

**Process:**

1. Pull people and poverty rates for Census tracts. 
2. Create the “Other Races and Ethnicities” subgroup. 
3. Count the number of people in poverty who live in Census tracts with poverty > 40% in each county. 
4. Summarize the tract data to the county-level.
5. Divide the number from 2. by the total number of people in poverty in each Census tract. 
6. Split the data into an “All” file and a “Subgroups” file
7. Validation
8. Data quality flags

All numbers come for the Census API. The documentation for the Census API is available [here](https://api.census.gov/data/2018/acs/acs5/profile/variables.html). We pull all of the race/ethnicity counts for 2018 using `library(censusapi)`. **Note:** This will require a [Census API key](https://api.census.gov/data/key_signup.html). Add the key to `census_api_key-template.R` and then delete then delete "template". It is sourced above. 

To do this we have to identify census tracts with poverty rates over 40% in each county, count the number of residents in those tracts who are poor, sum that up and divided it by the total number of poor residents in the county.

```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r setup}
options(scipen = 999)

library(tidyverse)
library(censusapi)
library(urbnthemes)
library(reactable)

set_urbn_defaults(style = "print")

source(here::here("06_neighborhoods", "R", "census_api_key.R"))
source(here::here("06_neighborhoods", "R", "get_vars.R"))

```

## 2018 ACS 5-Year Estimates

### 1. Pull people and poverty rates for Census tracts. 

https://api.census.gov/data/2018/acs/acs5/variables.html

```{r load-tract-data}
vars <- c( # Estimate!!Total!!Income in the past 12 months below poverty level
  "B00001_001E", # UNWEIGHTED SAMPLE COUNT OF THE POPULATION
  #"B01001_001E", # SEX BY AGE
  "B17001_001E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (Total)
  "B17001_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE
  "B17001_002M", 
  "B17001A_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (WHITE ALONE)
  "B17001B_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (BLACK OR AFRICAN AMERICAN ALONE)
  "B17001C_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (AMERICAN INDIAN AND ALASKA NATIVE ALONE)
  "B17001D_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (ASIAN ALONE)
  "B17001E_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (NATIVE HAWAIIAN AND OTHER PACIFIC ISLANDER ALONE)
  "B17001F_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (SOME OTHER RACE ALONE)
  "B17001G_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (TWO OR MORE RACES)
  "B17001H_002E", # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (WHITE ALONE, NOT HISPANIC OR LATINO)
  "B17001I_002E"  # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (HISPANIC OR LATINO)
)

# pull Census tracts for 2018
state_fips <- paste0("state:", unique(urbnmapr::states$state_fips))

tracts <- map_df(state_fips, ~getCensus(name = "acs/acs5",
                                        vars = vars, 
                                        region = "tract:*",
                                        regionin = .x,
                                        vintage = 2018)) %>%
  as_tibble()

# rename the variables
tracts <- tracts %>%
  rename(
    people = B17001_001E,
    poverty = B17001_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE
    poverty_moe = B17001_002M,
    poverty_white = B17001A_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (WHITE ALONE)
    poverty_black = B17001B_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (BLACK OR AFRICAN AMERICAN ALONE)
    poverty_aian = B17001C_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (AMERICAN INDIAN AND ALASKA NATIVE ALONE)
    poverty_asian = B17001D_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (ASIAN ALONE)
    poverty_pacific = B17001E_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (NATIVE HAWAIIAN AND OTHER PACIFIC ISLANDER ALONE)
    poverty_other = B17001F_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (SOME OTHER RACE ALONE)
    poverty_twoplus = B17001G_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (TWO OR MORE RACES)
    poverty_white_nonhispanic = B17001H_002E, # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (WHITE ALONE, NOT HISPANIC OR LATINO)
    poverty_hispanic = B17001I_002E # POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE (HISPANIC OR LATINO)
  )

```

Some tracts don't have any population. We drop those tracts. 

```{r}
tracts <- tracts %>%
  tidylog::filter(people > 0)

```

There was a data collection error in Rio Arriba County, NM ([source](https://www.census.gov/programs-surveys/acs/technical-documentation/errata/125.html)). We drop these observations. 

```{r}
tracts <- tracts %>%
  tidylog::filter(state != "35" | county != "039")

```

Check the number of people. It should be around [314,943,184](https://data.census.gov/cedsci/table?q=B17001&tid=ACSDT5Y2018.B17001&hidePreview=false).

```{r check-total-population}
tracts %>%
  summarize(sum(people))

```

### 2. Create the “Other Races and Ethnicities” subgroup

We need to combine the small groups into a group for other races and ethnicities. The Census Bureau typically only posts cross tabs for up to two variables. This requires race, ethnicity, and poverty status so the resulting groups are not disjoint.  

```{r}
knitr::include_graphics(here::here("06_neighborhoods", "www", "images", "race.png"))

```

Combine the race/ethnicity groups into the group of interest. 

```{r}
tracts <- tracts %>%
  select(-poverty_white) %>%  
  mutate(
    poverty_other_races = 
      poverty_aian +
      poverty_asian +
      poverty_pacific + 
      poverty_other +
      poverty_twoplus
  ) %>%
  select(-poverty_aian, -poverty_asian, -poverty_pacific, -poverty_other, -poverty_twoplus)

```

```{r}
tracts %>%
  mutate(poverty_summed = poverty_black + poverty_hispanic + poverty_other_races + poverty_white_nonhispanic) %>%
  ggplot(aes(poverty, poverty_summed)) +
  geom_point(alpha = 0.2, size = 1) +
  coord_equal() +
  scatter_grid()

```

### 3. Count the number of people in poverty who live in Census tracts with poverty > 40% in each county. 

We turn the count of people in poverty into a rate. 

```{r}
tracts <- tracts %>%
  mutate(poverty_rate = poverty / people)

stopifnot(min(tracts$poverty_rate) >= 0)
stopifnot(max(tracts$poverty_rate) <= 1)

```

We calculate the rate of poverty in high-poverty tracts.

```{r count-high-poverty}
tracts <- tracts %>%
  mutate(
    high_poverty = if_else(poverty_rate > 0.4, poverty, 0),
    high_poverty_black = if_else(poverty_rate > 0.4, poverty_black, 0),
    high_poverty_hispanic = if_else(poverty_rate > 0.4, poverty_hispanic, 0),
    high_poverty_other_races = if_else(poverty_rate > 0.4, poverty_other_races, 0),
    high_poverty_white_nonhispanic = if_else(poverty_rate > 0.4, poverty_white_nonhispanic, 0)
  )

```

### 4. Summarize the tract data to the county-level

We calculate the overall poverty and the number of people without a poverty estimate and then sum to the county level. 

```{r}
counties_summary <- tracts %>%
  group_by(state, county) %>%
  summarize(people = sum(people), 
            poverty = sum(poverty), 
            poverty_black = sum(poverty_black),
            poverty_hispanic = sum(poverty_hispanic),
            poverty_other_races = sum(poverty_other_races),
            poverty_white_nonhispanic = sum(poverty_white_nonhispanic),
            high_poverty = sum(high_poverty),
            high_poverty_black = sum(high_poverty_black),
            high_poverty_hispanic = sum(high_poverty_hispanic),
            high_poverty_other_races = sum(high_poverty_other_races),
            high_poverty_white_nonhispanic = sum(high_poverty_white_nonhispanic),
            tracts = n()) %>%
  ungroup()

counties_summary <- counties_summary %>%
  mutate(poverty_rate = poverty / people)

```


We pull int he county-level data and compare it to the calculated county-level data. The poverty rates should be identical; however, they may differ from numbers published elsewhere (like [here](https://www.census.gov/quickfacts/autaugacountyalabama)) that use Small-Area Income and Poverty Estimates (SAIPE). 

```{r}
counties_test <- map_df(state_fips, ~getCensus(name = "acs/acs5",
                                               vars = vars, 
                                               region = "county:*",
                                               regionin = .x,
                                               vintage = 2018)) %>%
  as_tibble()

counties_test <- counties_test %>%
  mutate(poverty_rate_test = B17001_002E / B17001_001E) %>%
  select(state, county, poverty_rate_test) %>%
  arrange(state, county)

stopifnot(
  counties_summary %>%
    select(state, county, poverty_rate) %>%
    left_join(counties_test, by = c("state", "county")) %>%
    filter(poverty_rate != poverty_rate_test) %>%
    nrow() == 0
)

rm(counties_test)

```

### 5. Divide high poverty by total poverty

We need the conditional logic to deal with division by zero. If there is no poverty then poverty exposure is zero. 

```{r calculate-poverty-exposure}
counties_summary <- counties_summary %>%
  mutate(
    poverty_exposure = high_poverty / poverty,
    poverty_exposure_black = 
      if_else(condition = poverty_black > 0, 
              true = high_poverty_black / poverty_black, 
              false = 0),
    poverty_exposure_hispanic = 
      if_else(condition = poverty_hispanic > 0, 
              true = high_poverty_hispanic / poverty_hispanic, 
              false = 0),
    poverty_exposure_other_races = 
      if_else(condition = poverty_other_races > 0, 
              true = high_poverty_other_races / poverty_other_races, 
              false = 0),
    poverty_exposure_white_nonhispanic = 
      if_else(condition = poverty_white_nonhispanic > 0, 
              true = high_poverty_white_nonhispanic / poverty_white_nonhispanic,  
              false = 0),
  ) 

stopifnot(
  all(map_dbl(counties_summary, ~sum(is.na(.x))) == 0)
)

```

Let's look at the highest values. 

```{r}
counties_summary %>%
  arrange(desc(poverty_exposure)) %>%
  select(state, county, poverty_exposure)

```

There shouldn't be any missing values. 

```{r}
stopifnot(
  counties_summary %>%
    filter(is.na(poverty_exposure)) %>%
    nrow() == 0
)

```

### 6. Split the data into an “All” file and a “Subgroups” file

```{r}
# create a long version of the subgroup data
counties_summary_subgroups <- counties_summary %>%
  select(state, county, contains("exposure")) %>%
  pivot_longer(c(-state, -county), names_to = "subgroup", values_to = "poverty_exposure") %>%
  mutate(subgroup = 
           recode(
             subgroup,
             poverty_exposure = "All",
             poverty_exposure_black = "Black, Non-Hispanic",
             poverty_exposure_hispanic = "Hispanic",
             poverty_exposure_other_races = "Other Races and Ethnicities", 
             poverty_exposure_white_nonhispanic = "White, Non-Hispanic"
           )
  )

# check the bounds of the poverty exposure metric
stopifnot(min(counties_summary_subgroups$poverty_exposure) >= 0)
stopifnot(max(counties_summary_subgroups$poverty_exposure) <= 1)

```

### 6. Validation

#### "All" file

The table shows the calculated metrics. Click on the variable columns to sort the table. 

```{r table, echo = FALSE}
counties_summary %>%
  mutate(FIPS = paste0(state, county)) %>%
  select(
    FIPS,
    tracts,
    poverty_rate,
    poverty_exposure
  ) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  reactable(
    filterable = TRUE,
    searchable = TRUE,
    defaultPageSize = 10,
    highlight = TRUE
  )

```

```{r validation-plots}
counties_summary %>%
  ggplot(aes(poverty_exposure)) +
  geom_histogram() +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  labs(title = "Most Counties in 2018 Have No Poverty Exposure",
       subtitle = "The Distribution of Poverty Exposure")

counties_summary %>%
  ggplot(aes(tracts, poverty_exposure)) +
  geom_point(alpha = 0.2,
             size = 1) +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  scatter_grid() +
  labs(title = "Most Extreme Poverty Exposure Values are for Small Counties",
       x = "Number of Tracts in County")

counties_summary %>%
  ggplot(aes(people, poverty_exposure)) +
  geom_point(alpha = 0.2,
             size = 1) +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  scatter_grid() +
  labs(title = "Most Extreme Poverty Exposure Values are for Small Counties",
       x = "Population in County")

counties_summary %>%
  ggplot(aes(poverty_rate, poverty_exposure)) +
  geom_point(alpha = 0.2,
             size = 1) +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  scatter_grid() +
  labs(title = "County Poverty Rate and County Poverty Exposure Are Related")

```

#### Subgroups File

```{r validation-plots-subgroups}
counties_summary_subgroups %>%
  filter(subgroup != "All") %>%
  ggplot(aes(poverty_exposure)) +
  geom_histogram() +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  facet_wrap(~subgroup) +
  labs(title = "Most Counties in 2018 Have No Poverty Exposure",
       subtitle = "The Distribution of Poverty Exposure")

counties_summary_subgroups_plots <- left_join(counties_summary_subgroups, select(counties_summary, -poverty_exposure), by = c("state", "county"))

counties_summary_subgroups_plots %>%
  filter(subgroup!= "All") %>%
  ggplot(aes(tracts, poverty_exposure)) +
  geom_point(alpha = 0.2,
             size = 1) +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  facet_wrap(~subgroup, nrow = 2) +
  scatter_grid() +
  labs(title = "Most Extreme Poverty Exposure Values are for Small Counties",
       x = "Number of Tracts in County")

counties_summary_subgroups_plots %>%
  filter(subgroup!= "All") %>%
  ggplot(aes(people, poverty_exposure)) +
  geom_point(alpha = 0.2,
             size = 1) +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  facet_wrap(~subgroup) +
  scatter_grid() +
  labs(title = "Most Extreme Poverty Exposure Values are for Small Counties",
       x = "Population in County")

counties_summary_subgroups_plots %>%
  filter(subgroup!= "All") %>%
  ggplot(aes(poverty_rate, poverty_exposure)) +
  geom_point(alpha = 0.2,
             size = 1) +
  scale_y_continuous(limits = c(0, NA),
                     expand = expansion(mult = c(0, 0.2))) +
  facet_wrap(~subgroup) +
  scatter_grid() +
  labs(title = "County Poverty Rate and County Poverty Exposure Are Related")

rm(counties_summary_subgroups_plots)

```

### 7. Quality Flags

### 8. Save the data

#### All File

We need to include all counties in the published data even if we don't have a metric for the county. We load the county file and join our metrics to the county file. 

```{r save-data}
# load the 2018 county file
all_counties <- read_csv(here::here("geographic-crosswalks", "data", "county-file.csv")) %>%
  filter(year == 2018)

final_data <- left_join(all_counties, counties_summary, by = c("state", "county")) %>%
  select(year,
         state,
         county,
         poverty_exposure)

write_csv(final_data,
          here::here("06_neighborhoods", "poverty-exposure", "poverty-exposure.csv"))

```

#### Subgroup File

```{r}
counties_summary_subgroups <- counties_summary_subgroups %>%
  mutate(subgroup_type = if_else(subgroup == "All", "all", "race-ethnicity"))

final_data_race_ethnicity <- left_join(all_counties, counties_summary_subgroups, by = c("state", "county")) %>%
  select(year,
         state,
         county,
         subgroup_type,
         subgroup,
         poverty_exposure)

write_csv(final_data_race_ethnicity,
          here::here("06_neighborhoods", "poverty-exposure", "poverty-exposure_race-ethnicity.csv"))

```
