<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vincent Pancini">
<meta name="dcterms.date" content="2024-03-12">

<title>Agencies - Place</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="01_agency_geo_place_files/libs/clipboard/clipboard.min.js"></script>
<script src="01_agency_geo_place_files/libs/quarto-html/quarto.js"></script>
<script src="01_agency_geo_place_files/libs/quarto-html/popper.min.js"></script>
<script src="01_agency_geo_place_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="01_agency_geo_place_files/libs/quarto-html/anchor.min.js"></script>
<link href="01_agency_geo_place_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="01_agency_geo_place_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="01_agency_geo_place_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="01_agency_geo_place_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="01_agency_geo_place_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Agencies - Place</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vincent Pancini </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>
<p><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylog)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(urbnthemes)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set_urbn_defaults</span>(<span class="at">style =</span> <span class="st">"print"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This file is a prerequisite file to the following files:</p>
<ul>
<li><code>reported-crime-place-all.Rmd</code> which creates the place-level metric for reported property crimes per 100,000 people and reported violent crimes per 100,000 people</li>
<li><code>juvenile-arrests-place-all.Rmd</code> which creates the place-level metric for juvenile arrests per 100,000 juveniles</li>
</ul>
<p>You must run this file before either of the above files to create either metric at the place-level.</p>
<p>This file pulls in a universe of law enforcement agencies that have reported criminal activity and arrests in 2022. It then joins on place FIPS codes to those agencies. Next, it pulls in population and demographic information from the American Community Survey (ACS). Lastly, it creates several files that are used in the creation of each metric.</p>
<p>The rest of this file is organized as follows:</p>
<ol type="1">
<li>Background and NIBRS Batch Header File download</li>
<li>Load and clean NIBRS Batch Header File</li>
<li>Join place FIPS codes onto agency data</li>
<li>Construct place-level population and demographics using ACS</li>
<li>Create and write out final files</li>
</ol>
<p>All data used in this file and to create the two safety metrics are available on Box <a href="https://urbanorg.box.com/s/poqnegsa6i74phcdr1eap7tacpe4x1gf">here</a>. Data stored on Box are only available to Urban Institute researchers.</p>
<p>This file assumes that you have cloned the GitHub repository for this project to your local computer. You can find the project repository <a href="https://github.com/UI-Research/mobility-from-poverty">here</a> and learn how to clone a repository <a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository">here</a>.</p>
<section id="background-and-nibrs-batch-header-file-download" class="level2">
<h2 class="anchored" data-anchor-id="background-and-nibrs-batch-header-file-download">1. Background and NIBRS Batch Header File download</h2>
<p>This program and the safety metrics rely on National Incident-based Reporting System (NIBRS) data. NIBRS is an annual data collection that compiles information on criminal incidents and arrests reported by participating law enforcement agencies. It is a part of the Uniform Crime Reporting Program (UCR) which is administered by the Federal Bureau of Investigation (FBI).</p>
<p>NIBRS data as constructed and formatted by the FBI are stored in a single file. These data are organized by various segment levels (record types). Working with the NIBRS data in its single-file format is difficult. To facilitate use of NIBRS data, ICPSR created extract files. These files are available for download from the National Archive of Criminal Justice Data (NACJD), the criminal justice archive within ICPSR, and can be accessed here <a href="https://www.icpsr.umich.edu/web/NACJD/series/128">here</a>.</p>
<p>The segment of NIBRS data this file is concerned with is called the Batch Header File (also called the Batch Header Segment). Prior to the 2013 data, the Batch Header information was released as three segments. Due to the NIBRS data rapidly growing in size, the FBI released a single file instead. The Batch Header File identifies individual police agencies by originating agency identifier (ORI). An individual police agency (ORI) will appear in the batch header segment once. It also includes variables for each county served by each agency, which is what we are particularly interested in. The data used for both safety metrics (arrests and crimes) are reported at the agency-level. The purpose of using the Batch Header File is to be able to link the agencies to places (via counties) for those metrics.</p>
<p>To learn more about NIBRS data, consult Jacob Kaplan’s book titled <a href="https://nibrsbook.com/">National Incident-Based Reporting System (NIBRS) Data: A Practitioner’s Guide</a>. For these metrics, the most important thing to know about these data is that most police agencies do not report NIBRS data prior to 2021. In 2019, only 8,500 out of approximately 18,000 police agencies in the United States (covering about 45% of the US population) reported NIBRS data. Instead, agencies primarily reported <a href="https://ucrbook.com/">UCR data</a> for 2020 and before. However, the FBI has moved entirely to NIBRS data starting in 2021 and no longer collects UCR data, which is why we use NIBRS data instead (<a href="https://nibrsbook.com/overview-of-the-data.html">source</a>).</p>
<p>We do not want to use NIBRS data for some years and UCR data for others. However, because of lack of reporting, <strong>there are a lot of missing values prior to 2021 for NIBRS data</strong>. Future updates of the safety metrics may want to include historical NIBRS data back to 2016 and should keep this in mind.</p>
<p>Note that we only use the 2022 Batch Header File. Using the Batch Header File from each year might be more accurate, but for the most part it won’t matter, especially because so few agencies reported through NIBRS prior to 2021. Additionally, downloading and reading in the Batch Header File for each year takes a lot of time and computing power, and must be done manually for each year which introduces room for error in replication. Future updates may consider using the Batch Header Files for each year, which can be accessed through the following links:</p>
<ul>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/37066">2016</a></li>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/37650">2017</a></li>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/37649">2018</a></li>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/38565">2019</a></li>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/38566">2020</a></li>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/38807">2021</a></li>
<li><a href="https://www.icpsr.umich.edu/web/ICPSR/studies/38925">2022</a></li>
</ul>
<p>Accessing these data requires an ICPSR account. Manually downloading these data is a five-step process, but you will only need to do each of these steps once for the creation of this metric:</p>
<ol type="1">
<li>Create an ICPSR account <a href="https://www.icpsr.umich.edu/cgi-bin/newacct">here</a>.</li>
<li>Navigate to the National Archive of Criminal Justice Data (NACJD) landing page for the year you are accessing (e.g., 2022 is <a href="https://www.icpsr.umich.edu/web/NACJD/studies/38925">here</a>).</li>
<li>Select <code>Download</code>
<ul>
<li>Select <code>Delimited</code></li>
<li>Select <code>Agree</code> on the <code>Terms of Use</code></li>
</ul></li>
<li>Sign into your ICPSR account</li>
<li>This will download a zip file titled <code>ICPSR_38925-V2</code>. Unzip the file and navigate to <code>ICPSR_38925\DS0001\38925-0001-Data.tsv</code>. This is the <code>Batch Header File</code>. Move this file to the <code>mobility-from-poverty\07_safety\data</code> directory after you have cloned the repository for this project from GitHub.</li>
</ol>
</section>
<section id="load-and-clean-nibrs-batch-header-file" class="level2">
<h2 class="anchored" data-anchor-id="load-and-clean-nibrs-batch-header-file">2. Load and clean NIBRS Batch Header File</h2>
<p>This section reads in and cleans the reporting agency data contained in the Batch Header File.</p>
<section id="get-universe-of-agencies-from-2022-nibrs-batch-header-file" class="level3">
<h3 class="anchored" data-anchor-id="get-universe-of-agencies-from-2022-nibrs-batch-header-file">2.1 Get universe of agencies from 2022 NIBRS Batch Header File</h3>
<p>Load 2022 Batch Header File</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the Batch Header File</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"07_safety"</span>, <span class="st">"data"</span>, <span class="st">"38925-0001-Data.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Limit file to necessary variables and rename. We use the codebook (<code>ICPSR_38925\DS0001\38925-0001-Codebook-ICPSR</code>) to determine what each variable represents.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="ot">&lt;-</span> batch_header_file <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">ori =</span> BH003, <span class="co"># ori is unique agency identifier used across multiple files</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">agency_type =</span> BH012,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_num_nibrs =</span> BH002,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_abb =</span> BH008,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">city =</span> BH007,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">core_city =</span> BH013,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips_county_1 =</span> BH054,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips_county_2 =</span> BH055,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips_county_3 =</span> BH056,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fips_county_4 =</span> BH057,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fips_county_5 = BH058, # Exists in the data but all values are missing according to codebook</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">city =</span> <span class="fu">str_to_title</span>(city),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Edit NIBRS state and county variables to have two digits and three digits respectively</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_num_nibrs =</span> <span class="fu">str_pad</span>(state_num_nibrs, <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">county =</span> <span class="fu">str_pad</span>(fips_county_1, <span class="dv">3</span>, <span class="at">pad =</span> <span class="st">"0"</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop US territories</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>state_abb <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"GM"</span>, <span class="st">"PR"</span>, <span class="st">"VI"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If an agency is only linked to one county, the other county variables have a value of <code>-6</code> for <code>Not Applicable</code>. We replace these values with <code>NA</code>. Note that in Batch Header Files prior to 2022, these observations simply have a value of <code>NA</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="ot">&lt;-</span> batch_header_file <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(fips_county_2, fips_county_3, fips_county_4), </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"-6"</span>, <span class="cn">NA</span>, .)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="convert-nibrs-state-codes-to-state-fips-codes" class="level3">
<h3 class="anchored" data-anchor-id="convert-nibrs-state-codes-to-state-fips-codes">2.2 Convert NIBRS state codes to state FIPS codes</h3>
<p>The state identifiers that NIBRS has are state abbreviation and a state code. NIBRS state codes are in alphabetical order and do not follow FIPS codes. We manually create a crosswalk between state FIPS codes and NIBRS codes by looking at the codebook (<code>ICPSR_38566\DS0001\38566-0001-Codebook</code>) and then join state FIPS codes onto the Batch Header File.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create "crosswalk" for NIBRS state codes to state FIPS codes.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>nibrs_states <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>state, <span class="sc">~</span>state_abb, <span class="sc">~</span>state_num_nibrs, <span class="sc">~</span>state_name,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"01"</span>, <span class="st">"AL"</span>, <span class="st">"01"</span>, <span class="st">"Alabama"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"02"</span>, <span class="st">"AK"</span>, <span class="st">"50"</span>, <span class="st">"Alaska"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"04"</span>, <span class="st">"AZ"</span>, <span class="st">"02"</span>, <span class="st">"Arizona"</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"05"</span>, <span class="st">"AR"</span>, <span class="st">"03"</span>, <span class="st">"Arkansas"</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"06"</span>, <span class="st">"CA"</span>, <span class="st">"04"</span>, <span class="st">"California"</span>,   </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"08"</span>, <span class="st">"CO"</span>, <span class="st">"05"</span>, <span class="st">"Colorado"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"09"</span>, <span class="st">"CT"</span>, <span class="st">"06"</span>, <span class="st">"Connecticut"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"10"</span>, <span class="st">"DE"</span>, <span class="st">"07"</span>, <span class="st">"Delaware"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"11"</span>, <span class="st">"DC"</span>, <span class="st">"08"</span>, <span class="st">"District of Columbia"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"12"</span>, <span class="st">"FL"</span>, <span class="st">"09"</span>, <span class="st">"Florida"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"13"</span>, <span class="st">"GA"</span>, <span class="st">"10"</span>, <span class="st">"Georgia"</span>,  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"15"</span>, <span class="st">"HI"</span>, <span class="st">"51"</span>, <span class="st">"Hawaii"</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"16"</span>, <span class="st">"ID"</span>, <span class="st">"11"</span>, <span class="st">"Idaho"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"17"</span>, <span class="st">"IL"</span>, <span class="st">"12"</span>, <span class="st">"Illinois"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"18"</span>, <span class="st">"IN"</span>, <span class="st">"13"</span>, <span class="st">"Indiana"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"19"</span>, <span class="st">"IA"</span>, <span class="st">"14"</span>, <span class="st">"Iowa"</span>, </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"20"</span>, <span class="st">"KS"</span>, <span class="st">"15"</span>, <span class="st">"Kansas"</span>,   </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"21"</span>, <span class="st">"KY"</span>, <span class="st">"16"</span>, <span class="st">"Kentucky"</span>, </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"22"</span>, <span class="st">"LA"</span>, <span class="st">"17"</span>, <span class="st">"Louisiana"</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"23"</span>, <span class="st">"ME"</span>, <span class="st">"18"</span>, <span class="st">"Maine"</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"24"</span>, <span class="st">"MD"</span>, <span class="st">"19"</span>, <span class="st">"Maryland"</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"25"</span>, <span class="st">"MA"</span>, <span class="st">"20"</span>, <span class="st">"Massachusetts"</span>,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"26"</span>, <span class="st">"MI"</span>, <span class="st">"21"</span>, <span class="st">"Michigan"</span>, </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"27"</span>, <span class="st">"MN"</span>, <span class="st">"22"</span>, <span class="st">"Minnesota"</span>,    </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"28"</span>, <span class="st">"MS"</span>, <span class="st">"23"</span>, <span class="st">"Mississippi"</span>,  </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"29"</span>, <span class="st">"MO"</span>, <span class="st">"24"</span>, <span class="st">"Missouri"</span>, </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"30"</span>, <span class="st">"MT"</span>, <span class="st">"25"</span>, <span class="st">"Montana"</span>,  </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"31"</span>, <span class="st">"NE"</span>, <span class="st">"26"</span>, <span class="st">"Nebraska"</span>, </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"32"</span>, <span class="st">"NV"</span>, <span class="st">"27"</span>, <span class="st">"Nevada"</span>,   </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"33"</span>, <span class="st">"NH"</span>, <span class="st">"28"</span>, <span class="st">"New Hampshire"</span>,    </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"34"</span>, <span class="st">"NJ"</span>, <span class="st">"29"</span>, <span class="st">"New Jersey"</span>,   </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"35"</span>, <span class="st">"NM"</span>, <span class="st">"30"</span>, <span class="st">"New Mexico"</span>,   </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"36"</span>, <span class="st">"NY"</span>, <span class="st">"31"</span>, <span class="st">"New York"</span>, </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"37"</span>, <span class="st">"NC"</span>, <span class="st">"32"</span>, <span class="st">"North Carolina"</span>,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"38"</span>, <span class="st">"ND"</span>, <span class="st">"33"</span>, <span class="st">"North Dakota"</span>, </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"39"</span>, <span class="st">"OH"</span>, <span class="st">"34"</span>, <span class="st">"Ohio"</span>, </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"40"</span>, <span class="st">"OK"</span>, <span class="st">"35"</span>, <span class="st">"Oklahoma"</span>, </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"41"</span>, <span class="st">"OR"</span>, <span class="st">"36"</span>, <span class="st">"Oregon"</span>,   </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"42"</span>, <span class="st">"PA"</span>, <span class="st">"37"</span>, <span class="st">"Pennsylvania"</span>, </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"44"</span>, <span class="st">"RI"</span>, <span class="st">"38"</span>, <span class="st">"Rhode Island"</span>, </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"45"</span>, <span class="st">"SC"</span>, <span class="st">"39"</span>, <span class="st">"South Carolina"</span>,   </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"46"</span>, <span class="st">"SD"</span>, <span class="st">"40"</span>, <span class="st">"South Dakota"</span>,</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"47"</span>, <span class="st">"TN"</span>, <span class="st">"41"</span>, <span class="st">"Tennessee"</span>,</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"48"</span>, <span class="st">"TX"</span>, <span class="st">"42"</span>, <span class="st">"Texas"</span>,    </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"49"</span>, <span class="st">"UT"</span>, <span class="st">"43"</span>, <span class="st">"Utah"</span>, </span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"50"</span>, <span class="st">"VT"</span>, <span class="st">"44"</span>, <span class="st">"Vermont"</span>,  </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"51"</span>, <span class="st">"VA"</span>, <span class="st">"45"</span>, <span class="st">"Virginia"</span>, </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"53"</span>, <span class="st">"WA"</span>, <span class="st">"46"</span>, <span class="st">"Washington"</span>,   </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"54"</span>, <span class="st">"WV"</span>, <span class="st">"47"</span>, <span class="st">"West Virginia"</span>,    </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"55"</span>, <span class="st">"WI"</span>, <span class="st">"48"</span>, <span class="st">"Wisconsin"</span>,    </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"56"</span>, <span class="st">"WY"</span>, <span class="st">"49"</span>, <span class="st">"Wyoming"</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="co"># The NIBRS data abbreviates Nebraska as "NB" instead of its correct abbreviation "NE"</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="ot">&lt;-</span> batch_header_file <span class="sc">|&gt;</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state_abb =</span> <span class="fu">if_else</span>(state_abb<span class="sc">==</span><span class="st">"NB"</span>, <span class="st">"NE"</span>, state_abb))</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Join state FIPS codes and full state name onto the NIBRS data</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="ot">&lt;-</span> batch_header_file <span class="sc">|&gt;</span> </span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> nibrs_states, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state_abb"</span>, <span class="st">"state_num_nibrs"</span>)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are 51 unique combinations of <code>state</code>/<code>state_name</code>/<code>state_abb</code>/<code>state_num_nibrs</code>, so the manual crosswalk does not seem to have any errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that crosswalk worked without errors</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  batch_header_file <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(state, state_name, state_abb, state_num_nibrs) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    summarize <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>() <span class="sc">==</span> <span class="dv">51</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove obsolete objects</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(nibrs_states)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exclude-state-police-and-other-state-agencies" class="level3">
<h3 class="anchored" data-anchor-id="exclude-state-police-and-other-state-agencies">2.3 Exclude state police and other state agencies</h3>
<p>Check distribution of agency types. The agency types are as follows:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Value</th>
<th style="text-align: left;">Label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: left;">Covered by another agency</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: left;">City</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: left;">County</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: left;">University or college</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: left;">State Police</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: left;">Special Agency</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: left;">Other state agencies</td>
</tr>
<tr class="even">
<td style="text-align: center;">7</td>
<td style="text-align: left;">Tribal agencies</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8</td>
<td style="text-align: left;">Federal agencies</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(agency_type) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent =</span> n<span class="sc">/</span><span class="fu">nrow</span>(batch_header_file))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  agency_type     n percent
        &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
1           1 13984  0.643 
2           2  3119  0.143 
3           3  1055  0.0485
4           4  1185  0.0545
5           5   924  0.0425
6           6  1265  0.0582
7           7   221  0.0102</code></pre>
</div>
</div>
<p>State agencies cover multiple counties, so we remove these agencies for simplicity</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>batch_header_file <span class="ot">&lt;-</span> batch_header_file <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>agency_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="join-place-fips-codes-onto-agency-data" class="level2">
<h2 class="anchored" data-anchor-id="join-place-fips-codes-onto-agency-data">3. Join place FIPS codes onto agency data</h2>
<p>The goal of this section is to match a Census place FIPS code to every agency in the 2022 NIBRS Batch Header File. The Batch Header File has a variable for city name. We could just load the 486 Census places of interest from Urban and attempt to join the files by name. However, (1) this will be imprecise because of differences in naming conventions (city names in one file may have punctuation marks while city names in the other file may not), and (2) it is more complete to first assign a place GEOID to <strong>every</strong> agency in the data and <strong>then</strong> filter to agencies that align with our places of interest. We accomplish that in the following way:</p>
<ol type="1">
<li>Use LEAIC</li>
<li>Join by name using Urban’s universe of Census Places</li>
<li>Use county to place crosswalk</li>
<li>Append files</li>
</ol>
<p>At each step, we split the data into observations that have a place FIPS code matched on and those that do not. We take those observations that still do not have a place code, try a different join, and repeat the process of splitting the observations into those that do and still do not have a place FIPS code. At the end, we append each subset to recreate the full Batch Header File.</p>
<section id="law-enforcement-agency-identifiers-crosswalk-leaic-2012" class="level3">
<h3 class="anchored" data-anchor-id="law-enforcement-agency-identifiers-crosswalk-leaic-2012">3.1 Law Enforcement Agency Identifiers Crosswalk (LEAIC), 2012</h3>
<p>Our 2022 NIBRS Batch Header File contains a list of agencies that each have a unique agency identifier (ORI). The LEAIC also contains a list of agencies with ORI, but it also contains a place FIPS code (and county FIPS) code for every agency. We merge the place FIPS code from LEAIC onto the Batch Header File by agency (ORI).</p>
<section id="a-background-on-leaic-and-manual-download" class="level4">
<h4 class="anchored" data-anchor-id="a-background-on-leaic-and-manual-download">3.1a Background on LEAIC and manual download</h4>
<p>The Law Enforcement Agency Identifiers Crosswalk (LEAIC) facilitates linking reported crime data with socio-economic data. The LEAIC file is available for download from the National Archive of Criminal Justice Data (NACJD) available through ICPSR at the following link: * <a href="https://www.icpsr.umich.edu/web/NACJD/studies/35158">LEAIC</a>.</p>
<p>Note that 2012 is the most recent year for which this crosswalk is available. Future updates should check if a more recent crosswalk is available yet.</p>
<p>Accessing these data requires an ICPSR account. Manually downloading these data is a five-step process, but you will only need to do each of these steps once for the creation of this metric:</p>
<ol type="1">
<li>Create an ICPSR account <a href="https://www.icpsr.umich.edu/cgi-bin/newacct">here</a>.</li>
<li>Navigate to the National Archive of Criminal Justice Data (NACJD) landing page for the LEAIC <a href="https://www.icpsr.umich.edu/web/NACJD/studies/35158">here</a>).</li>
<li>Select <code>Download</code>
<ul>
<li>Select <code>Delimited</code></li>
<li>Select <code>Agree</code> on the <code>Terms of Use</code></li>
</ul></li>
<li>Sign into your ICPSR account</li>
<li>This will download a zip file titled <code>ICPSR_35158-V2</code>. Unzip the file and navigate to <code>ICPSR_35158\DS0001\35158-0001-Data.tsv</code>. Move this file to the <code>mobility-from-poverty\07_safety\data</code> directory after you have cloned the repository for this project from GitHub.</li>
</ol>
</section>
<section id="b-load-and-clean-leaic" class="level4">
<h4 class="anchored" data-anchor-id="b-load-and-clean-leaic">3.1b Load and clean LEAIC</h4>
<p>After downloading the LEAIC, read it in. This file has a place FIPS linked to every reporting agency.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in crosswalk</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>leaic <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"07_safety"</span>, <span class="st">"data"</span>, <span class="st">"35158-0001-Data.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Limit file to necessary variables and rename. We use the codebook (<code>ICPSR_35158\DS0001\35158-0001-Codebook</code>) to determine what each variable represents.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>leaic <span class="ot">&lt;-</span> leaic <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">place =</span> <span class="fu">str_pad</span>(FPLACE, <span class="dv">5</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">GEOID =</span> <span class="fu">str_c</span>(FIPS_ST, place)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">ori =</span> ORI9, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    FIPS_COUNTY,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    place,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    GEOID,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    FIPS_ST,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    UANAME, <span class="co"># Census name for the Urbanized Area or Urban Cluster. Included for incorporated places and census-designated places only.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    LG_NAME <span class="co"># Local government name associated with the record. The source of these codes is the Census Bureau's Census of Governments</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove agencies with invalid ORI</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ori <span class="sc">!=</span> <span class="st">"-1"</span>) <span class="co"># Not in UCR/NCIC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="c-join-leaic-onto-nibrs-data-by-agency-identifier" class="level4">
<h4 class="anchored" data-anchor-id="c-join-leaic-onto-nibrs-data-by-agency-identifier">3.1c Join LEAIC onto NIBRS data by agency identifier</h4>
<p>Join the LEAIC to the 2022 NIBRS Batch Header File by agency. 635 agencies are in the BHF but not the 2012 crosswalk. The crosswalk is from 2012, so these could be new agencies from 2013-2022.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>joined_ba_leaic <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> batch_header_file,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> leaic,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ori"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="d-create-subsets-of-matched-and-unmatched-observations" class="level4">
<h4 class="anchored" data-anchor-id="d-create-subsets-of-matched-and-unmatched-observations">3.1d Create subsets of matched and unmatched observations</h4>
<p>From the joined Batch Header File/LEAIC, filter to the 635 observations that did not match from BHF (i.e., observations that have a missing value for the <code>place</code> variable). In the next steps, we will continue to try and assign place FIPS codes to these observations. For now, we ignore the 18,668 rows that have already matched.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These are observations from the Batch Header File that still do not have a place FIPS code</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ba_mis_leaic <span class="ot">&lt;-</span> joined_ba_leaic <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(place)) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ori, state_abb, state, city, county)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a subset of matched observations</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>ba_place_leaic <span class="ot">&lt;-</span> joined_ba_leaic <span class="sc">|&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(place))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="join-urban-universe-of-places-onto-nibrs-by-city-name" class="level3">
<h3 class="anchored" data-anchor-id="join-urban-universe-of-places-onto-nibrs-by-city-name">3.2 Join Urban Universe of Places onto NIBRS by city name</h3>
<p>We still have 635 Batch Header File observations that do not have a place FIPS code. 276 of these observations do have a city name. We can use Urban’s universe of places, which includes both city name and place FIPS codes, to match place codes onto these observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 276 of the unmatched observations have a city name</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ba_mis_leaic <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(city)) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
      n
  &lt;int&gt;
1   276</code></pre>
</div>
</div>
<section id="a-background-on-urbans-universe-of-census-places-and-manual-download" class="level4">
<h4 class="anchored" data-anchor-id="a-background-on-urbans-universe-of-census-places-and-manual-download">3.2a Background on Urban’s universe of Census Places and manual download</h4>
<p>The Urban Institute maintains a list of the 486 Census places that are of interest to this project for years 2016-2022. It is available for download on the project’s GitHub repository <a href="https://github.com/UI-Research/mobility-from-poverty/blob/main/geographic-crosswalks/data/place-populations.csv">here</a>. For this step, you will need to download the file and move it to the <code>mobility-from-poverty\07_safety\data</code> directory after you have cloned the repository for this project from GitHub.</p>
</section>
<section id="b-load-and-clean-places-universe" class="level4">
<h4 class="anchored" data-anchor-id="b-load-and-clean-places-universe">3.2b Load and clean places universe</h4>
<p>After downloading the places file, read it in. This file contains our 486 places of interest with both their name and place FIPS code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in Urban places file</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"07_safety"</span>, <span class="st">"data"</span>, <span class="st">"place-populations.csv"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that future updates of the safety metrics may want to include historical NIBRS data back to 2016, and in that case should not filter the places file by year</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2021</span>, <span class="dv">2022</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>places <span class="sc">|&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
# Groups:   year [2]
   year     n
  &lt;dbl&gt; &lt;int&gt;
1  2021   486
2  2022   486</code></pre>
</div>
</div>
<p>We are only using the 2022 Batch Header File, so we can filter to just the 2022 places. We will use the same linkage for all years. Additionally, we clean some of the variables to make the process of joining easier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> places <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter year</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">2022</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean variables for joining</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># place_name = str_to_title(place_name),</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">GEOID =</span> <span class="fu">str_c</span>(state, place)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Observations in the Urban places file have <code>city</code>, <code>village</code>, <code>town</code>, etc. attached to the values in the <code>place_name</code> variable, while observations in the Batch Header File do not. We create a new variable without these endings in the Urban places file to increase the chances of joining by name.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create variable for joining</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>places<span class="sc">$</span>city <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">" city$| municipality$| village$| town$"</span>, <span class="st">""</span>, places<span class="sc">$</span>place_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, I am manually editing the names of a few observations from the Urban file that were flagged in the 2021 version of this metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>places <span class="ot">&lt;-</span> places <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">city =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"06"</span> <span class="sc">&amp;</span> city <span class="sc">==</span> <span class="st">"San Buenaventura (Ventura)"</span> <span class="sc">~</span> <span class="st">"Ventura"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"12"</span> <span class="sc">&amp;</span> city <span class="sc">==</span> <span class="st">"Fort Lauderdale"</span> <span class="sc">~</span> <span class="st">"Ft Lauderdale"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"13"</span> <span class="sc">&amp;</span> city <span class="sc">==</span> <span class="st">"Augusta-Richmond County consolidated government (balance)"</span> <span class="sc">~</span> <span class="st">"Augusta"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"18"</span> <span class="sc">&amp;</span> city <span class="sc">==</span> <span class="st">"Indianapolis city (balance)"</span> <span class="sc">~</span> <span class="st">"Indianapolis"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"29"</span> <span class="sc">&amp;</span> city <span class="sc">==</span> <span class="st">"St. Louis"</span> <span class="sc">~</span> <span class="st">"Saint Louis"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    state <span class="sc">==</span> <span class="st">"37"</span> <span class="sc">&amp;</span> city <span class="sc">==</span> <span class="st">"Winston-Salem"</span> <span class="sc">~</span> <span class="st">"Winston Salem"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> city</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="c-join" class="level4">
<h4 class="anchored" data-anchor-id="c-join">3.2c Join</h4>
<p>Start with the 635 Batch Header File observations that still do not have a place FIPS code. Join the universe of Urban places onto these observations using state FIPS code and city name</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>joined_ba_urb <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> ba_mis_leaic,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> places,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"city"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a subset of observations that now have a place FIPS code</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>ba_place_urb <span class="ot">&lt;-</span> joined_ba_urb <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(place))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a subset of observations that still do not have a place FIPS code</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>ba_mis_urb <span class="ot">&lt;-</span> joined_ba_urb <span class="sc">|&gt;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(place)) <span class="sc">|&gt;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ori, state_abb, city, state, county)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="join-county-place-crosswalk-onto-nibrs-by-county-fips" class="level3">
<h3 class="anchored" data-anchor-id="join-county-place-crosswalk-onto-nibrs-by-county-fips">3.3 Join county-place crosswalk onto NIBRS by county FIPS</h3>
<p>We still have 496 Batch Header File observations that do not have a place FIPS code. 469 of these observations do have a county FIPS code. We can use a crosswalk of counties to places, which includes both county FIPS codes and place FIPS codes, to match place codes onto these observations.</p>
<section id="a-background-on-county-place-crosswalk" class="level4">
<h4 class="anchored" data-anchor-id="a-background-on-county-place-crosswalk">3.3a Background on county-place crosswalk</h4>
<p>The Urban Institute maintains a county-place crosswalk for 2022 counties. It is available for download on the project’s GitHub repository <a href="https://github.com/UI-Research/mobility-from-poverty/blob/main/geographic-crosswalks/data/geocorr2022_county_place.csv">here</a>. It was constructed using Geocorr 2022 from the Missouri Census Data Center, which can be accessed <a href="https://mcdc.missouri.edu/applications/geocorr2022.html">here</a>. For this step, you will need to download the file and move it to the <code>mobility-from-poverty\07_safety\data</code> directory after you have cloned the repository for this project from GitHub.</p>
<p>Census places and counties are both nested within states; that is, places and counties do not share boundaries <a href="https://www2.census.gov/geo/pdfs/reference/geodiagram.pdf">do overlap</a>, and they do overlap. This crosswalk file contains one observation for every unique county/place pair in 2022, along with place FIPS codes and county FIPS codes, and includes observations for county components that do not overlap with a place.</p>
<p>We want to use this crosswalk to merge a single place code onto each remaining agency in the NIBRS data by county. This is complicated by the fact that some counties overlap with multiple places. Consider the following example: Suppose that Wayne County, MI (county FIPS 26163) has observations in the crosswalk for 4 places (Detroit, Dearborn, Livonia, and Westland). Suppose that Agency A in the NIBRS data also has a county FIPS of 26163. If we try to merge place codes from the crosswalk onto the NIBRS data by county FIPS, it won’t be a 1 to 1 match, and we don’t actually know which of those 4 places to associate with Agency A. However, if there is a county in the crosswalk with only one place associated with it, that is a 1 to 1 match and we can merge the place FIPS code from the crosswalk onto the NIBRS data by county FIPS code.</p>
</section>
<section id="b-load-and-clean-county-place-crosswalk" class="level4">
<h4 class="anchored" data-anchor-id="b-load-and-clean-county-place-crosswalk">3.3b Load and clean county-place crosswalk</h4>
<p>After downloading the county-place crosswalk, read it in.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>county_place_xw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"07_safety"</span>, <span class="st">"data"</span>, <span class="st">"geocorr2022_county_place.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Filter the crosswalk observations to only places in our Urban universe of places.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First create a state/place GEOID</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>county_place_xw <span class="ot">&lt;-</span> county_place_xw <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">as.character</span>(state),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_pad</span>(state, <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">place =</span> <span class="fu">as.character</span>(place),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">place =</span> <span class="fu">str_pad</span>(place, <span class="dv">5</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">GEOID =</span> <span class="fu">str_c</span>(state, place)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter crosswalk</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>county_place_xw <span class="ot">&lt;-</span> county_place_xw <span class="sc">|&gt;</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(GEOID <span class="sc">%in%</span> places<span class="sc">$</span>GEOID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Filter the crosswalk observations only those counties that correspond with one place.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>county_place_xw <span class="ot">&lt;-</span> county_place_xw <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, county) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="c-join-county-place-crosswalk-onto-nibrs-by-county-fips" class="level4">
<h4 class="anchored" data-anchor-id="c-join-county-place-crosswalk-onto-nibrs-by-county-fips">3.3c Join county-place crosswalk onto NIBRS by county FIPS</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>joined_ba_cpxw <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> ba_mis_urb,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> county_place_xw,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"county"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a subset of observations that now have a place FIPS code</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>ba_place_cpxw <span class="ot">&lt;-</span> joined_ba_cpxw <span class="sc">|&gt;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(place))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a subset of observations that still do not have a place FIPS code</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>ba_mis_cpxw <span class="ot">&lt;-</span> joined_ba_cpxw <span class="sc">|&gt;</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(place))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select(ori, state_abb, city, state, county)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="append-all-subsets-of-the-nibrs-batch-header-file-back-together" class="level3">
<h3 class="anchored" data-anchor-id="append-all-subsets-of-the-nibrs-batch-header-file-back-together">3.4 Append all subsets of the NIBRS Batch Header File back together</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bhf_place <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  ba_place_leaic,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  ba_place_urb,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  ba_place_cpxw,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  ba_mis_cpxw</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(ba_place_leaic, ba_place_urb, ba_place_cpxw, ba_mis_leaic, ba_mis_urb, ba_mis_cpxw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>407 agencies from the Batch Header File still do not have a place FIPS code. These could be agencies that were not in the LEAIC crosswalk, originally had no city or county information, counties that were not associated with our universe of places or that were associated with more than one place in our universe, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>bhf_place <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(place)) <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
      n
  &lt;int&gt;
1   407</code></pre>
</div>
</div>
<p>Finally, now that we have assigned a place FIPS code to as many agencies in the batch header file as possible, we limit to the places in Urban’s universe of places</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>bhf_place_urb <span class="ot">&lt;-</span> bhf_place <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(GEOID <span class="sc">%in%</span> places<span class="sc">$</span>GEOID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="construct-place-level-population-and-demographics-using-acs" class="level2">
<h2 class="anchored" data-anchor-id="construct-place-level-population-and-demographics-using-acs">4. Construct place-level population and demographics using ACS</h2>
<p>Recall that this file serves as a precursor file to the files that create both of our metrics, which are:</p>
<ul>
<li>Reported violent crimes per 100,000 people and reported property crimes per 100,000 people</li>
<li>Juvenile arrests per 100,000 juveniles</li>
</ul>
<p>Additionally, for the juvenile arrests metric, we are interested in subgroups by age, race, and sex. To calculate these rates (both total and by subgroup), we need total population and demographic information for our denominators. We pull total population and demographic data from the 5-year ACS files for each year 2021-2022.</p>
<p>This section relies on the <code>tidycensus</code> package, which requires a Census API key. You can acquire a key <a href="https://api.census.gov/data/key_signup.html">here</a> and learn more about installing your key <a href="https://walker-data.com/tidycensus/reference/census_api_key.html">here</a>. Replace <code>[YOUR-KEY-HERE]</code> in the code below with your Census API key (leave the quotation marks).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set Census API once</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tidycensus::census_api_key("[YOUR-KEY-HERE]", install=TRUE, overwrite = TRUE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="check-acs-variable-names-and-identify-those-we-need" class="level3">
<h3 class="anchored" data-anchor-id="check-acs-variable-names-and-identify-those-we-need">4.1 Check ACS variable names and identify those we need</h3>
<p>Load ACS variables for our first and last years. Manually explore each file and spot check several observations. The naming conventions of ACS variables do not seem to change during our time period. Note that if they did we would need to split up the code that reads in the years below. Note that future updates of the safety metrics may want to pull data back to 2016, in which case the first year should be changed below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check ACS variables for the first and last years to see if they change over time</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>variables_fy <span class="ot">&lt;-</span> tidycensus<span class="sc">::</span><span class="fu">load_variables</span>(<span class="dv">2021</span>, <span class="st">"acs5"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>variables_ly <span class="ot">&lt;-</span> tidycensus<span class="sc">::</span><span class="fu">load_variables</span>(<span class="dv">2022</span>, <span class="st">"acs5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-vectors-for-years-and-variables-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="create-vectors-for-years-and-variables-of-interest">4.2 Create vectors for years and variables of interest</h3>
<p>Note that if additional subgroups for either safety metric are desired in future updates, the variables pulled here may need updated. Note that future updates of the safety metrics may want to pull data back to 2016, in which case the list of years should be changed below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of all our years</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># years &lt;- lst(2016, 2017, 2018, 2019, 2020, 2021, 2022)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">lst</span>(<span class="dv">2021</span>, <span class="dv">2022</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector for our ACS variables of interest</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>my_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">total_people =</span> <span class="st">"B01003_001"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014 =</span> <span class="st">"B01001_005"</span>, </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517 =</span> <span class="st">"B01001_006"</span>,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014 =</span> <span class="st">"B01001_029"</span>, </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517 =</span> <span class="st">"B01001_030"</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_white =</span> <span class="st">"B01001A_005"</span>, </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_black =</span> <span class="st">"B01001B_005"</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_aian =</span> <span class="st">"B01001C_005"</span>, </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_asin =</span> <span class="st">"B01001D_005"</span>,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_nhpi =</span> <span class="st">"B01001E_005"</span>, </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_othr =</span> <span class="st">"B01001F_005"</span>,</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_twom =</span> <span class="st">"B01001G_005"</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_white_nh =</span> <span class="st">"B01001H_005"</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1014_hispanic =</span> <span class="st">"B01001I_005"</span>,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_white =</span> <span class="st">"B01001A_006"</span>, </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_black =</span> <span class="st">"B01001B_006"</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_aian =</span> <span class="st">"B01001C_006"</span>, </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_asin =</span> <span class="st">"B01001D_006"</span>,</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_nhpi =</span> <span class="st">"B01001E_006"</span>, </span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_othr =</span> <span class="st">"B01001F_006"</span>,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_twom =</span> <span class="st">"B01001G_006"</span>,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_white_nh =</span> <span class="st">"B01001H_006"</span>, </span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m_1517_hispanic =</span> <span class="st">"B01001I_006"</span>,</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_white =</span> <span class="st">"B01001A_020"</span>, </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_black =</span> <span class="st">"B01001B_020"</span>,</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_aian =</span> <span class="st">"B01001C_020"</span>, </span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_asin =</span> <span class="st">"B01001D_020"</span>,</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_nhpi =</span> <span class="st">"B01001E_020"</span>, </span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_othr =</span> <span class="st">"B01001F_020"</span>,</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_twom =</span> <span class="st">"B01001G_020"</span>,</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_white_nh =</span> <span class="st">"B01001H_020"</span>,</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1014_hispanic =</span> <span class="st">"B01001I_020"</span>,</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_white =</span> <span class="st">"B01001A_021"</span>, </span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_black =</span> <span class="st">"B01001B_021"</span>,</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_aian =</span> <span class="st">"B01001C_021"</span>, </span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_asin =</span> <span class="st">"B01001D_021"</span>,</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_nhpi =</span> <span class="st">"B01001E_021"</span>,</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_othr =</span> <span class="st">"B01001F_021"</span>,</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_twom =</span> <span class="st">"B01001G_021"</span>,</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_white_nh =</span> <span class="st">"B01001H_021"</span>, </span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_f_1517_hispanic =</span> <span class="st">"B01001I_021"</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pull-5-year-acs-data-for-all-years-2021-2022-at-the-place-level" class="level3">
<h3 class="anchored" data-anchor-id="pull-5-year-acs-data-for-all-years-2021-2022-at-the-place-level">4.3 Pull 5-year ACS data for all years 2021-2022 at the place level</h3>
<p>Pull 5-year ACS data at the place level for each year</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull data</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>place_demo_full <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  years,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> tidycensus<span class="sc">::</span><span class="fu">get_acs</span>(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">geography =</span> <span class="st">"place"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> my_vars,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> .x,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">survey =</span> <span class="st">"acs5"</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="st">"wide"</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">geometry =</span> <span class="cn">FALSE</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a year variable for each year</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"year"</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove Puerto Rico from ACS data</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>place_demo <span class="ot">&lt;-</span> place_demo_full <span class="sc">|&gt;</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">substr</span>(GEOID, <span class="dv">1</span>, <span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">"72"</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove obsolete files</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(variables_fy, variables_ly, years, my_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clean-acs-data" class="level3">
<h3 class="anchored" data-anchor-id="clean-acs-data">4.4 Clean ACS data</h3>
<p>Clean variable names and drop margins of error</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>place_demo <span class="ot">&lt;-</span> place_demo <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">sub</span>(<span class="st">"E$"</span>, <span class="st">""</span>, .x), <span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">ends_with</span>(<span class="st">"M"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="a-construct-subgroups-for-raceethnicity-sex-and-age-subgroups" class="level4">
<h4 class="anchored" data-anchor-id="a-construct-subgroups-for-raceethnicity-sex-and-age-subgroups">4.4a Construct subgroups for race/ethnicity, sex, and age subgroups</h4>
<p>For the rate of juvenile arrests per 100,000 juveniles metric, we want subgroups by race, sex, and age subgroups. These are subgroups of all observations ages 10-17, so the sum of each subgroup should equal the total number of observations ages 10-17.</p>
<ul>
<li>Race: white, Black, Hispanic, Asian/other</li>
<li>Sex: male, female</li>
<li>Age: ages 10-14, ages 15-17</li>
</ul>
<p>Note that there is a Non-Hispanic white category, but not a Non-Hispanic category for other races (Black, Asian, etc.). This means that the categories will have a small but non-zero overlap. The race/ethnicity categories actually used in the <code>juvenile-arrests</code> metric are white, Black, Asian/other, and Hispanic. These are not mutually exclusive (e.g., someone could be counted as both Black and Hispanic), which matches the population denominators created here (this is because ACS doesn’t have counts of non-Hispanic Black or other non-Hispanic races other than white).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the total for ages 10-17 and the race, sex, and age subgroups</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>place_demo <span class="ot">&lt;-</span> place_demo <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total age 10-17</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017 =</span> age_m_1014 <span class="sc">+</span> age_m_1517 <span class="sc">+</span> age_f_1014 <span class="sc">+</span> age_f_1517,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Race subgroups</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_white =</span> age_m_1014_white <span class="sc">+</span> age_m_1517_white <span class="sc">+</span> age_f_1014_white <span class="sc">+</span> age_f_1517_white,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_black =</span> age_m_1014_black <span class="sc">+</span> age_m_1517_black <span class="sc">+</span> age_f_1014_black <span class="sc">+</span> age_f_1517_black,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_aian =</span> age_m_1014_aian <span class="sc">+</span> age_m_1517_aian <span class="sc">+</span> age_f_1014_aian <span class="sc">+</span> age_f_1517_aian,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_asin =</span> age_m_1014_asin <span class="sc">+</span> age_m_1517_asin <span class="sc">+</span> age_f_1014_asin <span class="sc">+</span> age_f_1517_asin,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_nhpi =</span> age_m_1014_nhpi <span class="sc">+</span> age_m_1517_nhpi <span class="sc">+</span> age_f_1014_nhpi <span class="sc">+</span> age_f_1517_nhpi,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_othr =</span> age_m_1014_othr <span class="sc">+</span> age_m_1517_othr <span class="sc">+</span> age_f_1014_othr <span class="sc">+</span> age_f_1517_othr,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># age_1017_twom = age_m_1014_twom + age_m_1517_twom + age_f_1014_twom + age_f_1517_twom,</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_hispanic =</span> age_m_1014_hispanic <span class="sc">+</span> age_m_1517_hispanic <span class="sc">+</span> age_f_1014_hispanic <span class="sc">+</span> age_f_1517_hispanic,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_white_nh =</span> age_m_1014_white_nh <span class="sc">+</span> age_m_1517_white_nh <span class="sc">+</span> age_f_1014_white_nh <span class="sc">+</span> age_f_1517_white_nh,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sex subgroups</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex_1017_m =</span> age_m_1014 <span class="sc">+</span> age_m_1517,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex_1017_f =</span> age_f_1014 <span class="sc">+</span> age_f_1517,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Age subgroups</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1014_all =</span> age_m_1014 <span class="sc">+</span> age_f_1014,</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1517_all =</span> age_m_1517 <span class="sc">+</span> age_f_1517</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit race variables</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>place_demo <span class="ot">&lt;-</span> place_demo <span class="sc">|&gt;</span>  </span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Manually create "two or more" race variable</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_twom =</span> age_1017 <span class="sc">-</span> age_1017_white <span class="sc">-</span> age_1017_black <span class="sc">-</span> </span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>      age_1017_aian <span class="sc">-</span> age_1017_asin <span class="sc">-</span> age_1017_nhpi <span class="sc">-</span> age_1017_othr,</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all asian races, other races, and two or more races</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_1017_asian_other =</span> age_1017_aian <span class="sc">+</span> age_1017_asin <span class="sc">+</span> age_1017_nhpi <span class="sc">+</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>      age_1017_othr <span class="sc">+</span> age_1017_twom</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Limit ACS data to relevant variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit to relevant variables</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>place_demo <span class="ot">&lt;-</span> place_demo <span class="sc">|&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, GEOID, total_people, <span class="fu">starts_with</span>(<span class="st">"age_1017"</span>), <span class="fu">starts_with</span>(<span class="st">"sex_1017"</span>), <span class="fu">ends_with</span>(<span class="st">"_all"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Limit ACS data to places in the Urban universe of 486 places</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit places to those in the Urban file</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>place_demo <span class="ot">&lt;-</span> place_demo <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(GEOID <span class="sc">%in%</span> places<span class="sc">$</span>GEOID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test that construction of each subgroup worked as expected</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>(<span class="fu">select</span>(place_demo, <span class="fu">matches</span>(<span class="st">"age_1017_asian_other|age_1017_white$|age_1017_black"</span>)), <span class="at">na.rm =</span> T) <span class="sc">==</span> place_demo<span class="sc">$</span>age_1017</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>(<span class="fu">select</span>(place_demo, <span class="fu">matches</span>(<span class="st">"age_1517_all|age_1014_all"</span>)), <span class="at">na.rm =</span> T) <span class="sc">==</span> place_demo<span class="sc">$</span>age_1017</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowSums</span>(<span class="fu">select</span>(place_demo, <span class="fu">matches</span>(<span class="st">"sex_1017_m|sex_1017_f"</span>)), <span class="at">na.rm =</span> T) <span class="sc">==</span> place_demo<span class="sc">$</span>age_1017</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="create-and-write-out-final-files" class="level2">
<h2 class="anchored" data-anchor-id="create-and-write-out-final-files">5. Create and write out final files</h2>
<section id="placeyear-level-population-and-demographics" class="level3">
<h3 class="anchored" data-anchor-id="placeyear-level-population-and-demographics">5.1 Place/year-level population and demographics</h3>
<p>This file contains Urban’s universe of 486 places by year with population and demographic information.</p>
<p>We’ve already created it, so we just need to write it out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This file has 486 places by 2 years = 972 observations</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(place_demo, <span class="at">file =</span> <span class="st">"modified data/all_place_demo.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="placeyear-level-population-and-demographics-with-number-of-reporting-agencies" class="level3">
<h3 class="anchored" data-anchor-id="placeyear-level-population-and-demographics-with-number-of-reporting-agencies">5.2 Place/year-level population and demographics with number of reporting agencies</h3>
<p>This file contains Urban’s universe of 486 places by year with population and demographic information, and includes the total number of reporting agencies in each place</p>
<p>First, count the number of agencies per place in our universe of places. 470 places have any agency. This is consistent with the number of places that had any agency in the 2021 safety metrics update. The maximum number of agencies in a place is 37.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>place_agency <span class="ot">&lt;-</span> bhf_place_urb <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(!is.na(place)) |&gt;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state, place) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_agencies =</span> <span class="fu">n_distinct</span>(ori),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_core_city =</span> <span class="fu">sum</span>(core_city<span class="sc">==</span><span class="dv">1</span>),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">core_city =</span> <span class="fu">max</span>(core_city),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_agen_city =</span> <span class="fu">sum</span>(agency_type<span class="sc">==</span><span class="dv">1</span>),</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_agen_cnty =</span> <span class="fu">sum</span>(agency_type<span class="sc">==</span><span class="dv">2</span>),</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_agen_univ =</span> <span class="fu">sum</span>(agency_type<span class="sc">==</span><span class="dv">3</span>),</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_agen_spcl =</span> <span class="fu">sum</span>(agency_type<span class="sc">==</span><span class="dv">5</span>),</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_agen_trbl =</span> <span class="fu">sum</span>(agency_type<span class="sc">==</span><span class="dv">7</span>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">str_c</span>(state, place))</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(place_agency)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">place_agency</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">470</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">state</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">place</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">370</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GEOID</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">470</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 18%">
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n_agencies</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.44</td>
<td style="text-align: right;">2.80</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">37</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">n_core_city</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">▅▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">core_city</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">▅▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">n_agen_city</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">▁▁▇▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">n_agen_cnty</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">n_agen_univ</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.52</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">n_agen_spcl</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">n_agen_trbl</td>
<td style="text-align: right;">103</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Join the place-level number of agencies onto the place/year-level population and demographic data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This file has 486 places by 2 years = 972 observations. Only 470/486 places had any agency, so 32 observations (accounting for all years) are only in the demographic file</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>place_demo_agency <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> place_demo,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> place_agency,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that <code>state</code> is missing for some observations that are missing agencies but the full state/place <code>GEOID</code> is not</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>place_demo_agency <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(n_agencies)) <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
# Groups:   GEOID [16]
   GEOID       n
   &lt;chr&gt;   &lt;int&gt;
 1 0602364     2
 2 0613214     2
 3 0633434     2
 4 0637692     2
 5 0639496     2
 6 0640130     2
 7 0646842     2
 8 0648256     2
 9 0659444     2
10 0668378     2
11 0669088     2
12 0678120     2
13 1254200     2
14 1372122     2
15 1571550     2
16 2669035     2</code></pre>
</div>
</div>
<p>Write out the file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(place_demo_agency, <span class="at">file =</span> <span class="st">"modified data/all_place_demo_agency.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="unique-placeagency-combinations" class="level3">
<h3 class="anchored" data-anchor-id="unique-placeagency-combinations">5.3 Unique place/agency combinations</h3>
<p>This file contains each unique place/agency pair using Urban’s universe of 486 places. There are 1,145 unique observations.</p>
<p>We’ve already created this file. We limit to the variables we want to keep and then write it out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select variables</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>bhf_place_urb <span class="ot">&lt;-</span> bhf_place_urb <span class="sc">|&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ori, state, place, core_city, agency_type, GEOID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We still want agencies that aren’t reporting to have a year attached, so we add a year to each agency/place pair. Note that I think this is necessary (at least in part) because we are only using the Batch Header File from 2022. If we used the Batch Header File from each year, I don’t think this step would be necessary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>bhf_place_urb <span class="ot">&lt;-</span> bhf_place_urb <span class="sc">|&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2021</span>, <span class="dv">2022</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(bhf_place_urb, <span class="at">file =</span> <span class="st">"modified data/all_agency_place.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>