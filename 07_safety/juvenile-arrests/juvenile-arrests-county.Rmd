---
title: "Juvenile Arrests - County"
author: "Vincent Pancini"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output:
  html_document:
    number_sections: false
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    editor_options:
      chunk_output_type: console
---

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r setup}
options(scipen = 999)

# library(urbnthemes)
library(tidyverse)
library(skimr)
library(tidylog)

# set_urbn_defaults(style = "print")

```


## 1. Load and clean arrest data

The data for this metric come from the FBI's [National Incident-Based Reporting System (NIBRS)](https://bjs.ojp.gov/national-incident-based-reporting-system-nibrs). This is the national standard for law enforcement crime data reporting in the United States. Processing the raw NIBRS data would take a lot of work.

Instead, we use criminologist Jacob Kaplan's Concatenated Files: National Incident-Based Reporting System (NIBRS) Data, 1991-2022. We use Version 9. These data are available for download via [openICPSR](https://www.openicpsr.org/openicpsr/project/118281/version/V9/view).

We want both the `arrestee` segment and the `group_b_arrest_report` segment for this metric, so we download the following two files:
    1. `nibrs_1991_2022_arrestee_segment_rds.zip`
    2. `nibrs_1991_2022_group_b_arrest_report_segment_rds.zip`

After agreeing to the `Terms of Use` for each download unzip the file, select `nibrs_arrestee_segment_2022.rds` or `nibrs_group_b_arrest_report_segment_2022.rds`, and move it to the appropriate directory and folder. Now, we read in the data.
```{r}
# Load 2022 NIBRS group A arrestee segment
arrests_data <- readRDS(here::here(
  "07_safety", "juvenile-arrests", "nibrs_arrestee_segment_2022.rds"))

# Load 2022 NIBRS group B arrest segment
arrests_data_b <- readRDS(here::here(
  "07_safety", "juvenile-arrests", "nibrs_group_b_arrest_report_segment_2022.rds"))

```

We want to combine the group A and group B files. First we limit each file to the relevant variables.
```{r}
# Select only necessary variables from group A
arrests_data <- arrests_data %>%
  select(year, ori, incident_number, ucr_arrest_offense_code, age_of_arrestee, race_of_arrestee,
         ethnicity_of_arrestee) %>%
  mutate(group = "A")

# Select only necessary variables from group B
arrests_data_b <- arrests_data_b %>%
  rename(incident_number = arrest_transaction_incident_num) %>%
  select(year, ori, incident_number, ucr_arrest_offense_code, age_of_arrestee, race_of_arrestee,
         ethnicity_of_arrestee) %>%
  mutate(group = "B")

```

The group B codes for race and ethnicity are different from group A. We edit the group B codes to be consistent with group A. 
    todo(): I'm not totally certain that the recodes for the abbreviations in group B are accurate, but I can't find a codebook anywhere so I made my best guess
```{r}
# Look at race codes in each data frame
arrests_data %>% group_by(race_of_arrestee) %>% count()
arrests_data_b %>% group_by(race_of_arrestee) %>% count()

# Edit group B race codes to match those of group A
arrests_data_b <- arrests_data_b %>%
  mutate(race_of_arrestee = if_else(race_of_arrestee=="w", "white", race_of_arrestee),
         race_of_arrestee = if_else(race_of_arrestee=="b", "black", race_of_arrestee),
         race_of_arrestee = if_else(race_of_arrestee=="i", "american indian/alaskan native", race_of_arrestee),
         race_of_arrestee = if_else(race_of_arrestee=="a", "asian", race_of_arrestee),
         race_of_arrestee = if_else(race_of_arrestee=="p", "native hawaiian or other pacific islander", race_of_arrestee),
         race_of_arrestee = if_else(race_of_arrestee=="u", "unknown", race_of_arrestee))

# Look at ethnicity codes in each data frame
arrests_data %>% group_by(ethnicity_of_arrestee) %>% count()
arrests_data_b %>% group_by(ethnicity_of_arrestee) %>% count()

# Edit group B ethnicity codes to match those of group A
arrests_data_b <- arrests_data_b %>%
  mutate(ethnicity_of_arrestee = if_else(ethnicity_of_arrestee=="h", "hispanic origin", ethnicity_of_arrestee),
         ethnicity_of_arrestee = if_else(ethnicity_of_arrestee=="n", "not of hispanic origin", ethnicity_of_arrestee),
         ethnicity_of_arrestee = if_else(ethnicity_of_arrestee=="u", "unknown", ethnicity_of_arrestee))

```


```{r}
# Append group B file with group A file
arrests_ab <- arrests_data %>%
  bind_rows(arrests_data_b)

# Remove obsolete files
rm(arrests_data, arrests_data_b)
gc()
  
```

Limit sample to under age 18. 117 observations are reported as "over 98 years old" and 2,095 observations are reported as "unknown". We assign these observations a new age value of `NA` and exclude them from our sample.
    todo(): I don't understand how some children so young are arrested. Is that maybe an administartive error?
```{r}
table(arrests_ab$age_of_arrestee)

arrests_juvenile <- arrests_ab %>%
  mutate(age = as.numeric(age_of_arrestee)) %>%
  filter(age < 18)

arrests_juvenile %>% 
  group_by(age) %>% 
  count()

```

There are 61 unique arrest offense codes in our data. We group these offense codes into property crimes and violent crimes using the categories outlines in Section 2.3 of the [2021.1 National Incident-Based Reporting System User Manual](https://bjs.ojp.gov/sites/g/files/xyckuh236/files/sarble/data_common/nibrs-user-manual-2021-1041521.pdf) and aggregate counts up to the reporting agency level.
    todo(): There are 24 offense codes reported in NBIRS data but missing from our classifications. I'm not sure if these were intentionally left out (maybe they're neither property nor violent crimes?) or if they just weren't present last year. The 24 codes are: all other offenses, animal cruelty, curfew/loitering/vagrancy violations, disorderly conduct, driving under the influence, drug/narcotic offenses - drug equipment violations, drug/narcotic offenses - drug/narcotic violations, failure to appear, family offenses, nonviolent, fugitive offenses - flight to avoid persecution, gambling offenses - betting/wagering, gambling offenses - gambling equipment violations, gambling offenses - operating/promoting/assisting gambling, gambling offenses - sports tampering, liquor law violations, pornography/obscene material, prostitution offenses - assisting or promoting prostitution, prostitution offenses - prostitution, prostitution offenses - purchasing prostitution, runaway, trespass of real property, weapon law violations - explosives, weapon law violations - weapon law violations. Additionally, there was 1 code in last year's classifications that was not present this year: welfare fraud.
        todo(): The codes that we don't classify are crimes against society (rather than person or property), or Group B offenses which don't get a classification.
```{r}
# Count number of observations in each offense code
arrests_juvenile %>%
  count(ucr_arrest_offense_code)
```

```{r}
codes <- tribble(
  ~offense,	~crime_against,	~group,
  "animal cruelty",	                                                    "society",	"A",	
  "arson",	                                                            "property",	"A",	
  "assault offenses - aggravated assault",	                            "person",	"A",	
  "assault offenses - simple assault",	                                "person",	"A",	
  "assault offenses - intimidation",	                                  "person",	"A",	
  "bribery",	                                                          "property",	"A",	
  "burglary/breaking and entering",	                                    "property",	"A",	
  "commerce violations - import violations",	                          "society",	"A",	
  "commerce violations - export violations",	                          "society",	"A",	
  "commerce violations - federal liquor offenses",	                    "society",	"A",	
  "commerce violations - federal tobacco offenses",	                    "society",	"A",	
  "commerce violations - wildlife trafficking",	                        "society",	"A",	
  "counterfeiting/forgery",	                                            "property",	"A",	
  "destruction/damage/vandalism of property",	                          "property",	"A",	
  "drug/narcotic offenses - drug/narcotic violations",	                "society",	"A",	
  "drug/narcotic offenses - drug equipment violations",	                "society",	"A",	
  "embezzlement",	                                                      "property",	"A",	
  "espionage",	                                                        "society",	"A",	
  "extortion/blackmail",	                                              "property",	"A",	
  "fraud offenses - false pretenses/swindle/confidence game",	          "property",	"A",	
  "fraud offenses - credit card/atm fraud",	                            "property",	"A",	
  "fraud offenses - impersonation",	                                    "property",	"A",	
  "fraud offenses - welfare fraud",	                                    "property",	"A",	
  "fraud offenses - wire fraud",	                                      "property",	"A",	
  "fraud offenses - identity theft",	                                  "property",	"A",	
  "fraud offenses - hacking/computer invasion",	                        "property",	"A",	
  "fraud offenses - money laundering",	                                "society",	"A",	
  "fugitive offenses - harboring escapee/concealing from arrest",	      "society",	"A",	
  "fugitive offenses - flight to avoid prosecution",	                  "society",	"A",	
  "fugitive offenses - flight to avoid deportation",	                  "society",	"A",	
  "gambling offenses - betting/wagering",	                              "society",	"A",	
  "gambling offenses - operating/promoting/assisting gambling",	        "society",	"A",	
  "gambling offenses - gambling equipment violations",	                "society",	"A",	
  "gambling offenses - sports tampering",	                              "society",	"A",	
  "murder/nonnegligent manslaughter",	                                  "person",	"A",	
  "negligent manslaughter",	                                            "person",	"A",	
  "homicide offenses - justifiable homicide",	                          "not a crime",	"A",	
  "human trafficking - commercial sex acts",	                          "person",	"A",	
  "human trafficking - involuntary servitude",	                        "person",	"A",	
  "immigration violations - illegal entry into the united states",	    "society",	"A",	
  "immigration violations - false citizenship",	                        "society",	"A",	
  "immigration violations - smuggling aliens",	                        "society",	"A",	
  "immigration violations - reentry after deportation",               	"society",	"A",	
  "kidnapping/abduction",	                                              "person",	"A",	
  "larceny/theft offenses - pocket-picking",	                          "property",	"A",	
  "larceny/theft offenses - purse-snatching",	                          "property",	"A",	
  "larceny/theft offenses - shoplifting",	                              "property",	"A",	
  "larceny/theft offenses - theft from building",	                      "property",	"A",	
  "larceny/theft offenses - theft from coin-operated machine or device", "property",	"A",	
  "larceny/theft offenses - theft from motor vehicle",	                "property",	"A",	
  "larceny/theft offenses - theft of motor vehicle parts/accessories",	"property",	"A",	
  "larceny/theft offenses - all other larceny",	                        "property",	"A",	
  "motor vehicle theft",	                                              "property",	"A",	
  "pornography/obscene material",	                                      "society",	"A",	
  "prostitution offenses - prostitution",	                              "society",	"A",	
  "prostitution offenses - assisting or promoting prostitution",	      "society",	"A",	
  "prostitution offenses - purchasing prostitution",	                  "society",	"A",	
  "robbery",	                                                          "property",	"A",	
  "sex offenses - rape",	                                              "person",	"A",	
  "sex offenses - sodomy",	                                            "person",	"A",	
  "sex offenses - sexual assault with an object",	                      "person",	"A",	
  "sex offenses - fondling (incident liberties/child molest)",	        "person",	"A",	
  "sex offenses - incest",	                                            "person",	"A",	
  "sex offenses - statutory rape",	                                    "person",	"A",	
  "sex offenses - failure to register as a sex offender",	              "society",	"A",	
  "stolen property offenses (receiving, selling, etc.)",	              "property",	"A",	
  "treason",	                                                          "society",	"A",	
  "weapon law violations - weapon law violations",	                    "society",	"A",	
  "weapon law violations - violation of national firearm act of 1934",	"society",	"A",	
  "weapon law violations - weapons of mass destruction",	              "society",	"A",	
  "weapon law violations - explosives",	                                "society",	"A",	
  "failure to appear",	                                                 "",	"B",	
  "curfew/loitering/vagrancy violations",	                               "",	"B",	
  "disorderly conduct",	                                                 "",	"B",	
  "driving under the influence",	                                       "",	"B",	
  "family offenses, nonviolent",	                                       "",	"B",	
  "federal resource violations",	                                       "",	"B",	
  "liquor law violations",	                                             "",	"B",	
  "perjury",	                                                           "",	"B",	
  "trespass of real property",	                                         "",	"B",	
  "all other offenses",	                                                 "",	"B",	
  # The following three codes were removed in 2021
  "bad checks",	                                                         "",	"",
  "drunkenness",                                                      	 "",	"",	
  "peeping tom",	                                                       "",	"",	
  # The following code was removed in 2008
  "runaway",                                                             "",	"",	
  
)

# Create indicator variables for property and violent crimes
arrests_juvenile <- arrests_juvenile %>%
  mutate(property = ifelse(ucr_arrest_offense_code %in% property, 1, 0),
         violent = ifelse(ucr_arrest_offense_code %in% violent, 1, 0)
  )
```

todo(): 253,665 observations (68%) are not in either category of arrests
```{r}
arrests_juvenile %>%
  group_by(property, violent) %>%
  count()

```


```{r}
# 41,813 (11%) observations are missing ethnicity
skim(arrests_juvenile)
arrests_juvenile %>% 
  group_by(group) %>% 
  skim()

# Aggregate arrests by agency and finish race construction
arrests_juvenile_agency <- arrests_juvenile %>%
  filter(age >= 10) %>%
  group_by(ori) %>%
  summarize(arr_total = n(),
            arr_prop = sum(property==1),
            arr_viol = sum(violent==1),
            age_10_14 = sum(age >= 10 & age <= 14),
            age_15_17 = sum(age >= 15 & age <= 17),
            race_aian = sum(race_of_arrestee == "american indian/alaskan native"),
            race_asian = sum(race_of_arrestee == "asian"),
            race_black = sum(race_of_arrestee == "black"),
            race_nhpi = sum(race_of_arrestee == "native hawaiian or other pacific islander"),
            race_unkno = sum(race_of_arrestee == "unknown"),
            race_white = sum(race_of_arrestee == "white"),
            ethn_hispanic = sum(ethnicity_of_arrestee == "hispanic origin"),
            ethn_nonhisp = sum(ethnicity_of_arrestee == "not of hispanic origin"),
            group_a = max(group=="A"),
            group_b = max(group=="B")
  ) %>%
  ungroup() %>%
  mutate(race_asian_other = race_aian + race_asian + race_nhpi)

```

776 agencies only have Group B arrests of juveniles
```{r}
arrests_juvenile_agency %>% 
  count(group_a, group_b)

```

Make narrow version with just needed variables
```{r}
arrests_juvenile_agency <- arrests_juvenile_agency %>%
  select(
    ori, 
    arr_total, 
    arr_viol, 
    arr_prop, 
    starts_with("race"), 
    ethn_hispanic
  )

```


## 2. Merge geographies

First load the universe of agencies linked to counties with weight for each county. This file was created in `01_agency_geo_county.Rmd`.
```{r}
agency_weights <- read_csv(here::here("07_safety", "modified data", "2022_agency_county.csv")) 

```

Now we can start with the full universe of agencies and merge on juvenile arrests
```{r}
arrests_juvenile_agency_geo <- agency_weights %>%
  left_join(arrests_juvenile_agency, by = "ori") %>%
  # Multiply stats by agency-county weight
  mutate(across(arr_total:ethn_hispanic, ~.x * weight))

```


## 3. Summarize by county

Aggregating agencies to counties results in 3,128 counties.
    todo(): this means we are missing 16 counties
```{r}
# Count number of arrests from reporting agencies in each county
arrests_juvenile_county <- arrests_juvenile_agency_geo %>%
  group_by(state, county) %>%
  summarize(across(arr_total:ethn_hispanic, ~sum(.x, na.rm=TRUE))) %>%
  mutate(GEOID = str_c(state, county)) %>%
  ungroup()

```


## 4. Calculate reporting rate for any arrest

```{r}
# Agencies may actually have zero juvenile arrests, so starting from full file
arrests_any <- arrests_ab %>%
  group_by(ori) %>%
  summarize(arr_total_any = n()) %>%
  ungroup()

```
Merge total number of arrests for each agency onto the county/agency weight file
```{r}
# Merge geography
arrests_any_agency_geo <- agency_weights %>%
  left_join(arrests_any, by = "ori")

arrests_any_agency_geo <- arrests_any_agency_geo %>%
  mutate(
    # Weight total arrest by county weight
    arr_total_any_wt = arr_total_any * weight,
    # Indicate reporting by county-agency
    reporting = ifelse(is.na(arr_total_any), 0, 1)
  )

```

Aggregate variables to the county level.
    todo(): Only 3,128 counties
```{r}
# Summarize by county. We want both an unweighted and weighted count of agencies reporting, as well as percentage reporting
arrests_any_county <- arrests_any_agency_geo %>%
  group_by(state, county) %>%
  summarize(n = n(), 
            n_wt = sum(weight), # check how weighted agencies compares to total agencies
            n_reporting = sum(reporting),
            n_reporting_wt = sum(reporting * weight),
            n_core_city = sum(core_city),
            n_core_city_rpt = sum(core_city==1 & reporting==1),
            across(arr_total_any, ~sum(.x, na.rm=TRUE))) %>%
  mutate(agencies_reporting = n_reporting / n,
         agencies_reporting_wt = n_reporting_wt / n_wt,
         core_reporting = n_core_city_rpt / n_core_city,
         core_reporting = ifelse(is.nan(core_reporting), NA, core_reporting),
         GEOID = str_c(state, county)) %>%
  ungroup()

```

todo(): original 2021 file - "rate of reporting better when calculate based on all arrests and include A & B" - not sure what this is referring to
```{r}
skim(arrests_any_county)

```

Merge total arrests (for ages 10-17) back to juvenile arrest file
```{r}
# All 3,128 observations match
arrests_juvenile_county <- arrests_juvenile_county %>%
  left_join(arrests_any_county, by = c("GEOID", "state", "county")) 

skim(arrests_juvenile_county)

```


## 5. Calculate rates

First load the demographic information for each county. This file was created using 2018-2022 5 year ACS data in `01_agency_geo_county.Rmd`.
```{r}
county_demo <- read_csv(here::here("07_safety", "modified data", "2022_county_demo.csv"))

```


Merge juvenile arrests onto county demographic file. 16 observations are missing from the juvenile arrests data. 6 of these observations are counties from Alaska, 9 are counties from Connecticut, and 1 is a county from Hawaii.
```{r}
ar_juv_county_demo <- county_demo %>%
  left_join(arrests_juvenile_county, by = "GEOID")

county_demo %>%
  anti_join(arrests_juvenile_county, by = "GEOID") %>% select(GEOID)

skim(ar_juv_county_demo)

```

```{r}
# Calculate arrest rates (per 100,000 people)
juv_arrest_by_county <- ar_juv_county_demo %>%
  mutate(
    juv_arrest_rate = arr_total / age_1017 * 100000,
    juv_arrest_rate_violent = arr_viol / age_1017 * 100000,
    juv_arrest_rate_property = arr_prop / age_1017 * 100000,
    juv_arrest_rate_white = race_white / age_1017_white * 100000,
    juv_arrest_rate_black = race_black / age_1017_black * 100000,
    #juv_arrest_rate_aian  = race_aian / age_1017_aian * 100000,
    juv_arrest_rate_asian_other = race_asian_other / age_1017_asian_other * 100000,
    #juv_arrest_rate_nhpi  = race_nhpi / age_1017_nhpi * 100000,
    juv_arrest_rate_hispanic  = ethn_hispanic / age_1017_hispanic * 100000
  )

```

Some rates have a value of `Infinity` if the denominator when calculating the rate is equal to 0. E.g., if a county has 0 Black people between the ages of 10 and 17 reported in the ACS, but a nonzero number of arrests, the Black juvenile arrest rate is infinity. However, we replace the rates of observations with a population less than 30 with `missing` which solves this issue.
    todo(): Why would the ACS report 0 population but NIBRS report a nonzero number of arrests for that group? Maybe if ACS is county of residence and NBIRS is county of arrest/offense?
```{r}
# Suppress data using populations < 30 people
juv_arrest_by_county <- juv_arrest_by_county %>%
  mutate(
    juv_arrest_rate = ifelse(age_1017 < 30, NA, juv_arrest_rate),
    juv_arrest_rate_violent = ifelse(age_1017 < 30, NA, juv_arrest_rate_violent),
    juv_arrest_rate_property = ifelse(age_1017 < 30, NA, juv_arrest_rate_property),
    juv_arrest_rate_white = ifelse(age_1017_white < 30, NA, juv_arrest_rate_white),
    juv_arrest_rate_black = ifelse(age_1017_black < 30, NA, juv_arrest_rate_black),
    #juv_arrest_rate_aian = ifelse(age_1017_aian < 30, NA, juv_arrest_rate_aian),
    juv_arrest_rate_asian_other = ifelse(age_1017_asian_other < 30, NA, juv_arrest_rate_asian_other),
    #juv_arrest_rate_nhpi = ifelse(age_1017_nhpi < 30, NA, juv_arrest_rate_nhpi),
    juv_arrest_rate_hispanic = ifelse(age_1017_hispanic < 30, NA, juv_arrest_rate_hispanic)
  )
```

todo(): The rates are per 100,000 people so, theoretically, none of the rates should exceed 100,000. However, there are some rates that do exceed 100,000. This occurs when there are more arrests for a group than reported population. I think this must be some kind of error then? Unless the arrests are recorded for county of arrest/offense rather than for arrestee's county of residence. Not sure how to treat these.
```{r}
# Check rates
juv_arrest_by_county %>%
  select(starts_with("juv_arrest_rate")) %>%
  skim()

test <- juv_arrest_by_county %>%
  select(GEOID, total_people, age_1017_black, race_black, juv_arrest_rate_black)

```


## 6. Make quality indicators

```{r}
# Compare all reporting plus core reporting
juv_arrest_by_county <- juv_arrest_by_county %>%
  mutate(all_juv_arrest_rate_quality = case_when(
    agencies_reporting == 1 ~ 1,
    agencies_reporting >= 0.8 ~ 2,
    agencies_reporting > 0 ~ 3,
    agencies_reporting == 0 ~ NA_real_),
    juv_arrest_rate_quality = case_when(
      agencies_reporting == 1 ~ 1,
      agencies_reporting >= 0.8 | core_reporting==1 ~ 2,
      agencies_reporting > 0 ~ 3,
      agencies_reporting == 0 ~ NA_real_),
    all_juv_arrest_rate_quality = ifelse(age_1017 < 30, NA, all_juv_arrest_rate_quality),
    juv_arrest_rate_quality = ifelse(age_1017 < 30, NA, juv_arrest_rate_quality)
  )
```


```{r}
# check distribution based on definition
juv_arrest_by_county %>%
  count(all_juv_arrest_rate_quality, juv_arrest_rate_quality)
# with core reporting, 228 counties move from 3 to 2

```


## 8. Save data
```{r}
juv_arrest_by_county_2022 <- juv_arrest_by_county %>%
  mutate(year=2022,
         across(starts_with("juv_arrest"), 
                ~ifelse(is.na(juv_arrest_rate_quality), NA, .x)),
         state_fips = ifelse(is.na(state_fips), str_sub(GEOID, 1, 2), state_fips),
         county = ifelse(is.na(county), str_sub(GEOID, 3, 5), county)) %>%
  select(c(year, state_fips, county, starts_with("juv_arrest"), starts_with("age_1017")))

skim(juv_arrest_by_county_2022)

```


```{r}
# file with only total juvenile arrest rates
juv_arrest_county_2022 <- juv_arrest_by_county_2022 %>%
  select(year, state_fips, county, juv_arrest_rate, juv_arrest_rate_violent,
         juv_arrest_rate_property, juv_arrest_rate_quality)

skim(juv_arrest_county_2022)
# todo(): from original 2021 file - "note 7 counties have 0 agencies, so NA for all metrics"
# write_csv(juv_arrest_county_2022, file = "07_safety/modified data/2022_juv_arrest_rate_county.csv")

```


```{r}
# long form file with juvenile arrest rates by subgroup
# pivot longer subgroup populations
# create all row with overall juvenile population and arrest rate
juv_pop_2022_subgroup <- juv_arrest_by_county_2022 %>%
  mutate(age_1017_all = age_1017) %>%
  select(year, state_fips, county, age_1017_all, age_1017_white, age_1017_black, age_1017_asian_other,
         age_1017_hispanic,
         juv_arrest_rate_quality) %>%
  pivot_longer(cols = contains("age_1017"),
               names_to = "subgroup",
               values_to = "age_1017",
               values_drop_na = TRUE,
               names_pattern = "age_1017_(.*)")

# pivot longer subgroup arrest rates
juv_arrest_2022_subgroup <- juv_arrest_by_county_2022 %>%
  mutate(juv_arrest_rate_all = juv_arrest_rate) %>%
  select(year, state_fips, county, juv_arrest_rate_all, juv_arrest_rate_white, juv_arrest_rate_black,
         juv_arrest_rate_asian_other, juv_arrest_rate_hispanic) %>%
  pivot_longer(cols = contains("juv_arrest_rate_"), 
               names_to = "subgroup",
               values_to = "juv_arrest_rate",
               values_drop_na = TRUE,
               names_pattern = "juv_arrest_rate_(.*)")

# combine into one file
# replace quality indicators with missing if subgroup population < 30
juv_arrest_county_2022_subgroup <- juv_pop_2022_subgroup %>%
  left_join(juv_arrest_2022_subgroup, by = c("year", "state_fips", "county", "subgroup")) %>%
  mutate(subgroup_type = "race-ethnicity",
         juv_arrest_rate_quality = ifelse(age_1017 < 30, NA, juv_arrest_rate_quality)) %>%
  select(-age_1017)

skim(juv_arrest_county_2022_subgroup)
juv_arrest_county_2022_subgroup %>% 
  count(juv_arrest_rate_quality, is.na(juv_arrest_rate))


# write_csv(juv_arrest_county_2022_subgroup, file = "07_safety/modified data/2022_juv_arrest_rate_county_subgroup.csv")
```












