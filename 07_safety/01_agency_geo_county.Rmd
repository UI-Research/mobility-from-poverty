---
title: "Agencies - County"
author: "Vincent Pancini"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output:
  html_document:
    number_sections: false
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    editor_options:
      chunk_output_type: console
---

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

The purpose of this program is to create files of county demographics and a universe of reporting agencies weighted by county.

```{r setup}
options(scipen = 999)

# library(urbnthemes)
library(tidyverse)
library(tidycensus)
library(skimr)
library(tidylog)

# set_urbn_defaults(style = "print")

```

todo(): delete this and include instructions for getting a key
```{r}
# set Census API once
# tidycensus::census_api_key("db0bd75bd829570bc973bd4b4fd66ed6f50b8371", install=TRUE, overwrite = TRUE)

```

Load county population data and filter to year of interest

    todo(): The project's `county-populations.csv` file was updated on the `main` branch after I already created this branch. I couldn't figure out how to get the updated file onto my branch, so in the meantime I manually downloaded it, moved it to the `07_safety\data` folder, and read it in from there.
    todo(): The file has 3,144 counties because Connecticut changed from 8 to 9 counties sometime between 2020-2022. Not sure what to do about that.
```{r, message=FALSE}
# todo(): check if this is the right file
# county populations file from Urban
pop <- read_csv(file = here::here("07_safety", "data", "county-populations.csv")) %>%
  filter(year==2022) %>%
  mutate(
    county_name = str_to_title(county_name),
    GEOID = str_c(state, county)
  )

```

# 1. Load and clean crime reporting agency data

## National Incident-based Reporting System (NIBRS)
The National Incident-based Reporting System (NIBRS) is a part of the Uniform Crime Reporting Program (UCR), administered by the Federal Bureau of Investigation (FBI). NIBRS is an annual data collection that compiles information on criminal incidents and arrests reported by participating law enforcement agencies. NIBRS data as formatted by the FBI are stored as a series of single files organized by various segment levels (record types). There are six main segment levels: administrative, offense, property, victim, offender, and arrestee.

The extract files version of the NIBRS files was created by ICPSR to simplify working with NIBRS data. These files are available for downnload from the National Archive of Criminal Justice Data (NACJD) available through ICPSR [here](https://www.icpsr.umich.edu/web/NACJD/studies/38566). 

Select `Download` and then select `Delimited` from the drop down menu. This will download a zip file titled `ICPSR_38566-V2`. Unzip the file, navigate to `ICPSR_38566\DS0001\38566-0001-Data.tsv`, and move it to the appropriate directory/folder. This is the `Batch Header File`.

```{r, message=FALSE}
# Read in the Batch Header File
batch_header_file <- read_tsv(here::here("07_safety", "data", "38566-0001-Data.tsv"))

```

Limit file to necessary variables and rename. We use the codebook (`ICPSR_38566\DS0001\38566-0001-Codebook`) to determine what each variable represents.
```{r}
batch_header_file <- batch_header_file %>%
  select(
    ori = BH003, # ori is unique agency identifier used across multiple files
    agency_type = BH012,
    state_num_nibrs = BH002,
    state_abb = BH008,
    city = BH007,
    core_city = BH013,
    fips_county_1 = BH054,
    fips_county_2 = BH055,
    fips_county_3 = BH056,
    fips_county_4 = BH057,
    msa_1 = BH021,
    msa_2 = BH025,
    msa_3 = BH029,
    msa_4 = BH033,
    msa_5 = BH037,
    pop_1 = BH019,
    pop_2 = BH023,
    pop_3 = BH027,
    pop_4 = BH031,
    pop_5 = BH035
  ) %>%
  mutate(year = 2022,
         pop_total = pop_1 + pop_2 + pop_3 + pop_4 + pop_5,
         city = str_to_title(city),
         # Edit NIBRS state and county variables to have two digits and three digits respectively
         state_num_nibrs = str_pad(state_num_nibrs, 2, pad = "0"),
         county = str_pad(fips_county_1, 3, pad = "0")
  ) %>%
  # Drop US territories - todo(): might want to read in list of counties and specifically filter using the list of states from that file
  filter(!state_abb %in% c("GM", "PR", "VI"))

```

The state identifiers that NIBRS has are state abbreviation and a state code. NIBRS state codes are in alphabetical order and do not follow FIPS codes. We manually create a crosswalk between state FIPS codes and NIBRS codes by looking at the codebook (`ICPSR_38566\DS0001\38566-0001-Codebook`) and then join state FIPS codes onto the Batch Header File.
```{r, message=FALSE}
# todo(): the original file originally merges a file called `nibrs_states.csv` onto the NIBRS data by `state_abb` and `state_num_nibrs`. My assumption is that the only variable this adds is `state_name`, because the original file then joins on a file called `pop_st` (created below) by `state_name` and the only extra variable is a state FIPS code. Since I don't have that original `nibrs_states.csv` file, I manually create a tribble that has both `state_name` and a state FIPS code that we can merge directly onto the NIBRS data. This also means that we don't need to create the `pop_st` file.
# Ideally we wouldn't have to manually create this "crosswalk" because manually entering everything introduces more room for error, but it makes more sense to me than the roundabout way from the original file. I have checked it carefully.
# # Filter Urban file to states so we can fix the state numbers in NIBRS data
# pop_st <- pop %>%
#   select(c(state, state_name)) %>%
#   distinct()

# Create "crosswalk" for NIBRS state codes to state FIPS codes.
nibrs_states <- tribble(
  ~state, ~state_abb, ~state_num_nibrs, ~state_name,
  "01",	"AL", "01", "Alabama",
  "02",	"AK", "50", "Alaska",
  "04",	"AZ", "02", "Arizona", 
  "05",	"AR", "03", "Arkansas",	
  "06",	"CA", "04", "California",	
  "08",	"CO", "05", "Colorado",
  "09",	"CT", "06", "Connecticut",
  "10",	"DE", "07", "Delaware",
  "11",	"DC", "08", "District of Columbia",
  "12",	"FL", "09", "Florida",
  "13",	"GA", "10", "Georgia",	
  "15",	"HI", "51", "Hawaii",
  "16",	"ID", "11", "Idaho",
  "17",	"IL", "12", "Illinois",
  "18",	"IN", "13", "Indiana",
  "19",	"IA", "14", "Iowa",	
  "20",	"KS", "15", "Kansas",	
  "21",	"KY", "16", "Kentucky",	
  "22",	"LA", "17", "Louisiana",
  "23",	"ME", "18", "Maine",
  "24",	"MD", "19", "Maryland",
  "25",	"MA", "20", "Massachusetts",
  "26",	"MI", "21", "Michigan",	
  "27",	"MN", "22", "Minnesota",	
  "28",	"MS", "23", "Mississippi",	
  "29",	"MO", "24", "Missouri",	
  "30",	"MT", "25", "Montana",	
  "31",	"NE", "26", "Nebraska",	
  "32",	"NV", "27", "Nevada",	
  "33",	"NH", "28", "New Hampshire",	
  "34",	"NJ", "29", "New Jersey",	
  "35",	"NM", "30", "New Mexico",	
  "36",	"NY", "31", "New York",	
  "37",	"NC", "32", "North Carolina",
  "38",	"ND", "33", "North Dakota",	
  "39",	"OH", "34", "Ohio",	
  "40",	"OK", "35", "Oklahoma",	
  "41",	"OR", "36", "Oregon",	
  "42",	"PA", "37", "Pennsylvania",	
  "44",	"RI", "38", "Rhode Island",	
  "45",	"SC", "39", "South Carolina",	
  "46",	"SD", "40", "South Dakota",
  "47",	"TN", "41", "Tennessee",
  "48",	"TX", "42", "Texas",	
  "49",	"UT", "43", "Utah",	
  "50",	"VT", "44", "Vermont",	
  "51",	"VA", "45", "Virginia",	
  "53",	"WA", "46", "Washington",	
  "54",	"WV", "47", "West Virginia",	
  "55",	"WI", "48", "Wisconsin",	
  "56",	"WY", "49", "Wyoming"
)

# The NIBRS data abbreviates Nebraska as "NB" instead of its correct abbreviation "NE"
batch_header_file <- batch_header_file %>%
  mutate(state_abb = if_else(state_abb=="NB", "NE", state_abb))

# Join state FIPS codes and full state name onto the NIBRS data
batch_header_file <- batch_header_file %>% 
  left_join(
    y = nibrs_states, by = c("state_abb", "state_num_nibrs")
  )
```

There are 51 unique combinations of `state`/`state_name`/`state_abb`/`state_num_nibrs`, so the manual crosswalk does not seem to have any errors
```{r, message=FALSE}
batch_header_file %>%
  group_by(state, state_name, state_abb, state_num_nibrs) %>%
  summarize()

```


Check distribution of agency types. The agency types are as follows:

| Value | Label                     |
|:-----:|:--------------------------|
|   0   | Covered by another agency |
|   1   | City                      |
|   2   | County                    |
|   3   | University or college     |
|   4   | State Police              |
|   5   | Special Agency            |
|   6   | Other state agencies      |
|   7   | Tribal agencies           |
|   8   | Federal agencies          |

```{r}
batch_header_file %>%
  count(agency_type) %>%
  mutate(percent = n/nrow(batch_header_file))

```

State agencies cover multiple counties, so we remove these agencies for simplicity
```{r}
batch_header_file <- batch_header_file %>%
  filter(!agency_type %in% c(4, 6))

```

253 observations have a county FIPS value of zero
    todo(): original code highlighted DC and Baltimore as counties that have a value of zero, but I'm not sure why. 
```{r}
# Examine NIBRS agency information
sum(batch_header_file$fips_county_1 == "0")

# Subset data to examine further
bhf_missing_county <- batch_header_file %>%
  filter(fips_county_1==0)

```

## Law Enforcement Agency Identifiers Crosswalk (LEAIC)
To address the agencies that are missing county information, we use the Law Enforcement Agency Identifiers Crosswalk (LEAIC), which facilitates linking reported crime data with socio-economic data. The LEAIC file is available for download from the National Archive of Criminal Justice Data (NACJD) available through ICPSR [here](https://www.icpsr.umich.edu/web/NACJD/studies/35158).  

Select `Download` and then select `Delimited` from the drop down menu. This will download a zip file titled `ICPSR_35158-V2`. Unzip the file, navigate to `ICPSR_35158\DS0001\35158-0001-Data.tsv`, and move it to the appropriate directory/folder. 

```{r}
# Read in the Law Enforcement Agency Identifiers Crosswalk
leaic <- read_tsv(here::here("07_safety", "data", "35158-0001-Data.tsv"))

```

232 of the 253 agencies with missing county information are in the LEAIC
```{r}
sum(bhf_missing_county$ori %in% leaic$ORI9)

```

Limit file to necessary variables and rename. We use the codebook (`ICPSR_35158\DS0001\35158-0001-Codebook`) to determine what each variable represents.
```{r}
leaic <- leaic %>%
  select(
    ori = ORI9,
    county = FIPS_COUNTY
  ) %>%
  # Remove agencies with invalid ORI
  filter(ori != "-1") # Not in UCR/NCIC 

```









21 agencies still have no county after using the county information from LEAIC. All of these observations are tribal or special agencies.
```{r}
bhf_missing_county <- bhf_missing_county %>%
  select(-county) %>%
  left_join(leaic, by = "ori")

bhf_missing_county %>%
  filter(is.na(county)) %>%
  count(agency_type)

```

## Final agency data
Replace county information in NIBRS data for observations that initially had a county value of "0" with the updated county information from LEAIC.
```{r}
batch_header_file <- batch_header_file %>%
  # Drop the 253 NIBRS agencies with county value of 0
  filter(fips_county_1 != 0) %>%
  # Append those 253 agencies back onto main data with the county info gleaned from LEAIC
  bind_rows(bhf_missing_county)

batch_header_file <- batch_header_file %>%
  # Drop the 21 NIBRS agencies that had no county info in LEAIC
  filter(!is.na(county)) %>%
  # Assign county fips from LEAIC to the NIBRS county fips variable
  mutate(fips_county_1 =  county)

# Remove obsolete files
rm(leaic, bhf_missing_county)

```


# Load county-level demographics

Check 2022 ACS variables
```{r}
variables2022 <- tidycensus::load_variables(2022, "acs5")

```

Pull 2022 ACS data at the Census county level. Note that the `two or more race` variable is not appearing and may not be available at the county level
```{r}
county_demo <- tidycensus::get_acs(
  geography = "county",
  variables = c(
    total_people = "B01003_001",
    age_m_1014 = "B01001_005", 
    age_m_1517 = "B01001_006",
    age_f_1014 = "B01001_029", 
    age_f_1517 = "B01001_030",
    age_m_1014_white = "B01001A_005", 
    age_m_1014_black = "B01001B_005",
    age_m_1014_aian = "B01001C_005", 
    age_m_1014_asin = "B01001D_005",
    age_m_1014_nhpi = "B01001E_005", 
    age_m_1014_othr = "B01001F_005",
    age_m_1014_twom = "B01001G_005",
    age_m_1014_white_nh = "B01001H_005",
    age_m_1014_hispanic = "B01001I_005",
    age_m_1517_white = "B01001A_006", 
    age_m_1517_black = "B01001B_006",
    age_m_1517_aian = "B01001C_006", 
    age_m_1517_asin = "B01001D_006",
    age_m_1517_nhpi = "B01001E_006", 
    age_m_1517_othr = "B01001F_006",
    age_m_1517_twom = "B01001G_006",
    age_m_1517_white_nh = "B01001H_006", 
    age_m_1517_hispanic = "B01001I_006",
    age_f_1014_white = "B01001A_020", 
    age_f_1014_black = "B01001B_020",
    age_f_1014_aian = "B01001C_020", 
    age_f_1014_asin = "B01001D_020",
    age_f_1014_nhpi = "B01001E_020", 
    age_f_1014_othr = "B01001F_020",
    age_f_1014_twom = "B01001G_020",
    age_f_1014_white_nh = "B01001H_020",
    age_f_1014_hispanic = "B01001I_020",
    age_f_1517_white = "B01001A_021", 
    age_f_1517_black = "B01001B_021",
    age_f_1517_aian = "B01001C_021", 
    age_f_1517_asin = "B01001D_021",
    age_f_1517_nhpi = "B01001E_021",
    age_f_1517_othr = "B01001F_021",
    age_f_1517_twom = "B01001G_021",
    age_f_1517_white_nh = "B01001H_021", 
    age_f_1517_hispanic = "B01001I_021"
  ),
  year = 2022,
  survey = "acs5",
  output = "wide",
  geometry = FALSE
)

# Remove obsolete files
rm(variables2022)

```

Clean variable names and drop MOEs
```{r}
county_demo <- county_demo %>%
  rename_with(~ sub("E$", "", .x), everything()) %>%
  select(-c(ends_with("M")))

```

Construct age and race/ethnicity groups
```{r}
county_demo <- county_demo %>%
  mutate(
    age_1017 = age_m_1014 + age_m_1517 + age_f_1014 + age_f_1517,
    age_1017_white = age_m_1014_white + age_m_1517_white + age_f_1014_white + age_f_1517_white,
    age_1017_black = age_m_1014_black + age_m_1517_black + age_f_1014_black + age_f_1517_black,
    age_1017_aian = age_m_1014_aian + age_m_1517_aian + age_f_1014_aian + age_f_1517_aian,
    age_1017_asin = age_m_1014_asin + age_m_1517_asin + age_f_1014_asin + age_f_1517_asin,
    age_1017_nhpi = age_m_1014_nhpi + age_m_1517_nhpi + age_f_1014_nhpi + age_f_1517_nhpi,
    age_1017_othr = age_m_1014_othr + age_m_1517_othr + age_f_1014_othr + age_f_1517_othr,
    # age_1017_twom = age_m_1014_twom + age_m_1517_twom + age_f_1014_twom + age_f_1517_twom,
    age_1017_hispanic = age_m_1014_hispanic + age_m_1517_hispanic + age_f_1014_hispanic + age_f_1517_hispanic,
    age_1017_white_nh = age_m_1014_white_nh + age_m_1517_white_nh + age_f_1014_white_nh + age_f_1517_white_nh,
  )

```

Some additional cleaning restricts observations from 3,221 counties to 3,144
    todo(): Where is this extra county coming from?
```{r}
# Limit to relevant variables
county_demo <- county_demo %>%
  select(GEOID, total_people, starts_with("age_1017"))

# Limit counties to those in the Urban file 
county_demo <- county_demo %>%
  filter(GEOID %in% pop$GEOID)
  
# Edit race variables  
county_demo <- county_demo %>%  
  mutate(
    year=2022,
    # Manually create "two or more" race variable
    age_1017_twom = age_1017 - age_1017_white - age_1017_black - 
      age_1017_aian - age_1017_asin - age_1017_nhpi - age_1017_othr,
    # Combine all asian races, other races. and two or more races
    age_1017_asian_other = age_1017_aian + age_1017_asin + age_1017_nhpi +
      age_1017_othr + age_1017_twom
  )
  
```


# Make county-level file

676 agencies cover 2 counties and 60 agencies cover 3 counties
```{r}
sum(!is.na(batch_header_file$fips_county_2))
sum(!is.na(batch_header_file$fips_county_3))

```


The NIBRS data are currently wide by `ori` (agency), such that there is one observation for each agency with variables for the FIPS code and population size of each county served by that agency. Instead, we want the data long by `ori` and `county` such that each observation represents each unique `ori` and `county` pair.
```{r}
# Reshape NIBRS data from wide to long
batch_header_file <- batch_header_file %>%
  mutate(across(starts_with("fips"), ~str_pad(., 3, pad = "0"))) %>%
  select(c(ori, state, core_city, agency_type, starts_with("fips"))) %>%
  pivot_longer(-c(ori, state, core_city, agency_type), values_to = "county")

# Remove observations that are not relevant to more that one county
batch_header_file <- batch_header_file %>%
  filter(!is.na(county))

```

If we try to join the 2022 county population and demographics onto the NIBRS data, 117 observations are only in the NIBRS data, and 16 observations are only in the ACS data.
```{r}
test <- batch_header_file %>%
  mutate(GEOID = str_c(state, county)) %>%
  left_join(select(county_demo, c(GEOID, total_people)), by = "GEOID")

```

112 of the observations unmatched from NIBRS are Connecticut because of the county change.
    todo(): What to do about Connecticut
```{r}
anti_join(batch_header_file %>% mutate(GEOID = str_c(state, county)),
                   county_demo, by = "GEOID") %>%
  group_by(state) %>%
  count()

```

The other 5 unmatched observations are from Valdez-Cordova Census Area, AK - 02261 (3) and Shannon County, SD - 46113 (2). Valdez-Cordova Census Area, AK was split to form Chugach Census Area (FIPS Code = 02063) and Copper River Census Area (FIPS Code = 02066) effective 2019-01-02 ([source](https://www.cdc.gov/nchs/nvss/bridged_race/county_geography-_changes1990-present.pdf)). Shannon County was renamed to Oglala Lakota County (FIPS Code = 46102) in 2015 ([source](https://www.ddorn.net/data/FIPS_County_Code_Changes.pdf)).
    todo(): For now I am just ignoring these observations, but may want to do something about them.
```{r}
anti_join(batch_header_file %>% mutate(GEOID = str_c(state, county)) %>% filter(state != "09"),
                   county_demo, by = "GEOID") %>%
  group_by(GEOID) %>%
  count()

```

Of the 16 counties from the ACS that didn't have a match in NIBRS, 6 are in Alaska, 9 are in Connecticut, and 1 is in Hawaii (Kalawao County, HI). Some of these may just be counties that did not have reporting agencies.
    todo(): Address these if necessary (CT and AK if counties changed)
```{r}
anti_join(county_demo,
                   batch_header_file %>% mutate(GEOID = str_c(state, county)),
                   by = "GEOID") %>%
  group_by(GEOID) %>%
  count()

```


Join the 2022 county population and demographics onto the NIBRS data
```{r}
rm(test)

batch_header_file <- batch_header_file %>%
  mutate(GEOID = str_c(state, county)) %>%
  left_join(select(county_demo, c(GEOID, total_people)), by = "GEOID")

```



todo(): From original 2021 file: "5 agencies (2 counties) not in file, will drop"
```{r}
skim(batch_header_file)

```

For agencies that cover multiple counties, assign weight based on county population (e.g., if Agency A has jurisdiction in both County 1 which has 10,000 people and County 2 which has 5,000 people, the weights will be 0.667 and 0.333, respectively)
```{r}
# Make agency weights based on population of counties they cover
batch_header_file <- batch_header_file %>%
  filter(!is.na(total_people)) %>%  
  group_by(ori) %>%
  mutate(weight = total_people / sum(total_people)) %>%
  ungroup()

```

Limit to counties in Urban file
```{r}
batch_header_file <- batch_header_file %>%
  filter(GEOID %in% pop$GEOID)

```

Count number of agencies in each county.
    todo(): Right now we only have agency information for 3,128 counties.
```{r}
county_agency <- batch_header_file %>%
  group_by(state, county) %>%
  summarize(n_agencies = n_distinct(ori),
            n_core_city = sum(core_city==1),
            core_city = max(core_city),
            n_agen_city = sum(agency_type==1),
            n_agen_cnty = sum(agency_type==2),
            n_agen_univ = sum(agency_type==3),
            n_agen_spcl = sum(agency_type==5),
            n_agen_trbl = sum(agency_type==7)) %>%
  ungroup() %>%
  mutate(GEOID = str_c(state, county))

```


todo(): Check county-level data. Cook County has 171 non-state and non-federal agencies; Allegheny has 135
```{r}
skim(county_agency)

```



# Combine county-level agency and demographic information

16 observations are in the ACS data but not the NIBRS data. 
```{r}
joined_data <- county_demo %>%
  left_join(county_agency, by = "GEOID")

```

Make sure the data are limited to only counties in the Urban file
```{r}
joined_data <- joined_data %>%
  filter(GEOID %in% pop$GEOID)
  
```

16 counties have no agencies (or, at least, they're not present in the NIBRS data). These include 9 Connecticut counties with large populations, 6 Alaska counties with small populations, and 1 Hawaii county with a small population.
```{r}
joined_data %>%
  filter(is.na(n_agencies)) %>%
  select(GEOID, total_people, n_agencies, state, county)

```


# Write out files

Write out county demographics only
```{r}
write_csv(county_demo, file = "modified data/2022_county_demo.csv")

```

Write out county demographics plus agency info
```{r}
write_csv(joined_data, file = "modified data/2022_county_demo_agency.csv")

```

Write out agency-county level file with weights
```{r}
write_csv(batch_header_file, file = "modified data/2022_agency_county.csv")

```



