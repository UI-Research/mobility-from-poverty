---
title: "Access to Health Services"
author: "Vincent Pancini"
editor_options: 
  chunk_output_type: console
---

```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r setup}
# library(urbnthemes)
library(tidyverse)
library(haven)
library(rvest)
library(glue)
library(fs)
library(tidycensus)

# set_urbn_defaults(style = "print")

options(scipen = 999)

```

This metric represents the number of individuals served by one primary care physician in a county, if the population was equally distributed across physicians. Primary care physicians include practicing non-federal physicians (M.D.s and D.O.s) under age 75 specializing in general practice medicine, family medicine, internal medicine, and pediatrics. It does not include nurse practitioners, physician assistants, or other practitioners available for primary care services. It also does not include hospital residents.

For 2022, we used data from [County Health Rankings](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?year=2022) for this metric, which used data from 2019. 

For 2023, we want to use the underlying source data used by CHR, which is the [Area Health Resource File, 2022-2023 County Level Data](https://data.hrsa.gov/data/download?data=AHRF#AHRF). The Area Health Resource File is a collection of data from more than 50 sources, including the American Medical Association, which maintains the Physician Masterfile. The Physician Masterfile contains information on nearly all the Doctors of Medicine and Doctors of Osteopathic Medicine in the nation.
    Note that when starting this round of updates we were using the 2021-2022 file, but the newer version has since been released, so I pivoted to using the most recent version. This version included several updates form previous versions, including separating the main file into separate sub-files and applying different naming conventions to variables.

Also note that we initially thought we would be able to disaggregate this metric by sex of provider and look at the ratio of population to primary care physicians by sex. The County Health Rankings website also implies that this is possible in their [methods section](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?year=2023). However, this does not seem possible upon further inspection of the AHRF data. 

The main variable for primary care physicians has the following restrictions:
    - INCLUDES practicing non-federal physicians (both M.D.s and D.O.s)
        - under age 75
        - specializing in general practice medicine, family medicine, internal medicine, and pediatrics
    - EXCLUDES nurse practitioners, physician assistants, or other practitioners available for primary care services
    - EXCLUDES hospital residents
    
This variable is not available by sex. We also cannot construct this variable by sex based on other variables. For instance, AHRF does have separate variables for Total MDs, Inactive MDs, Total DOs, and Inactive DOs (all non-federal) by sex. However, taking the sum of these variables by sex would still include physicians over the age of 75, and all specialties. There are also variables for MDs by specialty and age, but not by sex. 

Lastly, these data are unavailable at teh Census place-level. County is the smallest geography available.



## 1. Download data
The data for this metric come from the [Area Health Resource File 2022-2023 County-Level Data](https://data.hrsa.gov/data/download). 

Our latest version of this metric used 2019 data, so we are pulling both 2020 and 2021 (most recent).
```{r}
# Read in the AHRF health professions file
ahrf2023_hp <- read.csv(here::here("04_health", "access-health-services", "data", "AHRF_CSV_2022-2023", "DATA", "CSV Files by Categories", "ahrf2023HP.csv"))

# Read in the AHRF population file
ahrf2023_pop <- read.csv(here::here("04_health", "access-health-services", "data", "AHRF_CSV_2022-2023", "DATA", "CSV Files by Categories", "ahrf2023POP.csv"))

# Join the population file to the health professions file
ahrf2023 <- ahrf2023_hp %>%
  left_join(y = ahrf2023_pop, by = c("fips_st_cnty", "cnty_name_st_abbrev"))

# Clean geography variables
ahrf2023 <- ahrf2023 %>%
  rename(GEOID = fips_st_cnty,
         county_name = cnty_name_st_abbrev) %>%
  mutate(
    GEOID = as.character(GEOID),
    GEOID = str_pad(GEOID, 5, pad = "0"),
    state = str_sub(GEOID, 1, 2),
    county = str_sub(GEOID, 3, 5)
  ) %>%
  separate(
    col = county_name,
    into = c("county_name", "state_abb"),
    sep = ", ",
    remove = TRUE
  )

# Remove US territories
ahrf2023 <- ahrf2023 %>%
  filter(
    !state %in% c('66', '72', '78')
  )

```


Subset data to the variables necessary for this metric
```{r}
# We only need the number of PCPs and total population for 2020 and 2021
my_data <- ahrf2023 %>%
  select(
    GEOID, state, county, county_name, state_abb,
    pc_physicians_21 = phys_nf_prim_care_pc_exc_rsdt_21,
    pc_physicians_20 = phys_nf_prim_care_pc_exc_rsdt_20,
    pop21 = popn_est_21,
    pop20 = cens_popn_20,
  )

```


## 2. Create ratios

We create the ratio of population to primary care physicians by dividing the total population by the number of primary care physicians in each year. The variable is just the antecedent of the ratio, which represents the number of people for 1 primary care physician. If there are 0 primary care physicians in a county, we assign a value of 0. 

We also create a flag for counties with less than 2,000 people to indicate low population.
    todo(): CHR reports a missing value for counties with population greater than 2,000 and 0 primary care physicians. It is kind of unclear to me why they do that... maybe because they think the "0 PCPs" could be a reporting error for counties with a decent-sized population?
```{r}
# Create the ratio and a flag for counties with low population
my_data <- my_data %>%
  mutate(
    # 2021
    pc_phys_ratio_21 = case_when(
      pc_physicians_21 > 0 ~ round(pop21/pc_physicians_21),
      pc_physicians_21 == 0 ~ 0
      ),
    low_pop_flag_21 = case_when(
      pop21 < 2000 ~ "1",
      pop21 >= 2000 ~ "0"
    ),
    # 2020
    pc_phys_ratio_20 = case_when(
      pc_physicians_20 > 0 ~ round(pop20/pc_physicians_20),
      pc_physicians_20 == 0 ~ 0
      ),
    low_pop_flag_20 = case_when(
      pop20 < 2000 ~ "1",
      pop20 >= 2000 ~ "0"
    )
  )

```


## 3. Check against County Health Rankings Data

We can use the County Health Rankings data as a reference point to verify our findings. The 2023 County Health Rankings used data from 2020 for this measure, so we will use our 2020 ratio.

I am checking our numbers against the County Health Rankings [data](https://www.countyhealthrankings.org/explore-health-rankings/rankings-data-documentation). These data define primary care physicians as practicing non-federal physicians (M.D.s and D.O.s) under age 75 specializing in general practice medicine, family medicine, internal medicine, and pediatrics [source](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?year=2023).
```{r}
# Read in CHR data and filter to variables for this metric
chr2023 <- readxl::read_excel(
  path = here::here("04_health", "access-health-services", "data", "2023 County Health Rankings Data - v2.xlsx"),
  sheet = "Ranked Measure Data",
  # range = "Ranked Measure Data!A1:DN3195",
  skip = 1,
  col_names = TRUE
) %>%
  select(
    GEOID = "FIPS",
    state_name = State,
    county_name = County,
    # Number of primary care physicians (PCP) in patient care
    pc_physicians_chr = "# Primary Care Physicians",
    # Primary Care Physicians per 100,000 population
    pc_physicians_rate_chr = "Primary Care Physicians Rate", 
    # Population to Primary Care Physicians ratio
    pc_physicians_ratio_chr = "Primary Care Physicians Ratio",
  ) %>%
  filter(!is.na(county_name))

# The CHR metric is reported as an actual ratio, so we split the ratio into its parts
chr2023 <- chr2023 %>%
  separate(col = pc_physicians_ratio_chr,
           into = c('antecedent', 'consequent'),
           remove = FALSE)

# The CHR data does not include population. However, we can try to "impute" population by multiplying the antecedent portion of the ratio by the number of PCPs
chr2023 <- chr2023 %>%
  mutate(
    antecedent = as.numeric(antecedent),
    consequent = as.numeric(consequent),
    pop20_imp = if_else(consequent==1, antecedent*pc_physicians_chr, antecedent)
    )

# Now we can compare the CHR data to our findings from AHRF
joined_data <- my_data %>%
  select(GEOID, pc_physicians_20, pop20, pc_phys_ratio_20, low_pop_flag_20) %>%
  left_join(y = chr2023 %>% select(-c(state_name, county_name)), by = "GEOID") %>%
  mutate(
    pop_diff = pc_phys_ratio_20 - antecedent,
    total_pop_diff = pop20 - pop20_imp,
    pc_diff = pc_physicians_20 - pc_physicians_chr
  )

# Our number of PCPs from AHRF match CHR, but population is different. The differences in population look too big to be rounding errors
joined_data %>%
  select(pop_diff, total_pop_diff, pc_diff) %>%
  skim()

```


It is unclear what population data CHR used to calculate this metric, but the 2020 population data in AHRF comes from the 2020 census redistricting data file.  
```{r}
# Explore variable names in 2020 decennial Census to find population variable name
decennial_2020_vars <- load_variables(
                              year = 2020, 
                              "pl", 
                              cache = TRUE
                             )

# The variable name is `P2_001N`
pop20_decennial <- tidycensus::get_decennial("county", year = 2020, variables = "P2_001N")

# Remove PR observations
pop20_decennial <- pop20_decennial %>%
  # Drop PR observations
  filter(!str_detect(GEOID, '^72')) %>%
  select(GEOID,
         population = value)

# Join this pop data onto the AHRF pop data to check
check_pop <- my_data %>%
  select(GEOID, pop20) %>%
  left_join(y = pop20_decennial, by = "GEOID") %>%
  mutate(pop_diff = abs(pop20 - population))

# The AHRF 2020 population data is consistent with the 2020 Census population data.
max(check_pop$pop_diff, na.rm = TRUE)

# CHR may have used 2020 data from the Population Estimates Program, which is released before the 2020 Census
pop20_pep <- tidycensus::get_estimates("county", year = 2020, variables = "POPESTIMATE") %>%
  select(GEOID,
         population = value)

# Join PEP population data onto CHR
check_pop <- chr2023 %>%
  left_join(y = pop20_pep, by = "GEOID")

# todo(): show work for checking that CHR doesn't use the PEP data either. I visually inspected and know that this isn't the case.

```


```{r}
# mutate(pc_physicians_ratio_chr = case_when(consequent == "1" ~ pc_physicians_ratio_chr,
  #                                            consequent == "0" ~ "0",
  #                                            is.na(pc_physicians_ratio_chr) ~ "0"),
  #        antecedent = as.numeric(antecedent)
  # )

joined_data <- ahrf2023 %>%
  select(-c(pc_physicians_21, pop21, pc_phys_ratio_21, low_pop_flag_21)) %>%
  full_join(
    y = chr2023 %>% select(-county_name), by = "GEOID"
  ) %>%
  mutate(pop_diff = pc_phys_ratio_20 - antecedent,
         pop_diff_lapi = pc_phys_ratio_20_lapi - antecedent,
         pc_diff = pc_physicians_20 - pc_physicians_chr)

sum(joined_data$pop_diff)

ahrf_pop2023 <- ahrf_pop2023 %>%

    pop20_lapi = popn_20
  )

,
    # 2020 using LAPI pop
    pc_phys_ratio_20_lapi = case_when(
      pc_physicians_20 > 0 ~ round(pop20_lapi/pc_physicians_20),
      pc_physicians_20 == 0 ~ 0
      )

```


First we need to get population estimates from the US Census Bureau Population Estimation Program. # Replace YOUR-KEY-HERE below with your unique Census API key. Request a key at https://api.census.gov/data/key_signup.html if you don't have one.
```{r}
# census_api_key("YOUR-KEY-HERE")

test <- tidycensus::load_variables(2020, "acs5", cache = TRUE)

popv2 <- tidycensus::get_acs("county", year = 2020, variables = "B01001_001")

decennial_2020_vars <- load_variables(
                              year = 2020, 
                              "pl", 
                              cache = TRUE
                             )



pop <- pop %>%
  # Drop PR observations
  filter(!str_detect(fips, '^72')) %>%
  select(fips,
         population = value)

test <- left_join(
  x = joined_data, y = popv2, by = "GEOID"
)

test <- test %>%
  mutate(test = estimate/pc_physicians_chr)

```



```{r}
# TODO: figure out how to download the data directly from the website in R
ahrf2022 <- haven::read_sas(here::here("04_health", "access-health-services", "ahrf2022.sas7bdat"))

ahrf2022 <- ahrf2022 %>%
  select(
    f00002, # state/county fips
    f00008, # state name
    f12424, # state abbreviation
    f00010, # county name
    f00011, # state fips code
    f00012, # county fips code
    f1198421, # population estimate, 2021
    f0453020, # census population, 2020
    f1198420, # population estimate, 2020
    f1467520, # phys, primary care, patient care - non-fed, excludes hospital residents & 75+
    
    f1390620, # pop total male, 2020, whole numbers, estimates, census county char file 
    f0482020, # Total MDs, male, non-fed, includes inactive
    f1470020, # Total DOs, male, non-fed, includes inactive
    f0490020, # MDs, inactive, male (non-fed)
    f1470220, # DOs, inactive, male (non-fed)
    
    f1390720, # pop total male, 2020, whole numbers, estimates, census county char file
    f0482120, # Total MDs, female, non-fed, includes inactive
    f1470120, # Total DOs, female, non-fed, includes inactive
    f0490120, # MDs, inactive, female (non-fed)
    f1470320, # DOs, inactive, female (non-fed)
  ) %>%
  filter(
    !f00011 %in% c('66', '72', '78')
  )

ahrf2022 <- ahrf2022 %>%
  mutate(
    male_pcp = (f0482020 + f1470020 - f0490020 - f1470220),
    fmle_pcp = (f0482120 + f1470120 - f0490120 - f1470320)
  ) %>%
  select(
    county_fips = f00002,
    state_fips = f00011,
    tot_pop_2020 = f0453020,
    tot_pcp = f1467520,
    male_pop_2020 = f1390620,
    fmle_pop_2020 = f1390720,
    male_pcp,
    fmle_pcp
  )


# Even after filtering out Guam, Puerto Rico, and the Virgin Islands, there seem to be 7 extra counties. I suspect these are weird Alaska counties
count(ahrf2022, state_fips) %>% view()

```


```{r}
# TODO: remove SAS labels from variables
ahrf2022 <- ahrf2022 %>%
  mutate(
    pc_phys_ratio = case_when(
      pc_physicians > 0 ~ round(population/pc_physicians, 1),
      pc_physicians == 0 ~ 0),
    low_pop_flag = case_when(
      population < 2000 ~ "1",
      population >= 2000 ~ "0"
    )
  )

```


I am checking our numbers against the County Health Rankings [data](https://www.countyhealthrankings.org/explore-health-rankings/rankings-data-documentation). These data define primary care physicians as practicing non-federal physicians (M.D.s and D.O.s) under age 75 specializing in general practice medicine, family medicine, internal medicine, and pediatrics [source](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?year=2023).
```{r}
chr2023_counties <- readxl::read_excel(
  path = here::here("04_health", "access-health-services", "data", "2023 County Health Rankings Data - v2.xlsx"),
  range = "Ranked Measure Data!A2:C3195"
) %>%
  mutate(
    ID = row_number()
  )

chr2023_data <- readxl::read_excel(
  path = here::here("04_health", "access-health-services", "data", "2023 County Health Rankings Data - v2.xlsx"),
  range = "Ranked Measure Data!DK2:DN3195"
) %>%
  mutate(
    ID = row_number()
  )

chr2023 <- left_join(
  x = chr2023_counties, y = chr2023_data, by = "ID"
) %>%
  filter(!is.na(County)) %>%
  select(
    GEOID = "FIPS",
    pc_physicians_chr = "# Primary Care Physicians",
    pc_physicians_rate_chr = "Primary Care Physicians Rate",
    pc_physicians_ratio_chr = "Primary Care Physicians Ratio",
    pc_physicians_quartile_chr = "Quartile"
  )

rm(chr2023_counties, chr2023_data)  

chr2023 <- chr2023 %>%
  separate(col = pc_physicians_ratio_chr,
           into = c('antecedent', 'consequent'),
           remove = FALSE) %>%
  mutate(pc_physicians_ratio_chr = case_when(consequent == "1" ~ pc_physicians_ratio_chr,
                                             consequent == "0" ~ "0",
                                             is.na(pc_physicians_ratio_chr) ~ "0"),
         antecedent = as.numeric(antecedent)
  )

joined_data <- joined_data %>%
  full_join(
    x = ahrf2023, y = chr2023, by = "GEOID"
  ) %>%
  mutate(diff = pc_phys_ratio-antecedent)

```



## 1. Prepare for file download
```{r}
base_url <- "https://www.countyhealthrankings.org"

url <- paste0(base_url, "/explore-health-rankings/rankings-data-documentation")

download_urls <-
  read_html(url) %>% 
  html_elements('span.field-content') %>%  
  html_element('a') %>% 
  html_attr('href') %>%
  paste0(base_url, .)

out_state <-
  read_html(url) %>% 
  html_elements('span.field-content') %>% 
  html_text2() %>% 
  str_replace_all(' ', '-')

get_state_data_url <- function(url){
  read_html(url) %>% 
    html_elements('span.download-link') %>% 
    html_element('a') %>% 
    html_attr('href') %>% 
    str_subset('.xls') %>% 
    str_subset('2022') %>% 
    paste0(base_url, .)
}

state_data_url <- purrr::map_chr(.x = download_urls, .f = get_state_data_url)

```


## 2. Download files

Download all 51 Excel files from each state's URL
```{r}
# # create a data folder for intermediate data files
# intermediate_files <- here::here("04_health",
#                                  "access-health-services",
#                                  "data/")
# 
# if (!dir.exists(intermediate_files)) {
#   
#   dir.create(intermediate_files)
#   
# }
# 
# chr_data <- here::here("04_health",
#                        "access-health-services",
#                        "data",
#                        out_state
# )
# 
# download_data <- function(state_data_url, state_name){
#   if (!file.exists(here::here(glue("04_health/access-health-services/data/{state_name}.xlsx")))) {
#     
#     download.file(state_data_url, 
#                   destfile = here::here(glue("04_health/access-health-services/data/{state_name}.xlsx")))
#     
#   }
# }
# 
# walk2(state_data_url, out_state, download_data)

```


## 3. Read in, clean, and append each Excel sheet
```{r, message = FALSE}
physicians <- map_dfr(out_state,
                     ~{readxl::read_excel(path = here::here(
                       paste0('04_health/access-health-services/data/', .x, '.xlsx')),
                       sheet = 'Ranked Measure Data',
                       skip = 1
                     ) %>%
                         select(fips = 'FIPS',
                                pc_phys_ratio = 'Primary Care Physicians Ratio',
                                number_pc_phys = '# Primary Care Physicians',
                                pc_phys_rate = 'Primary Care Physicians Rate'
                                ) %>%
                         filter(!str_detect(fips, '000$')) %>%
                         mutate(state = str_sub(fips, 1, 2),
                                county = str_sub(fips, 3, 5)
                                )
                     }
)

```

```{r}
physicians <- physicians %>%
  separate(col = pc_phys_ratio,
           into = c('antecedent', 'consequent'),
           remove = FALSE) %>%
  mutate(pc_phys_ratio = case_when(consequent == "1" ~ pc_phys_ratio,
                                   consequent == "0" ~ "0",
                                   is.na(pc_phys_ratio) ~ "0"),
         year = 2019
         )

```


## 4. Add data quality flags

First we need to get population estimates from the US Census Bureau Population Estimation Program. # Replace YOUR-KEY-HERE below with your unique Census API key. Request a key at https://api.census.gov/data/key_signup.html if you don't have one.
```{r}
# census_api_key("YOUR-KEY-HERE")

pop <- tidycensus::get_estimates("county", year = 2019, variables = "POP") %>%
  rename(fips = GEOID)

pop <- pop %>%
  # Drop PR observations
  filter(!str_detect(fips, '^72')) %>%
  select(fips,
         population = value)

```

Join the population data to the physicians data.
```{r}
joined_data <- left_join(physicians, pop, by = "fips")

joined_data <- joined_data %>%
  mutate(
    # Convert the antecedent of the primary care physicians:population ratio to numeric so we can use it for calculations
    antecedent = as.numeric(antecedent),
    # Divide the 2019 PEP population by the 2019 CHR Number of Physicians. Compare this value to the antecedent of the ratio.
    check_antecedent = population / number_pc_phys,
    diff_pop = abs(antecedent - check_antecedent)
  )
```

Any differences in the ratio are likely due to rounding. This means the population variable we pulled from PEP is a good proxy for the population variable used by County Health Rankings to construct this ratio.
```{r}
test <- joined_data %>%
  filter(number_pc_phys != 0)
  
quantile(test$diff_pop, probs = seq(0, 1, 0.25), na.rm = TRUE)

```

```{r}
joined_data <- joined_data %>%
  mutate(
    # Add 1 to the denominator of the ratio and reconstruct the ratio
    plus1 = population / (number_pc_phys + 1),
    # Calculate the differences between each of the new ratios and the original ratio
    plus1_diff = abs(plus1 - as.numeric(antecedent)),
    sensitivity = abs((plus1 - antecedent) / antecedent)
  )

```

```{r}
test <- joined_data %>%
  filter(number_pc_phys != 0)
  
quantile(test$sensitivity, probs = c(0, 0.2, 0.4, 0.6, 0.75, 0.8, 0.9, 1), na.rm = TRUE)

```


```{r}
joined_data %>%
  filter(!is.na(antecedent)) %>%
  ggplot(aes(number_pc_phys, sensitivity)) +
  geom_point(alpha = 0.2) +
  labs(title = "Counties with the lowest number of PC physicians have the highest sensitivity",
       subtitle = "") +
  scatter_grid()

```

To measure the data quality, we've added 1 to the number of primary care physicians in each county and re-created the ratio of the number of population per primary care physician. If the ratio changes less than 20 percentage points we assign a quality value of 1. If the ratio changes by more than 20 percentage points we assign a quality value of 2.

```{r}
# Assign a data quality flag
joined_data <- joined_data %>%
  mutate(pc_phys_quality = 
           case_when(
             sensitivity < 0.2 ~ 1,
             sensitivity < 0.4 ~ 2,
             sensitivity < 0.6 ~ 3
           )
  )

joined_data %>%
  count(pc_phys_quality)

```

## 5. Save the data

```{r}
all_counties <- read_csv(here::here("geographic-crosswalks", "data", "county-populations.csv")) %>%
  tidylog::filter(year == 2019) %>%
  select(-year)

joined_data <- joined_data %>%
  select(-population) %>%
  left_join(all_counties, by = c("state", "county"))

test <- anti_join(all_counties, physicians, by = c("state", "county"))

joined_data <- joined_data %>%
  mutate(year = 2019) %>%
  select(year, state, county, pc_phys_ratio, pc_phys_quality) %>%
  arrange(year, state, county)

joined_data %>%
  write_csv(here::here("04_health",
                       "access-health-services",
                       "access-health-services-2019.csv"))

```


