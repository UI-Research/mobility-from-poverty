---
title: "Access to Health Services"
author: "Vincent Pancini"
editor_options: 
  chunk_output_type: console
---

```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r setup}
library(tidyverse)
library(haven)
library(urbnthemes)

set_urbn_defaults(style = "print")

options(scipen = 999)

```

This metric represents the number of individuals served by one primary care physician in a county, if the population was equally distributed across physicians. Primary care physicians include practicing non-federal physicians (M.D.s and D.O.s) under age 75 specializing in general practice medicine, family medicine, internal medicine, and pediatrics. It does not include nurse practitioners, physician assistants, or other practitioners available for primary care services. It also does not include hospital residents.

The rest of this file is organized as follows:
1. Background
2. Download AHRF data
3. Clean, join, and reshape data
4. Construct ratio of population to primary care physicians
5. Add data quality flags
6. Validation
7. Save and write out data

## 1. Background
This section provides background for the data used to create this metric.

For 2022, we used data from [County Health Rankings](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?year=2022) for this metric, which used data from 2019. 

For 2023, we want to use the underlying source data used by CHR, which is the [Area Health Resource File, 2022-2023 County Level Data](https://data.hrsa.gov/data/download?data=AHRF#AHRF). The Area Health Resource File is a collection of data from more than 50 sources, including the American Medical Association, which maintains the Physician Masterfile. The Physician Masterfile contains information on nearly all the Doctors of Medicine and Doctors of Osteopathic Medicine in the nation.
    Note that when starting this round of updates we were using the 2021-2022 file, but the newer version has since been released, so I pivoted to using the most recent version. This version included several updates form previous versions, including separating the main file into separate sub-files and applying different naming conventions to variables. We use the main file because it includes all years, and we are pulling data from 2014 to the present.

Also note that we initially thought we would be able to disaggregate this metric by sex of provider and look at the ratio of population to primary care physicians by sex. The County Health Rankings website also implies that this is possible in their [methods section](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?year=2023). However, this does not seem possible upon further inspection of the AHRF data. 

The main variable for primary care physicians has the following restrictions:
    - INCLUDES practicing non-federal physicians (both M.D.s and D.O.s)
        - under age 75
        - specializing in general practice medicine, family medicine, internal medicine, and pediatrics
    - EXCLUDES nurse practitioners, physician assistants, or other practitioners available for primary care services
    - EXCLUDES hospital residents
    
This variable is not available by sex. We also cannot construct this variable by sex based on other variables. For instance, AHRF does have separate variables for Total MDs, Inactive MDs, Total DOs, and Inactive DOs (all non-federal) by sex. However, taking the sum of these variables by sex would still include physicians over the age of 75, and all specialties. There are also variables for MDs by specialty and age, but not by sex. 

Lastly, these data are unavailable at the Census place-level. County is the smallest geography available.


## 2. Download AHRF data
This section downloads two AHRF zip files from the AHRF website. It then extracts one SAS file from each zip file, reads each file into the R environment, and then deletes the zip files.

The data for this metric come from the [Area Health Resource File 2022-2023 County-Level Data](https://data.hrsa.gov/data/download). 

The 2022-2023 AHRF includes only the most recent two years of data for each variable (2020 and 2021 for primary care physicians), eliminating historical data across releases. Therefore, we also read in the 2021-2022 AHRF, which still includes historical data back to 2014.

```{r}
# URL of the 2022-2023 AHRF zip file
## Note that the 2021-2022 file doesn't have a csv option, so I download the SAS version for consistency. For more information, download the `Technical documentation`.
zip_url_23 <- "https://data.hrsa.gov//DataDownload/AHRF/AHRF_SAS_2022-2023.zip"

# Destination file path where we want to save the zip file
zip_dest_23 <- here::here("04_health", "access-health-services", "data", "AHRF_SAS_2022-2023.zip")

# Download the zip file to the above path
download.file(zip_url_23, zip_dest_23, mode = "wb")

# Unzip the file
unzip(zip_dest_23, exdir = here::here("04_health", "access-health-services", "data"))

# Read in the SAS file containing the latest AHRF data
ahrf23 <- haven::read_sas(here::here("04_health", "access-health-services", "data",
                                "AHRF_SAS_2022-2023", "ahrf2023.sas7bdat"))

# Remove zip file
unlink(zip_dest_23)

# Clean up environment
rm(zip_url_23, zip_dest_23)

```

```{r}
# URL of the 2021-2021 AHRF zip file
## Note that the 2021-2022 file doesn't have a csv option. For more information, download the `Technical documentation`.
zip_url_22 <- "https://data.hrsa.gov//DataDownload/AHRF/AHRF_2021-2022_SAS.zip"

zip_dest_22 <- here::here("04_health", "access-health-services", "data", "AHRF_SAS_2021-2022.zip")

# Download the zip file to the above path
download.file(zip_url_22, zip_dest_22, mode = "wb")

# Unzip the file
unzip(zip_dest_22, exdir = here::here("04_health", "access-health-services", "data"))

# Read in the SAS file containing the 2021-2022 AHRF data
ahrf22 <- haven::read_sas(here::here("04_health", "access-health-services", "data", "ahrf2022.sas7bdat"))

# Remove zip file and irrelevant contents
unlink(zip_dest_22)
unlink(here::here("04_health", "access-health-services", "data", "2021-2022_AHRFDUA.doc"))

# Clean up environment
rm(zip_url_22, zip_dest_22)

```


## 3. Clean, join, and reshape data
This section limits the two AHRF files from above to our variables of interest and renames them. It then joins the two files. There are variables for the number of primary care physicians and population for each year, so it then reshapes the data to be long by year after joining the two files.

Select only the relevant variables from the 2021-2022 AHRF file
```{r}
# Select and rename relevant variables from 2022-2023 file
## Note that both files have (identical) information for 2020. We keep the 2020 information from the historic file for ease of future updates.
ahrf23 <- ahrf23 %>%
  select(
    state = fips_st,
    county = fips_cnty,
    # GEOID = fips_st_cnty, 
    # county_state = cnty_name_st_abbrev, 
    # county_name = cnty_name, 
    # state_abb = st_name_abbrev, 
    # state_name = st_name,
    pc_physicians_21 = phys_nf_prim_care_pc_exc_rsdt_21,
    # pc_physicians_20 = phys_nf_prim_care_pc_exc_rsdt_20,
    pop_21 = popn_est_21,
    # pop_20 = cens_popn_20,
  )

# Select and rename relevant variables from 2021-2022 file
## Note that both files have (identical) information for 2020. We keep the 2020 information from the historic file for ease of future updates.
ahrf22 <- ahrf22 %>%
  select(state = f00011, 
         county = f00012,
         # GEOID = f00002, 
         # county_state = f04437, 
         # county_name = f00010, 
         # state_abb = f12424, 
         # state_name = f00008,
         pc_physicians_20 = f1467520,
         pc_physicians_19 = f1467519,
         pc_physicians_18 = f1467518,
         pc_physicians_17 = f1467517,
         pc_physicians_16 = f1467516,
         pc_physicians_15 = f1467515,
         pc_physicians_14 = f1467514,
         pop_20 = f0453020,
         pop_19 = f1198419,
         pop_18 = f1198418,
         pop_17 = f1198417,
         pop_16 = f1198416,
         pop_15 = f1198415,
         pop_14 = f1198414,
  )

# Join both AHRF files by state and county
ahrf_joined <- full_join(x = ahrf23, y = ahrf22, by = c("state", "county")) %>%
  # Remove US territories
  filter(
    !state %in% c('66', '72', '78')
  )

```

Alaska had one new county in 2021, so the 2022-2023 file (which has 2021 information for primary care physicians) has one extra observation.
```{r}
# Check join
anti_join(x = ahrf22, y = ahrf23, b = c("state", "county")) %>%
  select(state, county)

```

Reshape the data and filter out US territories
```{r}
# Reshape the joined data to be long by state/county/year
ahrf_long <- pivot_longer(
  ahrf_joined, 
  cols = starts_with("pc_physicians_") | starts_with("pop"),
  names_to = c(".value", "year"),
  names_pattern = "(.*)_(\\d+)"
) %>%
  mutate(year = paste0(20, `year`))

# Clean up environment
rm(ahrf22, ahrf23)

```



## 4. Construct ratio of population to primary care physicians
This section creates the metric (ratio of population to primary care physicians).

We create the ratio of population to primary care physicians by dividing the total population by the number of primary care physicians in each year. The variable is just the antecedent of the ratio, which represents the number of people for 1 primary care physician. If there are 0 primary care physicians in a county, we assign a value of 0. 

We also create a flag for counties with less than 2,000 people to indicate low population.
    todo(): CHR reports a missing value for counties with population greater than 2,000 and 0 primary care physicians. It is kind of unclear to me why they do that... maybe because they think the "0 PCPs" could be a reporting error for counties with a decent-sized population?
```{r}
# Create the ratio and a flag for counties with low population
ahrf <- ahrf_long %>%
  mutate(
    ratio_population_pc_physician = case_when(
      pc_physicians > 0 ~ round(pop/pc_physicians),
      pc_physicians == 0 ~ 0
      )
  )

```


## 5. Add data quality flags
This section adds a flag for counties with less than 2,000 people to indicate low population, and 

```{r}
ahrf <- ahrf %>%
  mutate(
    low_pop_flag = case_when(
      pop < 2000 ~ "1",
      pop >= 2000 ~ "0"
    ),
    # Add 1 to the denominator of the ratio and reconstruct the ratio
    plus1 = pop / (pc_physicians + 1),
    # Calculate the differences between each of the new ratios and the original ratio
    plus1_diff = abs(plus1 - as.numeric(ratio_population_pc_physician)),
    sensitivity = abs((plus1 - ratio_population_pc_physician) / ratio_population_pc_physician)
  )

```

```{r}
test <- ahrf %>%
  filter(pc_physicians != 0)
  
quantile(test$sensitivity, probs = c(0, 0.2, 0.4, 0.6, 0.75, 0.8, 0.9, 1), na.rm = TRUE)

```

```{r}
ahrf %>%
  filter(!is.na(ratio_population_pc_physician)) %>%
  ggplot(aes(pc_physicians, sensitivity)) +
  geom_point(alpha = 0.2) +
  labs(title = "Counties with the lowest number of PC physicians have the highest sensitivity",
       subtitle = "") +
  scatter_grid()

```

To measure the data quality, we've added 1 to the number of primary care physicians in each county and re-created the ratio of the number of population per primary care physician. If the ratio changes less than 20 percentage points we assign a quality value of 1. If the ratio changes by more than 20 percentage points we assign a quality value of 2.

```{r}
# Assign a data quality flag
ahrf <- ahrf %>%
  mutate(ratio_population_pc_physician_quality = 
           case_when(
             sensitivity < 0.2 ~ 1,
             sensitivity < 0.4 ~ 2,
             sensitivity < 0.6 ~ 3
           )
  )

ahrf %>%
  count(ratio_population_pc_physician_quality)

```


## 6. Validation
This section checks our results against the same metric created by [County Health Rankings](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?), which also used AHRF data.

### Download, read in, and clean the 2023 County Health Rankings Data
The landing page to download these data is [here](https://www.countyhealthrankings.org/explore-health-rankings/rankings-data-documentation).

```{r}
# Download file directly from internet
download.file(
  url = "https://www.countyhealthrankings.org/sites/default/files/media/document/2023%20County%20Health%20Rankings%20Data%20-%20v2.xlsx",
  destfile = "04_health/access-health-services/data/chr2023.xlsx",
  mode = "wb"
)

# Read in CHR data
chr2023 <- readxl::read_excel(here::here("04_health", "access-health-services", "data", "chr2023.xlsx"),
                              sheet = "Ranked Measure Data",
                              skip = 1,
                              col_names = TRUE)

# Limit CHR data to relevant variables
chr2023 <- chr2023 %>%
  select(
    GEOID = "FIPS",
    state_name = State,
    county_name = County,
    # Number of primary care physicians (PCP) in patient care
    pc_physicians_chr = "# Primary Care Physicians",
    # Primary Care Physicians per 100,000 population
    rate_pc_physicians_chr = "Primary Care Physicians Rate", 
    # Population to Primary Care Physicians ratio
    ratio_population_pc_physician_chr = "Primary Care Physicians Ratio",
  ) %>%
  # Delete state-level observations
  filter(!is.na(county_name))

# The CHR metric is reported as an actual ratio, so we split the ratio into its parts
chr2023 <- chr2023 %>%
  separate(col = ratio_population_pc_physician_chr,
           into = c('ratio_population_pc_physician_chr', 'consequent'),
           remove = TRUE)

# Split GEOID into separate state and county variables so we can join to main AHRF data
chr2023 <- chr2023 %>%
  mutate(
    state = str_sub(GEOID, 1, 2),
    county = str_sub(GEOID, 3, 5)
  )

```

### Join 2023 AHRF data and 2023 CHR data

The 2023 County Health Rankings uses the 2021-2022 AHRF file [(see Data and methods -> Methods -> Data Source)](https://www.countyhealthrankings.org/explore-health-rankings/county-health-rankings-model/health-factors/clinical-care/access-to-care/primary-care-physicians?). The latest year of primary care physician data available in the 2021-2022 AHRF file is 2020. So we are comparing 2020 data from each file.
```{r}
# First filter our AHRF data to 2020 physicians
ahrf_test <- ahrf %>%
  filter(year %in% c("2020", "2021")) %>%
  select(year, state, county, pc_physicians, pop, ratio_population_pc_physician) %>%
  pivot_wider(names_from = year,
              values_from = c(pc_physicians, pop, ratio_population_pc_physician))

# Join County Health Rankings and AHRF data
joined_data <- chr2023 %>%
  select(state, county, pc_physicians_chr, ratio_population_pc_physician_chr, consequent, rate_pc_physicians_chr) %>%
  left_join(y = ahrf_test %>%
              select(state, county, pc_physicians_2020, pc_physicians_2021,
                     ratio_population_pc_physician_2020, ratio_population_pc_physician_2021,
                     pop_2020, pop_2021),
            by = c("state", "county")) %>%
  mutate(ratio_population_pc_physician_chr = as.numeric(ratio_population_pc_physician_chr))

```


### Compare values from CHR and AHRF

County Health Rankings reports a missing value for counties with population greater than 2,000 and 0 primary care physicians. We do not report a missing value for these observations. After removing observations with a missing value for PCPs from the CHR data, the number of PCPs is consistent across our data and the CHR data. This makes sense, because AHRF was the source for both.
```{r}
joined_data <- joined_data %>%
  filter(!is.na(pc_physicians_chr))

stopifnot(joined_data$pc_physicians == joined_data$pc_physicians_chr)

```

However, the ratios are not the same. This implies that County Health Rankings used a different population source than we did. We used the 2020 Decennial Census population, which was available in the AHRF file.
```{r}
test <- joined_data %>%
  filter(consequent==1)

stopifnot(test$ratio_population_pc_physician_2020 == test$ratio_population_pc_physician_chr)

test <- test %>%
  mutate(ratio_diff_pct = 
           abs(ratio_population_pc_physician_2020 - ratio_population_pc_physician_chr) / ((ratio_population_pc_physician_chr + ratio_population_pc_physician_2020)/2))

quantile(test$ratio_diff_pct, probs = c(0, 0.2, 0.4, 0.6, 0.8, 0.99, 1), na.rm = TRUE)

```

County Health Rankings documentation indicates that they use 2021 Census Population Estimates for their ratio, even though the measure of primary care physicians is from 2020. During a meeting with CHR researchers on 2024-01-31, one of their team members said they pulled population data for this metric from [this link](https://www2.census.gov/programs-surveys/popest/datasets/2020-2021/counties/totals/). However, another team member said they used Vintage 2020 population estimates, which are based on the 2010 Census (see more [here](https://www.census.gov/programs-surveys/popest/technical-documentation/research/evaluation-estimates/2020-evaluation-estimates.html)).
```{r}
download.file(
  url = "https://www2.census.gov/programs-surveys/popest/datasets/2010-2020/counties/totals/co-est2020.csv",
  destfile = "04_health/access-health-services/data/chr_pop.csv",
  mode = "wb"
)

chr_pop <- read_csv(here::here("04_health", "access-health-services", "data", "chr_pop.csv")) %>%
  select(
    state = STATE,
    county = COUNTY,
    # estimates_base_2020 = ESTIMATESBASE2020,
    # pop_2020_chr = POPESTIMATE2020,
    # pop_2021_chr = POPESTIMATE2021
    pop_2010_chr = CENSUS2010POP,
    estimates_base_2010 = ESTIMATESBASE2010,
    pop_2010_chr_est = POPESTIMATE2010,
    pop_2019_chr = POPESTIMATE2019,
    pop_2020_chr_est_04 = POPESTIMATE042020,
    pop_2020_chr_est = POPESTIMATE2020
  ) %>%
  filter(county != "000")

joined_data <- joined_data %>%
  full_join(y = chr_pop, by = c("state", "county"))

joined_data <- joined_data %>%
  mutate(
    ratio_test = case_when(
      pc_physicians_chr > 0 ~ round(pop_2020_chr_est/pc_physicians_chr),
      pc_physicians_chr == 0 ~ 0
      )
  ) %>%
  select(state, county, ratio_population_pc_physician_2020, ratio_population_pc_physician_chr, ratio_test, pop_2020, pop_2020_chr_est)

```


```{r}
joined_data <- chr2023 %>%
  select(state, county, pc_physicians_chr, ratio_population_pc_physician_chr, consequent, rate_pc_physicians_chr) %>%
  full_join(y = ahrf_joined %>%
              select(state, county,
                     pc_physicians = pc_physicians_20,
                     pop = pop_21),
            by = c("state", "county")) %>%
  mutate(
    ratio_population_pc_physician = case_when(
      pc_physicians > 0 ~ round(pop/pc_physicians),
      pc_physicians == 0 ~ 0
    ),
    ratio_population_pc_physician_chr = as.numeric(ratio_population_pc_physician_chr)
  )

```


```{r}
test <- joined_data %>%
  filter(consequent==1)

stopifnot(test$ratio_population_pc_physician == test$ratio_population_pc_physician_chr)

test <- test %>%
  mutate(ratio_diff = abs(ratio_population_pc_physician - ratio_population_pc_physician_chr))

quantile(test$ratio_diff, probs = c(0, 0.2, 0.4, 0.6, 0.8, 0.99, 1), na.rm = TRUE)

```

There are two ways that we can impute the population value used by CHR:
  1. Multiply the ratio of population to primary care physicians by the number of primary care physicians for counties with at least 1 PCP
  2. Use the number of PCPs and rate of PCPs per 100,000 population to get population
We try both methods, but neither are consistent with the 2021 population estimate that we use from the AHRF data.
```{r}
joined_data <- joined_data %>%
  mutate(pop_21_chr1 = (pc_physicians_chr/rate_pc_physicians_chr) * 100000,
         pop_21_chr2 = ifelse(consequent==1,
                              ratio_population_pc_physician_chr*pc_physicians_chr,
                              ratio_population_pc_physician_chr))

joined_data %>%
  select(pop, pop_21_chr1, pop_21_chr2) %>%
  skimr::skim()

stopifnot(joined_data$pop == joined_data$pop_21_chr1)
stopifnot(joined_data$pop == joined_data$pop_21_chr2)
stopifnot(joined_data$pop_21_chr1 == joined_data$pop_21_chr2)

```


```{r}
# CHR may have used 2020 data from the Population Estimates Program, which is released before the 2020 Census
pop20_pep <- tidycensus::get_estimates("county", year = 2020, variables = "POPESTIMATE") %>%
  select(GEOID,
         population = value)

# Join PEP population data onto CHR
joined_data <- joined_data %>%
  mutate(GEOID = str_c(state, county)) |>
  full_join(y = pop21_pep, by = "GEOID")

test_pop <- censusapi::getCensus(
    name = "acs/acs5",
    vintage = 2020, 
    vars = "B17001_001E", 
    region = "county")

```



## 7. Save the data

```{r}
all_counties <- read_csv(here::here("geographic-crosswalks", "data", "county-populations.csv")) %>%
  tidylog::filter(year == 2019) %>%
  select(-year)

joined_data <- joined_data %>%
  select(-population) %>%
  left_join(all_counties, by = c("state", "county"))

test <- anti_join(all_counties, physicians, by = c("state", "county"))

joined_data <- joined_data %>%
  mutate(year = 2019) %>%
  select(year, state, county, pc_phys_ratio, pc_phys_quality) %>%
  arrange(year, state, county)

joined_data %>%
  write_csv(here::here("04_health",
                       "access-health-services",
                       "access-health-services-2019.csv"))

```

