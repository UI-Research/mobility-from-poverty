---
title: "Exposure to Trauma"
author: "Vincent Pancini"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output:
  html_document:
    number_sections: false
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    editor_options:
      chunk_output_type: console
---

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

This metric is a county-level estimate of exposure to trauma, defined as the number of deaths due to injury per 100,000 population. We pull this data from the 2022 County Health Rankings, which uses 2016-2020 data from the National Center for Health Statistics - Mortality Files.

See the [County Health Rankings](https://www.countyhealthrankings.org/explore-health-rankings/measures-data-sources/county-health-rankings-model/health-factors/social-and-economic-factors/community-safety/injury-deaths) for more information.

```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r setup}
options(scipen = 999)

library(urbnthemes)
library(tidyverse)
library(readxl)
library(writexl)

library(rvest)
library(glue)
library(fs)
library(reactable)

set_urbn_defaults(style = "print")

```

## 1. Prepare for file download
```{r}
base_url <- "https://www.countyhealthrankings.org"
url <- paste0(base_url, "/explore-health-rankings/rankings-data-documentation")
download_urls <-
  read_html(url) %>% 
  html_elements('span.field-content') %>%  
  html_element('a') %>% 
  html_attr('href') %>%
  paste0(base_url, .)

out_state <-
  read_html(url) %>% 
  html_elements('span.field-content') %>% 
  html_text2() %>% 
  str_replace_all(' ', '-')

get_state_data_url <- function(url){
  read_html(url) %>% 
    html_elements('span.download-link') %>% 
    html_element('a') %>% 
    html_attr('href') %>% 
    str_subset('.xls') %>% 
    str_subset('2022') %>% 
    paste0(base_url, .)
}
state_data_url <- purrr::map_chr(.x = download_urls, .f = get_state_data_url)
```


## 2. Download files

Download all 51 Excel files from each state's URL
```{r}
# create a data folder for intermediate data files
intermediate_files <- here::here("04_health",
                                 "exposure-to-trauma",
                                 "data/")

if (!dir.exists(intermediate_files)) {
  
  dir.create(intermediate_files)
  
}

chr_data <- here::here("04_health",
                       "exposure-to-trauma",
                       "data",
                       out_state
)

download_data <- function(state_data_url, state_name){
  if (!file.exists(here::here(glue("04_health/exposure-to-trauma/data/{state_name}.xlsx")))) {
    
    download.file(state_data_url, 
                  destfile = here::here(glue("04_health/exposure-to-trauma/data/{state_name}.xlsx")))
    
  }
}

walk2(state_data_url, out_state, download_data)

```


## 3. Read in, clean, and append each Excel sheet
```{r, message = FALSE}
injury_deaths <- map_df(out_state,
                        ~{readxl::read_excel(path = here::here(
                          paste0("04_health/exposure-to-trauma/data/", .x, ".xlsx")),
                          sheet = "Ranked Measure Data",
                          skip = 1
                        ) %>%
                            select(
                              fips = 'FIPS',
                              number_injury_deaths = '# Injury Deaths',
                              injury_death_rate = 'Injury Death Rate',
                              # XX We need a more robust way to pull the confidence interval.
                              # If there are not the same number of columns across states 
                              # (and across years in the future), this will be inaccurate.
                              injury_death_rate_lb = '95% CI - Low...191',
                              injury_death_rate_ub = '95% CI - High...192'
                            ) %>%
                            filter(!str_detect(fips, '000$')) %>%
                            mutate(state = str_sub(fips, 1, 2),
                                   county = str_sub(fips, 3, 5),
                                   injury_death_rate = round(injury_death_rate, 2))
                        }
)
```

105 counties are missing an injury death rate value
```{r, message = FALSE}
injury_deaths %>%
  summarize(
    missing = sum(is.na(injury_death_rate))
  )

```

The table shows the injury death rates in each county. Click on the variable columns to sort the table. 
```{r table, echo = FALSE}
injury_deaths %>%
  select(
    fips,
    injury_death_rate
  ) %>%
  reactable(
    filterable = TRUE,
    searchable = TRUE,
    defaultPageSize = 10,
    highlight = TRUE
  )

```

## 4. Add data quality flags
```{r}
injury_deaths <- injury_deaths %>%
  mutate(se = (injury_death_rate_ub - injury_death_rate) / 1.96,
         cv = se / injury_death_rate,
         injury_deaths_quality = case_when(
           cv < 0.2 ~ 1,
           cv < 0.4 ~ 2,
           cv >= 0.4 ~ 3
         )
  )

```

Most estimates have small coefficients of variation and are therefore of high quality.
```{r}
injury_deaths %>%
  ggplot(aes(x = injury_deaths_quality)) +
  geom_bar()
  
```

Most estimates have small standard errors.
```{r}
injury_deaths %>%
  ggplot(aes(injury_death_rate, se)) +
  geom_point(alpha = 0.1, size = 0.5) +
  geom_abline(aes(slope = 0.4, intercept = 0)) +
  labs(title = "Most Estimates Have Small SEs",
       subtitle = "Line represents a CV of 0.4") +
  coord_equal() +
  scatter_grid()

```


## 5. Save the data
```{r}
all_counties <- read_csv(here::here("geographic-crosswalks", "data", "county-populations.csv")) %>%
  tidylog::filter(year == 2020) %>%
  select(-year)

all_counties <- left_join(all_counties, injury_deaths, by = c("state", "county"))

test <- anti_join(all_counties, injury_deaths, by = c("state", "county"))

all_counties <- all_counties %>%
  mutate(year = 2019) %>%
  select(year,
         state,
         county,
         injury_death_rate,
         injury_death_rate_lb,
         injury_death_rate_ub,
         injury_deaths_quality)

all_counties %>%
  arrange(year, state, county) %>%
  write_csv(here::here("04_health",
                       "exposure-to-trauma",
                       "exposure-to-trauma-2019.csv"))

```

