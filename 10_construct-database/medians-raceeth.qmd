---
title: "Calculate Medians for Dashboard - For Race and Ethnicity Subgroups"
author: "Judah Axelrod and Aaron R. Williams, Updated by Kassandra Martinchek"
date: today
format:
  html:
    df-print: kable
    toc: true
    toc_float: true
    embed-resources: true
    code-fold: true
    grid:
      body-width: 1200px
execute: 
  warning: false
editor_options: 
  chunk_output_type: console
---

# Mobility metrics median calculations

This code calculates weighted medians of the mobility metrics at the county and then the place level, by year and race/ethnicity subgroup. 

We want to better understand the quality and availability of county- and place-level metrics that are being aggregated into these national-level medians to determine whether it is appropriate to report at the national level.


We exclude missing values and calculate the proportion of places and proportion of population missing for each metric. The function below is used to calculate the proportion of population missing for each metric.

## Load Packages

```{r}
#| label: load-packages

options(scipen = 999)

library(tidyverse)
library(here)
library(tidycensus)
library(DT)
library(kableExtra)
library("tidylog", warn.conflicts = FALSE)

theme_set(theme_minimal())

```

```{r}
missing_share <- function(x, weight) {
  
  sum(as.numeric(is.na(x)) * weight) / sum(weight)
  
}
```



The steps taken for calculating the median estimates are as follow:

-   Calculate the population-weighted median
-   Calculate the proportion of places that are missing
-   Calculate the proportion of people that are missing

# County level

## Load Data

```{r}
#| label: load-data

metrics <- read_csv(here("data", "11_mobility-metrics_county_longitudinal.csv")) |>
  select(-ends_with("_lb"), -ends_with("_ub"))

metrics_01 <- read_csv(here("data", "12_mobility-metrics_county_race-ethnicity_longitudinal.csv")) |>
  select(-ends_with("_lb"), -ends_with("_ub"))

metrics_03 <- read_csv(here("data", "13_mobility-metrics_county_race-share_longitudinal.csv")) |> 
  select(-ends_with("_lb"), -ends_with("_ub"))

```

Prepare metrics 03 for wrangling-- requires merging population figures from metrics file into this subgroup file

```{r}

# merge the overall population figures to the metrics 03 data (which is at the neighborhood level) ? Because race population weighting doesn't make sense because this is classified at the neighborhood level

metrics_pop <- metrics |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(population, year, county_state)

metrics_03 <- metrics_03 |>
  mutate(county_state = paste0(county_name, ', ', state_name))

metrics_03 <- left_join(x = metrics_03,
                        y = metrics_pop,
                        by = c("year", "county_state"))

metrics_03 <- metrics_03 |>
  select(-county_state) |>
  filter(year != 2014) # population not available for this year in the data plus only want most recent data anywho!

```

Reshape the dataset and filter to most recent year available 

First, create a function

```{r}

recent_year_filter <- function(data, col_a, col_b) {
# reshape to long
metrics_long <- data |>
  select(!ends_with("quality")) |>
  pivot_longer(cols = {{col_a}}:{{col_b}},
               names_to = "variable",
               values_to = "value")

# filter to max 
metrics_long <- metrics_long |>
  group_by(year, variable) |>
  filter(!all(is.na(value))) 

recent_year_data <- metrics_long |>
  group_by(variable) |>
  summarize(recent_year = max(year)) 

metrics_long <- left_join(x = metrics_long,
                          y = recent_year_data,
                          by = "variable")

metrics_long_recent <- metrics_long |>
  filter(year == recent_year)

# reshape back to wide for later functions and merge with quality variables
metrics_quality <- data |>
  select(year, state, county, subgroup, ends_with("quality"))

metrics_recent_values <- metrics_long_recent |>
  pivot_wider(names_from = variable,
              values_from = value) 

metrics_recent <- left_join(x = metrics_recent_values,
                            y = metrics_quality,
                            by = c("year", "county", "state", "subgroup"))

metrics_recent <- metrics_recent |>
  ungroup() |>
  select(-recent_year)
}

```

Now, implement that function

```{r}

metrics_01_recent <- recent_year_filter(data = metrics_01,
                                        col_a = pctl_income_20,
                                        col_b = share_employed)

```

We load county-level population estimates from the 2020 decennial census.

```{r}
# Only some variables are pre-2020 and can't be called here
# variable definitions: https://www.census.gov/data/developers/data-sets/popest-popproj/popest/popest-vars/2017.html
population_data <- map_dfr(c (2020:2022), ~get_estimates(
  geography = "county", 
  product = "characteristics",
  variables = "POPESTIMATE",
  breakdown = c("RACE", "HISP"),
  year = .x
),
.id = 'year') 

population <- population_data |>
  mutate(
    year = case_when(year == 1 ~ 2017,
                     year != 1 ~ as.numeric(year) + 2019),
    state = str_sub(GEOID, start = 1, end = 2),
    county = str_sub(GEOID, start = 3, end = 5),
    subgroup = case_when(RACE == 1 & HISP == 1 ~ "White, Non-Hispanic",
                         RACE == 1 & HISP == 0 ~ "White",
                         RACE == 2 & HISP == 1 ~ "Black, Non-Hispanic",
                         RACE == 2 & HISP == 0 ~ "Black",
                         HISP == 2 ~ "Hispanic",
                         RACE != 1 & RACE != 2 & HISP == 1 ~ "Other Races and Ethnicities",
                         RACE == 0 & HISP == 0 ~ "All")
  ) 

population <- population |>
  group_by(year, state, county, subgroup) |>
  summarize(population = sum(value)) |>
  select(state, county, subgroup, population, year) |>
  filter(!is.na(subgroup))

```

Merge population data to metrics data for specific subgroup weighting

```{r}

 metrics_01_df <- left_join(x = metrics_01_recent, 
                            y = population, 
                            by = c("state", "county", "year", "subgroup")) |> 
    filter(!is.na(population))

```

Generate regions datasets for stratification analysis

```{r}

northeast_01 <- metrics_01_df |>
  filter(state_name == c("Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", "Vermont", "New Jersey", "New York", "Pennsylvania"))

midwest_01 <- metrics_01_df |>
  filter(state_name == c("Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin", "Iowa", "Kansas", "Minnesota", "Missouri", "Nebraska", "North Dakota", "South Dakota"))

south_01 <- metrics_01_df |>
  filter(state_name == c("Delaware", "District of Columbia", "Florida", "Georgia", "Maryland", "North Carolina", "South Carolina", "Virginia", "West Virginia", "Alabama", "Kentucky", "Mississippi", "Tennessee", "Arkansas", "Louisiana", "Oklahoma", "Texas"))

west_01 <- metrics_01_df |>
  filter(state_name == c("Arizona", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Utah", "Wyoming", "Alaska", "California", "Hawaii", "Oregon", "Washington"))

```

Load RUCS codes (needed to create urban and rural breakdowns-- use these same files for both subgroup extracts)

```{r}

rucs_codes_23 <- read_csv(here("10_construct-database", "Ruralurbancontinuumcodes2023.csv")) |>
  janitor::clean_names()

rucs_codes_13 <- read_csv(here("10_construct-database", "ruralurbancodes2013.csv")) |>
  janitor::clean_names()

```

Merge RUCS codes to MM data

```{r}

# create fips code for merging
metrics_01_df <- metrics_01_df |>
  mutate(fips = paste0(state, county))

# reduce the vars in RUCS crosswalk
rucs_codes_23 <- rucs_codes_23 |>
   select(fips, rucc_2023)

# merge datasets together -- no rows unaligned in 2023 RUCS codes
metrics_rucs_01 <- left_join(x = metrics_01_df,
                          y = rucs_codes_23,
                          by = "fips")

# now, make one harmonized RUCS variable
metrics_01_df <- metrics_rucs_01 |>
  mutate(rucs_code = case_when(rucc_2023 <= 3 ~ "Urban",
                               rucc_2023 >= 4 ~ "Rural")) |>
  select(-rucc_2023)

```

Create separate rural and urban data sets for metrics calculation

```{r}

rural_01 <- metrics_01_df |>
  filter(rucs_code == "Rural")

urban_01 <- metrics_01_df |>
  filter(rucs_code == "Urban")

```

## Calculate Medians

We calculate weighted medians for each numeric variable. This means our estimates represent the county mobility metric for the average American. We also calculate `share_lq3`, which is the share of the population for which the given metric is either missing or `quality=3`. 

```{r}
# Remove missing variable-year combos
safe_wtd_quantile <- possibly(Hmisc::wtd.quantile, otherwise = NA)

calc_year_subgroup_table <- function(metrics_df, northeast_df, midwest_df, south_df, west_df, rural_df, urban_df) {
  
weighted_median <- metrics_df |>
    mutate(county_state = paste0(county_name, ', ', state_name)) |> 
    select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
    summarize(
      across(
        .cols = -c('population', 'county_state'),
        .fns = list(
          .wtd_median = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE),
          .wtd_lowpct = ~safe_wtd_quantile(., weights = population, probs = 0.05, na.rm = TRUE),
          .wtd_highpct = ~safe_wtd_quantile(., weights = population, probs = 0.95, na.rm = TRUE)
        )
      ), .by = c('year','subgroup')
    ) |>
    pivot_longer(cols = -c('year','subgroup'), names_to = c('name', '.value'), 
                 names_pattern = '(.*)_\\.(.*)')

weighted_northeast <- northeast_df |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
  summarize(
    across(
      .cols = -c('population', 'county_state'), 
      .fns = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    ), .by = c('year', 'subgroup')
  ) |>
  pivot_longer(cols = -c('year','subgroup')) |>
  rename(weighted_median_northeast:=value)

weighted_midwest <- midwest_df |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
  summarize(
    across(
      .cols = -c('population', 'county_state'), 
      .fns = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    ), .by = c('year', 'subgroup')
  ) |>
  pivot_longer(cols = -c('year','subgroup')) |>
  rename(weighted_median_midwest:=value)

weighted_south <- south_df |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
  summarize(
    across(
      .cols = -c('population', 'county_state'), 
      .fns = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    ), .by = c('year', 'subgroup')
  ) |>
  pivot_longer(cols = -c('year','subgroup')) |>
  rename(weighted_median_south:=value)

weighted_west <- west_df |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
  summarize(
    across(
      .cols = -c('population', 'county_state'), 
      .fns = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    ), .by = c('year', 'subgroup')
  ) |>
  pivot_longer(cols = -c('year','subgroup')) |>
  rename(weighted_median_west:=value)                  
  
weighted_rural <- rural_df |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
  summarize(
    across(
      .cols = -c('population', 'county_state'), 
      .fns = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    ), .by = c('year', 'subgroup')
  ) |>
  pivot_longer(cols = -c('year','subgroup')) |>
  rename(weighted_median_rural:=value)  

weighted_urban <- urban_df |>
  mutate(county_state = paste0(county_name, ', ', state_name)) |> 
  select(county_state, subgroup, where(is.numeric) & (!ends_with('quality'))) |> 
  summarize(
    across(
      .cols = -c('population', 'county_state'), 
      .fns = ~safe_wtd_quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    ), .by = c('year', 'subgroup')
  ) |>
  pivot_longer(cols = -c('year','subgroup')) |>
  rename(weighted_median_urban:=value) 

state_count <- metrics_df |> 
    mutate(across(ends_with("quality"), ~case_when(. == "Strong" ~ 1,
                                                 . == "Marginal" ~ 2,
                                                 . == "Weak" ~ 3))) |>
    pivot_longer(cols = ends_with('_quality'), names_to = 'qual_varname', values_to = 'quality') |> 
    filter(quality %in% 1:2) |> 
    count(state_name, year, subgroup, qual_varname) |> 
    count(qual_varname, year, subgroup, name = 'n_states')
    
proportion_by_qual <- metrics_df |>
    mutate(across(ends_with("quality"), ~case_when(. == "Strong" ~ 1,
                                                 . == "Marginal" ~ 2,
                                                 . == "Weak" ~ 3))) |>
    select(subgroup, where(is.numeric)) |>
    pivot_longer(cols = ends_with('_quality'), names_to = 'qual_varname', values_to = 'quality') |> 
    summarize(population = sum(population),
     .by = c('year', 'subgroup', 'qual_varname', 'quality')
    ) |> 
    mutate(pop_share = population / sum(population), .by = c('year', 'subgroup', 'qual_varname')) |> 
    filter(quality %in% 2:3) |> 
    select(-population) |> 
    arrange(qual_varname, quality)
  
  
missing_population <- metrics_df |>
    select(subgroup, where(is.numeric) & (!ends_with('quality'))) |>
    summarize(
      across(
        .cols = -population, 
        .fns = ~missing_share(.x, weight = population)
      ), .by=c('year','subgroup')) |> 
    pivot_longer(cols = -c('year','subgroup'), values_to = "missing_population")
   
missing_county <- metrics_df |>
    select(subgroup, where(is.numeric) & (!ends_with('quality'))) |>
    summarize(
      across(
        .cols = -population, 
        .fns = ~sum(is.na(.x)) / n()
      ), .by = c('year','subgroup')) |> 
    pivot_longer(cols = -c('year','subgroup'), values_to = "missing_county")
    
weighted_median |> 
    left_join(weighted_northeast, by = c("year", "subgroup", "name")) |> 
    left_join(weighted_midwest, by = c("year", "subgroup", "name")) |> 
    left_join(weighted_south, by = c("year", "subgroup", "name")) |> 
    left_join(weighted_west, by = c("year", "subgroup", "name")) |> 
    left_join(weighted_rural, by = c("year", "subgroup", "name")) |> 
    left_join(weighted_urban, by = c("year", "subgroup", "name")) |> 
    full_join(missing_population, by = c("year", "subgroup", "name")) |>
    full_join(missing_county, by = c("year", "subgroup", "name"))|>
    mutate(qual_varname = paste0(name, '_quality')) |>
    left_join(proportion_by_qual, by = c("year", "subgroup", "qual_varname")) |>  #M:M Merge is expected behavior here
    left_join(state_count, by = c("year", "subgroup", "qual_varname")) |> 
    pivot_wider(names_from = quality, names_glue = 'quality{quality}_popshare', values_from = pop_share) |>
    select(-qual_varname, -one_of('qualityNA_popshare')) |> 
    mutate(across(where(is.numeric), ~round(.,digits=2))) |> 
    rowwise() |> 
    # Share of pop that is either missing or quality = 3 for that metric
    mutate(share_lq3 = sum(missing_population, quality3_popshare, na.rm = TRUE)) |> 
    # Remove all-missing metric-years
    filter(missing_county < 1) |> 
    select(year, name, subgroup, share_lq3, everything()) |>
    arrange(desc(year), name, subgroup)

}
```

Suppression function

```{r}

stratification_suppression_subg <- function(data, qual_var) {

  proportion_by_qual <- data |>
    mutate(across(ends_with("quality"), ~case_when(. == "Strong" ~ 1,
                                                 . == "Marginal" ~ 2,
                                                 . == "Weak" ~ 3))) |>
    select(subgroup, where(is.numeric)) |>
    pivot_longer(cols = ends_with('_quality'), names_to = 'qual_varname', values_to = 'quality') |> 
    summarize(population = sum(population),
     .by = c('year', 'subgroup', 'qual_varname', 'quality')
    ) |> 
    mutate(pop_share = population / sum(population), .by = c('year', 'subgroup', 'qual_varname')) |> 
    filter(quality %in% 3) |> 
    select(-population) |> 
    arrange(qual_varname, quality)
  
  missing_population <- data |>
    select(subgroup, where(is.numeric) & (!ends_with('quality'))) |>
    summarize(
      across(
        .cols = -population, 
        .fns = ~missing_share(.x, weight = population)
      ), .by=c('year','subgroup')) |> 
    pivot_longer(cols = -c('year','subgroup'), values_to = "missing_population")
   
  missing_county <- data |>
    select(subgroup, where(is.numeric) & (!ends_with('quality'))) |>
    summarize(
      across(
        .cols = -population, 
        .fns = ~sum(is.na(.x)) / n()
      ), .by = c('year','subgroup')) |> 
    pivot_longer(cols = -c('year','subgroup'), values_to = "missing_county")

suppression_data <- missing_population |>
  full_join(missing_county, by = c("year", "subgroup", "name")) |>
  mutate(qual_varname = paste0(name, '_quality')) |>
  left_join(proportion_by_qual, by = c("year", "subgroup" , "qual_varname")) |>
  select(-qual_varname, -quality) |>
  mutate(across(where(is.numeric), ~round(.,digits=2)))|> 
  rowwise() |>
  mutate({{qual_var}} := sum(missing_population, pop_share, na.rm = TRUE))  |>
  filter(missing_county < 1) |>
  ungroup() |>
  select(year, name, subgroup, {{qual_var}}) |>
  arrange(desc(year), name, subgroup, {{qual_var}})
  
}
  
```

### SUBGROUP: Percentile income, homeless count, poverty exposure, juvinile arrest rate, share in preschool, share employed, share with HS degree, rate low birth weight, digital access, employment rate, and rate of learning achievement

Suppress weighted medians with 15 percent of counties low quality or missing -- as did in the overall feature

```{r}

metrics_01_recent_final <- calc_year_subgroup_table(metrics_df = metrics_01_df,
                                                    northeast_df = northeast_01,
                                                    midwest_df = midwest_01,
                                                    south_df = south_01,
                                                    west_df = west_01,
                                                    rural_df = rural_01,
                                                    urban_df = urban_01) 

```

Add stratification suppression vars

```{r}

qual_northeast_01 <- stratification_suppression_subg(data = northeast_01,
                                                     qual_var = share_lq3_northeast)

qual_midwest_01 <- stratification_suppression_subg(data = midwest_01,
                                                   qual_var = share_lq3_midwest)

qual_south_01 <- stratification_suppression_subg(data = south_01,
                                                 qual_var = share_lq3_south)

qual_west_01 <- stratification_suppression_subg(data = west_01,
                                                qual_var = share_lq3_west)

qual_rural_01 <- stratification_suppression_subg(data = rural_01,
                                                 qual_var = share_lq3_rural)

qual_urban_01 <- stratification_suppression_subg(data = urban_01,
                                                 qual_var = share_lq3_urban)

```


```{r}

metrics_01_postsupp <- metrics_01_recent_final |> 
  full_join(qual_northeast_01, by = c("year", "subgroup", "name")) |>
  full_join(qual_midwest_01, by = c("year", "subgroup", "name")) |>
  full_join(qual_south_01, by = c("year", "subgroup", "name")) |>
  full_join(qual_west_01, by = c("year", "subgroup", "name")) |>
  full_join(qual_rural_01, by = c("year", "subgroup", "name")) |>
  full_join(qual_urban_01, by = c("year", "subgroup", "name"))

```

Finalize suppression

```{r}
 
metrics_recent_suppressed_01 <- metrics_01_postsupp |> 
  mutate(weighted_median = ifelse(share_lq3 > 0.15, NA, wtd_median),
         high_pctle = ifelse(share_lq3 > 0.15, NA, wtd_highpct),
         low_pctle = ifelse(share_lq3 > 0.15, NA, wtd_lowpct),
         weighted_median_northeast = ifelse(share_lq3_northeast > 0.15, NA, weighted_median_northeast),
         weighted_median_midwest = ifelse(share_lq3_midwest > 0.15, NA, weighted_median_midwest),
         weighted_median_south = ifelse(share_lq3_south > 0.15, NA, weighted_median_south),
         weighted_median_west = ifelse(share_lq3_west > 0.15, NA, weighted_median_west),
         weighted_median_rural = ifelse(share_lq3_rural > 0.15, NA, weighted_median_rural),
         weighted_median_urban = ifelse(share_lq3_urban > 0.15, NA, weighted_median_urban)) |> 
  select(year, name, subgroup, weighted_median, low_pctle, high_pctle, weighted_median_northeast, weighted_median_midwest, weighted_median_south, weighted_median_west, weighted_median_rural, weighted_median_urban, share_lq3) 

```

Add in pillar names

```{r}
metrics_recent_suppressed_01 <- metrics_recent_suppressed_01 |>
  mutate(pillar = case_when(name == "rate_juv_arrest" ~ "Responsive and Just Governance",
                            name == "share_low_birth_weight" ~ "Healthy Enviornment and Access to Good Healthcare",
                            name == "count_homeless" | name == "share_homeless" | name == "share_poverty_exposure" ~ "Opportunity-Rich and Inclusive Neighborhoods",
                            name == "pctl_income_20" | name == "pctl_income_50" | name == "pctl_income_80" | name == "share_employed" ~ "Rewarding Work",
                            name == "share_digital_access" | name == "share_hs_degree" | name == "share_in_preschool" | name == "rate_learning" ~ "High-Quality Education")) |>
  select(pillar, name, subgroup, year, weighted_median, low_pctle, high_pctle, weighted_median_northeast, weighted_median_midwest, weighted_median_south, weighted_median_west, weighted_median_rural, weighted_median_urban, share_lq3)

```

Output files

```{r}

metrics_recent_suppressed_01 |> 
  kbl() |> 
  kable_styling(font_size = 10, fixed_thead = TRUE)

metrics_recent_suppressed_01 |>
  write_csv(here("10_construct-database", "county_medians_01_recent_suppressed.csv"))

```

Counting number of metrics with low quality and suppression

```{r}

metrics_recent_suppressed_01 %>%
  group_by(subgroup) %>%
  summarize(n_NA = sum(is.na(weighted_median)))

```


### COMMUNITY-LEVEL: Air quality index, transit trips index, share with debt in collections, and transportation cost 

First, filter to most recent year only-- this could be a function given we use it above

```{r}

metrics_03_recent <- recent_year_filter(data = metrics_03,
                                        col_a = share_debt_coll,
                                        col_b = index_transportation_cost)

```

Generate regions datasets for stratification analysis

```{r}

northeast_03 <- metrics_03_recent |>
  filter(state_name == c("Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", "Vermont", "New Jersey", "New York", "Pennsylvania"))

midwest_03 <- metrics_03_recent |>
  filter(state_name == c("Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin", "Iowa", "Kansas", "Minnesota", "Missouri", "Nebraska", "North Dakota", "South Dakota"))

south_03 <- metrics_03_recent |>
  filter(state_name == c("Delaware", "District of Columbia", "Florida", "Georgia", "Maryland", "North Carolina", "South Carolina", "Virginia", "West Virginia", "Alabama", "Kentucky", "Mississippi", "Tennessee", "Arkansas", "Louisiana", "Oklahoma", "Texas"))

west_03 <- metrics_03_recent |>
  filter(state_name == c("Arizona", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Utah", "Wyoming", "Alaska", "California", "Hawaii", "Oregon", "Washington"))

```

Merge RUCS codes to MM data

```{r}

# create fips code for merging
metrics_03_recent <- metrics_03_recent |>
  mutate(fips = paste0(state, county))

# adjust RUCS 2013 data for CT
rucs_codes_13 <- rucs_codes_13 |>
  filter(state == "CT" | fips == "02261")  |>
  select(fips, rucc_2013)

# merge datasets together -- only 26 rows unaligned in 2023 RUCS codes, mostly in CT (because of updated FIPS codes, so we need the 2013 codes for these counties)
metrics_rucs_03 <- left_join(x = metrics_03_recent,
                          y = rucs_codes_23,
                          by = "fips")

# expect 36 matches-- and this is what we get!
metrics_rucs_03 <- left_join(x = metrics_rucs_03,
                          y = rucs_codes_13,
                          by = "fips")

# now, make one harmonized RUCS variable
metrics_03_recent <- metrics_rucs_03 |>
  mutate(rucs_code_int = case_when(!is.na(rucc_2023) ~ rucc_2023,
                                   !is.na(rucc_2013) ~ rucc_2013)) |>
  mutate(rucs_code = case_when(rucs_code_int <= 3 ~ "Urban",
                               rucs_code_int >= 4 ~ "Rural")) |>
  select(-rucc_2023, -rucc_2013, -rucs_code_int)

```

Create separate rural and urban data sets for metrics calculation

```{r}

rural_03 <- metrics_03_recent |>
  filter(rucs_code == "Rural")

urban_03 <- metrics_03_recent |>
  filter(rucs_code == "Urban")

```

Note: Uses overall population weighting because defined at neighborhood level

Suppress weighted medians with 15 percent of counties low quality or missing -- as did in the overall feature

```{r}

metrics_03_recent_final <- calc_year_subgroup_table(metrics_df = metrics_03_recent,
                                                    northeast_df = northeast_03,
                                                    midwest_df = midwest_03,
                                                    south_df = south_03,
                                                    west_df = west_03,
                                                    rural_df = rural_03,
                                                    urban_df = urban_03) 
```

Add stratification suppression vars

```{r}

qual_northeast_03 <- stratification_suppression_subg(data = northeast_03,
                                                     qual_var = share_lq3_northeast)

qual_midwest_03 <- stratification_suppression_subg(data = midwest_03,
                                                   qual_var = share_lq3_midwest)

qual_south_03 <- stratification_suppression_subg(data = south_03,
                                                 qual_var = share_lq3_south)

qual_west_03 <- stratification_suppression_subg(data = west_03,
                                                qual_var = share_lq3_west)

qual_rural_03 <- stratification_suppression_subg(data = rural_03,
                                                 qual_var = share_lq3_rural)

qual_urban_03 <- stratification_suppression_subg(data = urban_03,
                                                 qual_var = share_lq3_urban)

```


```{r}

metrics_03_postsupp <- metrics_03_recent_final |> 
  full_join(qual_northeast_03, by = c("year", "subgroup", "name")) |>
  full_join(qual_midwest_03, by = c("year", "subgroup", "name")) |>
  full_join(qual_south_03, by = c("year", "subgroup", "name")) |>
  full_join(qual_west_03, by = c("year", "subgroup", "name")) |>
  full_join(qual_rural_03, by = c("year", "subgroup", "name")) |>
  full_join(qual_urban_03, by = c("year", "subgroup", "name")) 

```

Finalize suppression

```{r}
metrics_recent_suppressed_03 <- metrics_03_postsupp |> 
  mutate(weighted_median = ifelse(share_lq3 > 0.15, NA, wtd_median),
         high_pctle = ifelse(share_lq3 > 0.15, NA, wtd_highpct),
         low_pctle = ifelse(share_lq3 > 0.15, NA,wtd_lowpct),
         weighted_median_northeast = ifelse(share_lq3_northeast > 0.15, NA, weighted_median_northeast),
         weighted_median_midwest = ifelse(share_lq3_midwest > 0.15, NA, weighted_median_midwest),
         weighted_median_south = ifelse(share_lq3_south > 0.15, NA, weighted_median_south),
         weighted_median_west = ifelse(share_lq3_west > 0.15, NA, weighted_median_west),
         weighted_median_rural = ifelse(share_lq3_rural > 0.15, NA, weighted_median_rural),
         weighted_median_urban = ifelse(share_lq3_urban > 0.15, NA, weighted_median_urban)) |> 
  select(year, name, subgroup, weighted_median, low_pctle, high_pctle, weighted_median_northeast, weighted_median_midwest, weighted_median_south, weighted_median_west, weighted_median_rural, weighted_median_urban, share_lq3) 

```

Add in pillar names

```{r}
metrics_recent_suppressed_03 <- metrics_recent_suppressed_03 |>
  mutate(pillar = case_when(name == "index_air_hazard" ~ "Healthy Enviornment and Access to Good Healthcare",
                            name == "index_transit_trips" | name == "index_transportation_cost" ~ "Opportunity-Rich and Inclusive Neighborhoods",
                            name == "share_debt_coll" ~ "Rewarding Work")) |>
  select(pillar, name, subgroup, year, weighted_median, low_pctle, high_pctle, weighted_median_northeast, weighted_median_midwest, weighted_median_south, weighted_median_west, weighted_median_rural, weighted_median_urban, share_lq3)

```

Output files

```{r}

metrics_recent_suppressed_03 |> 
  kbl() |> 
  kable_styling(font_size = 10, fixed_thead = TRUE)

metrics_recent_suppressed_03 |>
  write_csv(here("10_construct-database", "county_medians_03_recent_suppressed.csv"))

```

Counting number of metrics with low quality and suppression

```{r}

metrics_recent_suppressed_03 %>%
  group_by(subgroup) %>%
  summarize(n_NA = sum(is.na(weighted_median)))

```

Final checks on income for White populations

```{r}

income <- metrics_01_recent %>%
  filter(year == "2021") %>%
  filter(subgroup == "White, Non-Hispanic") %>%
  select(pctl_income_20, pctl_income_20_quality, state, county, year)

income %>%
  summarize(n_NA = sum(is.na(pctl_income_20)),
            n_lowqual = sum(pctl_income_20_quality == "Weak", na.rm = TRUE))

```
