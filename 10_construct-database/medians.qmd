---
title: "Calculate Medians for Dashboard"
author: "Aaron R. Williams"
date: today
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
execute: 
  warning: false
editor_options: 
  chunk_output_type: console
---

#County level 

## Load Packages

```{r}
#| label: load-packages

options(scipen = 999)

library(tidyverse)
library(here)
library(tidycensus)

```

## Load Data

```{r}
#| label: load-data
metrics <- read_csv(here("data", "00_mobility-metrics_recent.csv")) |>
  select(-ends_with("_quality"), -ends_with("_lb"), -ends_with("_ub"))

```

We load county-level population estimates from the 2020 decennial census.

```{r}
population <- get_decennial(
  geography = "county", 
  variables = "P1_001N", 
  year = 2020
) |>
  mutate(
    state = str_sub(GEOID, start = 1, end = 2),
    county = str_sub(GEOID, start = 3, end = 5)
  ) |>
  select(state, county, population = value)

metrics <- left_join(metrics, population, by = c("state", "county"))

sum(is.na(metrics$population))

```

## Calculate Medians

We calculate weighted medians for each numeric variable. This means our estimates represent the county mobility metric for the average American. 

We exclude missing values and calculate the proportion of counties and proportion of population missing for each metric. 

```{r}
missing_share <- function(x, weight) {
  
  sum(as.numeric(is.na(x)) * weight) / sum(weight)
  
}

```

Calculate 

* The population-weighted median
* The proportion of counties that are missing
* The proportion of people that are missing

```{r}
weighted_median <- metrics |>
  select(where(is.numeric)) |>
  summarize(
    across(
      .cols = everything(), 
      .fns = ~Hmisc::wtd.quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    )
  ) |>
  pivot_longer(cols = everything(), values_to = "weighted_median")

missing_population <- metrics |>
  select(where(is.numeric)) |>
  summarize(
    across(
      .cols = everything(), 
      .fns = ~missing_share(.x, weight = population)
    )
  ) |>
  pivot_longer(cols = everything(), values_to = "missing_population")

missing_county <- metrics |>
  select(where(is.numeric)) |>
  summarize(
    across(
      .cols = everything(), 
      .fns = ~sum(is.na(.x)) / n()
    )
  ) |>
  pivot_longer(cols = everything(), values_to = "missing_county")

weighted_median |>
  full_join(missing_population, by = "name") |>
  full_join(missing_county, by = "name") |>
  filter(name != "population") |>
  print(n = Inf)

```


#Place level

## Load Data

```{r}
#| label: load-data
metrics <- read_csv(here("data", "05_mobility-metrics_place_recent.csv")) |>
  select(-ends_with("_quality"), -ends_with("_lb"), -ends_with("_ub"))

```

We load place-level population estimates from the 2020 decennial census.

```{r}
population <- get_decennial(
  geography = "place", 
  variables = "P1_001N", 
  year = 2020
) |>
  mutate(
    state = str_sub(GEOID, start = 1, end = 2),
    place = str_sub(GEOID, start = 3, end = 7)
  ) |>
  select(state, place, population = value)

metrics <- left_join(metrics, population, by = c("state", "place"))

sum(is.na(metrics$population))

```

## Calculate Medians

We calculate weighted medians for each numeric variable. This means our estimates represent the place mobility metric for the average American living in a large city. 

We exclude missing values and calculate the proportion of places and proportion of population missing for each metric. 

```{r}
missing_share <- function(x, weight) {
  
  sum(as.numeric(is.na(x)) * weight) / sum(weight)
  
}

```

Calculate 

* The population-weighted median
* The proportion of places that are missing
* The proportion of people that are missing

```{r}
weighted_median <- metrics |>
  select(where(is.numeric)) |>
  summarize(
    across(
      .cols = everything(), 
      .fns = ~Hmisc::wtd.quantile(., weights = population, probs = 0.5, na.rm = TRUE)
    )
  ) |>
  pivot_longer(cols = everything(), values_to = "weighted_median")

missing_population <- metrics |>
  select(where(is.numeric)) |>
  summarize(
    across(
      .cols = everything(), 
      .fns = ~missing_share(.x, weight = population)
    )
  ) |>
  pivot_longer(cols = everything(), values_to = "missing_population")

missing_place <- metrics |>
  select(where(is.numeric)) |>
  summarize(
    across(
      .cols = everything(), 
      .fns = ~sum(is.na(.x)) / n()
    )
  ) |>
  pivot_longer(cols = everything(), values_to = "missing_place")

weighted_median |>
  full_join(missing_population, by = "name") |>
  full_join(missing_place, by = "name") |>
  filter(name != "population") |>
  print(n = Inf)

```

There is a high share of debt in collections missing at place level in the final data set - this is not an issue with the join.

```{r}

metrics_check <- read_csv(here("data", "05_mobility-metrics_place_recent.csv")) |>
  select(-ends_with("_quality"), -ends_with("_lb"), -ends_with("_ub"))

sum(is.na(metrics_check$share_debt_col))
```


The distribution of population for places missing the debt in collections variable is skewed to the right where the missing distribution for juvenile arrests closely reflects the general population distribution. 
```{r}

#| echo: false
metrics %>% 
      mutate(pop_missing_debt = ifelse(is.na(share_debt_col), NA_integer_, population),
         pop_missing_juv = ifelse(is.na(rate_juv_arrest), NA_integer_, population)) %>% 
  select(place_name, population, pop_missing_debt) %>% 
  pivot_longer(-place_name, names_to = "pop_vars", values_to = "count") %>% 
  ggplot(aes(x = count, color = pop_vars, fill = pop_vars)) +
  geom_density(alpha = 0.15) +
  theme_minimal() +
  ggtitle("Comparison of distriubtions of population for all plcaes versus those missing share of debt in collections")

metrics %>% 
    mutate(pop_missing_debt = ifelse(is.na(share_debt_col), NA_integer_, population),
         pop_missing_juv = ifelse(is.na(rate_juv_arrest), NA_integer_, population)) %>% 
  select(place_name, population, pop_missing_juv) %>% 
  pivot_longer(-place_name, names_to = "pop_vars", values_to = "count") %>% 
  ggplot(aes(x = count, color = pop_vars, fill = pop_vars)) +
  geom_density(alpha = 0.15) +
  theme_minimal() +
  ggtitle("Comparison of distriubtions of population for all plcaes versus those missing rate_juv_arrest")

```


