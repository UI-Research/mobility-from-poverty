---
title: "Combine Mother's Education County Files"
author: "Aaron R. Williams & JP Walsh"
date: today
format:
  html:
    embed-resources: true
    toc: true
    toc_float: true
execute:
  message: false
  warning: false
editor_options: 
  chunk_output_type: console
---

## Setup

```{r quarto-setup, include = FALSE}
options(knitr.kable.NA = "")

```

```{r load-packages}
library(tidyverse)
library(tidylog)
library(here)
library(assertr)
library(gt)

```

This function is used to ensure that the lower bound of a 95% confidence interval is always below the estimate and the upper bound of the a 95% confidence interval is always above the estimate. 

```{r}
#' Test the bounds of a confidence interval relative to the estimate
#'
#' @param data The data frame of interest
#' @param estimate The unquoted name of the estimate variable
#' @param lb The unquoted name of the lower bound variable
#' @param ub The unquoted name of the upper bound variable
#'
test_bounds <- function(data, estimate, lb, ub) {
  
  subset <- bind_rows(
    data |>
      filter({{ ub }} < {{ lb }}),
    data |>
      filter({{ estimate }} > {{ ub }}),
    data |>
      filter({{ estimate  }} < {{ lb }}),
  )
  
  stopifnot(nrow(subset) == 0)
  
}


#' Helper function to silence output from testing code
#'
#' @param data A data frame
#'
quiet <- function(data) {
  
  quiet <- data
  
}

```

## Construct Database

### Mother's Education files

Create population file with a variable for mother's education. 

```{r}

read_csv(here("geographic-crosswalks", "data", "county-populations.csv")) %>% 
  mutate(all = "All", 
         mothers_ed_less = "Less than High School", 
         mothers_ed_hs = "GED/High School Degree",
         mothers_ed_some_coll = "Some College",
         mothers_ed_coll = "College Degree or Higher") %>% 
  pivot_longer(cols = c(all:mothers_ed_coll),
               names_to = "subgroup_type",
               values_to = "subgroup") %>% 
  mutate(subgroup_type = ifelse(subgroup_type != "all", "mothers-education", "all")) %>% 
  write_csv(here("data", "temp", "county-populations_mother's education.csv"))

```

Read file paths to all county files with mother's education subgroup information. 

```{r}

filepaths <- c(
  
# Mother's Education population file
here("data", "temp", "county-populations_mother's education.csv"),

# 04 health
here("04_health/final_data/neonatal_health_subgroup_2022.csv")

)

```

This code loads each file and then combines them using `left_join()`. The first file is a population file, so there should be 3,143 counties per year. 

```{r}

db_mothers_education <- filepaths |>
  map(
    .f = ~read_csv(.x) |> 
      select(-any_of(c("state_name", "county_name")))
  ) |>
  reduce(left_join, by = c("year", "state", "county", "subgroup", "subgroup_type"))

```

## Quality and Completeness

### Dimensions

At most there should be 15,720 in a year (5X3144) and at the least there should be 15,710 in a year (5X3142).

```{r}

db_mothers_education |> 
  count(year) |>
  assert(
    within_bounds(15710, 15720), 
    n
  )
```

### Data Quality Flags

This section summarizes data quality flags for variables and years.

```{r}
db_mothers_education |>
  select(ends_with("_quality")) |>
  pivot_longer(everything(), names_to = "variable", values_to = "quality") |>
  count(variable, quality) |>
  filter(!is.na(quality)) |>
  print(n = 100)

db_mothers_education  |>
  select(year, ends_with("_quality")) |>
  pivot_longer(-year, names_to = "variable", values_to = "quality") |>
  count(year, quality) |>
  print(n = 100)

```

### Full Database

Evaluate the quality variables. 

```{r}
db_mothers_education |>
  select(ends_with("_quality")) |>
  assert(in_set(1, 2, 3), everything())

```

### 04 Health

```{r}
db_mothers_education |>
  assert(
    within_bounds(0, 1),
    rate_low_birth_weight,
    rate_low_birth_weight_lb,
    rate_low_birth_weight_ub
  ) |>
  quiet()

test_bounds(
  data = db_mothers_education, 
  estimate = rate_low_birth_weight, 
  lb = rate_low_birth_weight_lb, 
  ub = rate_low_birth_weight_ub
)
```


## Write the File

```{r}

write_csv(db_mothers_education, here("data", "20_mobility-metrics_county_mothers_education_longitudinal.csv"))
```
