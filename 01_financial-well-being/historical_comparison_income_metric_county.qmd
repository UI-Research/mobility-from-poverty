---
title: "Historical Income Metric Comparison"
author: "JP Walsh"
date: today
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
    code-fold: true
execute: 
  warning: false
editor_options: 
  chunk_output_type: console
---

This program compares the results for income metric updated by JP Walsh in 2023/24 with the results from the metric calculations originally written by Kevin Werner in 2022 for the creation of the UMF income predictor. These processes should be the same and as a result the final metrics should be comparable.

## House keeping

```{r}
library(tidyverse)
library(tidylog)
library(here)
library(assertr)
library(gt)

options(scipen = 999)
```

## Longitudinal Data        

Ready income metric.
```{r}

counties_old <- read_csv(here("data", "01_mobility-metrics_race-ethnicity_longitudinal.csv")) %>% 
  select(year, state, county, pctl_income_20_old = pctl_income_20, pctl_income_50_old = pctl_income_50, pctl_income_80_old = pctl_income_80,
         subgroup) %>% 
  filter(year == 2021, subgroup == "All")

counties_new <- read_csv(here("01_financial-well-being", "data", "final", "metrics_income_county_race-ethnicity_longitudinal.csv")) %>% 
  select(year, state, county, pctl_income_20, pctl_income_50, pctl_income_80, subgroup) %>% 
  filter(year == 2021, subgroup == "All")
  
```

Summarize the statistics. Remove NAs from the old dataset where we have added suppression so that the comparison groups are equal.
```{r}
counties_suppressed_new <- counties_new %>% 
  mutate(fips = paste0(state, county)) %>% 
  filter(is.na(pctl_income_20)) %>% 
  select(fips) %>% 
  pull()

counties_old %>%
  mutate(fips = paste0(state, county)) %>% 
  filter(!fips %in% counties_suppressed_new) %>% 
  summary()

counties_new %>%
  summary()
```

Join metrics and compare the results. There are minuscule differences between select counties likely caused by rounding.
```{r}

counties_new %>% 
  left_join(counties_old, by = c("year", "state", "county")) %>% 
  filter(!is.na(pctl_income_20)) %>% 
  mutate(diff_20 = round((pctl_income_20 - pctl_income_20_old), digits = 3),
         diff_50 = round((pctl_income_50 - pctl_income_50_old), digits = 3),
         diff_80 = round((pctl_income_80 - pctl_income_80_old), digits  = 3)
         )%>% 
  reactable::reactable()

```





